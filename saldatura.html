<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>WPS Generator V16.0 (Final Fix)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #ff9f43; --secondary: #00e5ff; --success: #2ecc71; --danger: #e74c3c; --bg-dark: #050505; --bg-panel: #1e1e1e; --text-main: #e0e0e0; --border: 1px solid rgba(255, 255, 255, 0.1); }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; padding: 0; }
        header { background: #000; border-bottom: 2px solid var(--primary); padding: 15px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 20px; font-weight: 900; text-transform: uppercase; color: #fff; }
        .logo span { color: var(--primary); }
        .container { padding: 20px; max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; align-items: start; }
        @media(max-width: 1100px) { .container { grid-template-columns: 1fr; } }
        .panel { background: var(--bg-panel); border: var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; font-size: 12px; color: #888; margin-bottom: 5px; text-transform: uppercase; }
        input[type="number"], select { width: 100%; box-sizing: border-box; background: #000; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 6px; font-size: 15px; font-weight: bold; transition: 0.3s; }
        input[type="number"]:focus { border-color: var(--primary); outline: none; }
        .wps-card { border: 2px solid var(--success); background: rgba(46, 204, 113, 0.05); }
        .wps-value { font-size: 24px; color: #fff; font-weight: 900; }
        .dual-input { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .technical-drawing { width: 100%; height: auto; max-width: 300px; display: block; margin: 0 auto; background: #222; border-radius: 8px; border: 1px solid #444; }
        .tech-dim { stroke: var(--primary); stroke-width: 2; }
        .tech-text { fill: var(--primary); font-size: 14px; font-family: monospace; font-weight: bold; }
        .multipass-box { padding: 10px; border-radius: 8px; border: 1px dashed #444; opacity: 0.5; transition: 0.3s; }
        .multipass-active { border: 2px solid #e74c3c !important; background: rgba(231, 76, 60, 0.1) !important; opacity: 1 !important; }
        .cost-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 10px; }
        .cost-table th { text-align: left; border-bottom: 1px solid #444; padding: 5px; color: #888; font-size: 11px; text-transform: uppercase; }
        .cost-table td { padding: 8px 5px; border-bottom: 1px solid #222; }
        .res-cost { color: #2ecc71; font-size: 20px; font-weight: bold; }
        .btn-upload { background: #2ecc71; color: #000; font-weight: bold; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; }
    </style>
</head>
<body>

    <header>
        <div class="logo">WPS<span>GENERATOR</span> 16.0</div>
        <div style="display:flex; gap:10px;">
            <input type="file" id="inp-listino" accept=".xlsx" style="display:none;" onchange="ListinoManager.load(this)">
            <button class="btn-upload" onclick="document.getElementById('inp-listino').click()">üìÇ Importa Listino Excel</button>
            <button style="background:var(--primary); border:none; padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:bold;" onclick="window.history.back()">Indietro</button>
        </div>
    </header>

    <div class="container">
        <div>
            <div class="panel" style="text-align: center;">
                <h3>üìê Schema Saldatura</h3>
                <svg viewBox="0 0 250 200" class="technical-drawing" id="main-svg">
                    <defs><marker id="arrow" markerWidth="6" markerHeight="6" refX="0" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#ff9f43" /></marker></defs>
                    <rect x="20" y="20" width="40" height="130" fill="#333" stroke="#666" />
                    <rect x="20" y="150" width="180" height="30" fill="#333" stroke="#666" />
                    <g id="weld-group"></g>
                    <line x1="15" y1="100" x2="15" y2="150" class="tech-dim" id="line-zv" marker-start="url(#arrow)" marker-end="url(#arrow)"/>
                    <text x="5" y="125" class="tech-text" style="writing-mode: tb;">z</text>
                    <line x1="60" y1="165" x2="110" y2="165" class="tech-dim" id="line-zh" marker-start="url(#arrow)" marker-end="url(#arrow)"/>
                    <text x="85" y="180" class="tech-text">z</text>
                </svg>
            </div>
            <div class="panel">
                <h3>1. Configurazione</h3>
                <div class="control-group">
                    <label>Filo</label>
                    <select id="inp-mat" onchange="ListinoManager.selectWire()">
                        <option value="fe_1.2_std">Standard ISO - Fe 1.2mm</option>
                    </select>
                </div>
                <div class="dual-input">
                    <div class="control-group">
                        <label>Lato (z) mm</label>
                        <input type="number" id="inp-z" value="6" step="0.5" oninput="WPS.findWPS()">
                    </div>
                    <div class="control-group">
                        <label>Gola (a) mm</label>
                        <input type="number" id="inp-a" value="4.2" step="0.1" oninput="WPS.syncAtoZ()">
                    </div>
                </div>
                <div class="control-group">
                    <label>Lunghezza Saldatura (mm)</label>
                    <input type="number" id="inp-len" value="1000" oninput="WPS.findWPS()">
                </div>
            </div>
        </div>

        <div>
            <div class="panel wps-card">
                <h3>2. Parametri Macchina</h3>
                <div id="arc-mode-badge" style="padding:5px; text-align:center; border-radius:4px; font-weight:bold; margin-bottom:10px; background:#e67e22;">GLOB ARC</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div><label>m/min</label><div class="wps-value" id="out-wfs">8.5</div></div>
                    <div><label>Ampere</label><div class="wps-value" id="out-amp">230</div></div>
                    <div><label>Volt</label><div class="wps-value" id="out-volt">23.5</div></div>
                    <div><label>Speed (cm/min)</label><input type="number" id="out-speed" style="background:transparent; border:1px solid #2ecc71; color:#2ecc71; font-size:20px;" readonly></div>
                </div>
            </div>
            <div class="panel">
                <h3>Strategia Passate</h3>
                <div id="multipass-box" class="multipass-box">
                    <label>Z Singola Passata (mm)</label>
                    <input type="number" id="inp-single-z" value="6" oninput="WPS.findWPS()">
                    <label style="margin-top:10px;">Passate Totali</label>
                    <input type="number" id="inp-passes" value="1" readonly style="font-size:24px; text-align:center;">
                </div>
            </div>
        </div>

        <div>
            <div class="panel" style="border-color: #2ecc71;">
                <h3>üí∞ Preventivo Commessa</h3>
                <table class="cost-table">
                    <thead><tr><th>Risorsa</th><th style="text-align:right;">Q.t√† Tot</th><th style="text-align:right;">‚Ç¨ Tot</th></tr></thead>
                    <tbody id="preventivo-body">
                        <tr><td>Filo</td><td id="out-qty-wire" style="text-align:right;">0.00 kg</td><td id="out-cost-wire" style="text-align:right;">‚Ç¨ 0.00</td></tr>
                        <tr><td>Gas</td><td id="out-qty-gas" style="text-align:right;">0 L</td><td id="out-cost-gas" style="text-align:right;">‚Ç¨ 0.00</td></tr>
                        <tr><td>Energia</td><td id="out-qty-energy" style="text-align:right;">0.0 kWh</td><td id="out-cost-energy" style="text-align:right;">‚Ç¨ 0.00</td></tr>
                    </tbody>
                </table>
                <div style="border-top:1px solid #444; padding-top:10px; text-align:right;">
                    <div style="font-size:12px; color:#888;">TOTALE COMMESSA</div>
                    <div class="res-cost" id="out-total-final">‚Ç¨ 0.00</div>
                </div>
            </div>
            <div class="panel">
                <div class="control-group">
                    <label>Costo Filo (‚Ç¨/kg)</label>
                    <input type="number" id="cost-wire" value="2.50" oninput="Calculator.update()">
                </div>
                <div class="control-group">
                    <label>Costo Gas (‚Ç¨/L)</label>
                    <input type="number" id="cost-gas" value="0.08" oninput="Calculator.update()">
                </div>
            </div>
        </div>
    </div>

    <script>
        const ISO_PHYSICS = { "1.2": [{ z_min: 0, z_max: 3.5, wfs: 4.5, amp: 130, volt: 17.5, mode: "Short" }, { z_min: 3.6, z_max: 4.5, wfs: 5.5, amp: 160, volt: 18.5, mode: "Short" }, { z_min: 4.6, z_max: 5.5, wfs: 7.0, amp: 200, volt: 21.0, mode: "Glob" }, { z_min: 5.6, z_max: 6.5, wfs: 8.5, amp: 230, volt: 23.5, mode: "Glob" }, { z_min: 6.6, z_max: 7.5, wfs: 10.0, amp: 260, volt: 26.0, mode: "Spray" }, { z_min: 7.6, z_max: 99, wfs: 11.5, amp: 290, volt: 28.5, mode: "Spray" }] };
        let WIRES_DB = []; let CURRENT_WIRE = { diameter: "1.2", efficiency: 0.96 };

        const ListinoManager = {
            load: function(input) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                        WIRES_DB = XLSX.utils.sheet_to_json(workbook.Sheets["FILI"]);
                        const sel = document.getElementById('inp-mat'); sel.innerHTML = "";
                        WIRES_DB.forEach((w, i) => sel.add(new Option(`${w.Marca} ${w["Nome Prodotto"]} (√ò${w["Diametro (mm)"]})`, i)));
                        this.selectWire();
                    } catch(err) { alert("‚ùå Errore caricamento file."); }
                }; reader.readAsArrayBuffer(input.files[0]);
            },
            selectWire: function() {
                const w = WIRES_DB[document.getElementById('inp-mat').value];
                if(w) { 
                    CURRENT_WIRE = { diameter: String(w["Diametro (mm)"]), efficiency: parseFloat(w["Efficienza (0-1)"]) || 0.96 };
                    document.getElementById('cost-wire').value = w["Prezzo (‚Ç¨/kg)"] || 2.5;
                }
                WPS.findWPS();
            }
        };

        const WPS = {
            init: function() { this.findWPS(); },
            syncAtoZ: function() {
                let a = parseFloat(document.getElementById('inp-a').value) || 0;
                document.getElementById('inp-z').value = (a * 1.414).toFixed(1);
                this.findWPS();
            },
            findWPS: function() {
                let z = parseFloat(document.getElementById('inp-z').value) || 0;
                document.getElementById('inp-a').value = (z * 0.707).toFixed(1); // Aggiorna 'a' da 'z'
                
                let curve = ISO_PHYSICS[CURRENT_WIRE.diameter] || ISO_PHYSICS["1.2"];
                let s = curve.find(w => z >= w.z_min && z <= w.z_max) || curve[curve.length-1];
                
                document.getElementById('out-wfs').innerText = s.wfs.toFixed(1);
                document.getElementById('out-amp').innerText = s.amp;
                document.getElementById('out-volt').innerText = s.volt;
                
                let badge = document.getElementById('arc-mode-badge');
                badge.innerText = s.mode.toUpperCase() + " ARC";
                badge.style.background = s.mode === "Short" ? "#f1c40f" : s.mode === "Spray" ? "#9b59b6" : "#e67e22";

                let singleZ = parseFloat(document.getElementById('inp-single-z').value) || 6;
                let passes = z > singleZ ? Math.ceil((z*z)/(singleZ*singleZ)) : 1;
                document.getElementById('inp-passes').value = passes;
                document.getElementById('multipass-box').className = passes > 1 ? "multipass-box multipass-active" : "multipass-box";

                let areaPass = (((z*z)/2)*1.1) / passes;
                let wireVolMin = (Math.PI * Math.pow(parseFloat(CURRENT_WIRE.diameter)/2, 2)) * (s.wfs * 1000);
                let speedCmMin = (wireVolMin / areaPass) / 10;
                document.getElementById('out-speed').value = speedCmMin.toFixed(0);

                this.updateSVG(z, passes);
                Calculator.update(s.wfs, s.amp, s.volt, speedCmMin, passes);
            },
            updateSVG: function(z, passes) {
                const group = document.getElementById('weld-group'); group.innerHTML = "";
                const xS = 60, yS = 150; let scale = z > 15 ? 100/z : 6;
                let z_px = z * scale;
                if (passes === 1) {
                    let p = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    p.setAttribute("d", `M${xS},${yS} L${xS},${yS-z_px} L${xS+z_px},${yS} Z`);
                    p.setAttribute("class", "bead-circle"); p.style.fill="rgba(255,159,67,0.4)"; group.appendChild(p);
                } else {
                    const colors = ['#ff3b30', '#ff9500', '#ffcc00', '#4cd964', '#007aff'];
                    let cp = 0, r = (z_px / Math.sqrt(passes)) * 0.45;
                    for(let l=1; cp < passes; l++) {
                        for(let k=0; k<l && cp < passes; k++) {
                            let cx = xS + (k*2*r) + r + k*2, cy = yS - ((l-1-k)*2*r) - r - (l-1-k)*2;
                            let c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                            c.setAttribute("cx", cx); c.setAttribute("cy", cy); c.setAttribute("r", r);
                            c.style.fill = colors[(l-1)%5]; c.setAttribute("class", "bead-circle"); group.appendChild(c);
                            let t = document.createElementNS("http://www.w3.org/2000/svg", "text");
                            t.setAttribute("x", cx); t.setAttribute("y", cy); t.setAttribute("class", "bead-text");
                            t.style.fontSize = r + "px"; t.textContent = cp+1; group.appendChild(t); cp++;
                        }
                    }
                }
                document.getElementById('line-zv').setAttribute('y1', yS-z_px);
                document.getElementById('line-zh').setAttribute('x2', xS+z_px);
            }
        };

        const Calculator = {
            update: function(wfs, amp, volt, speed, passes) {
                if(!wfs) {
                    wfs = parseFloat(document.getElementById('out-wfs').innerText) || 8.5;
                    amp = parseFloat(document.getElementById('out-amp').innerText) || 230;
                    volt = parseFloat(document.getElementById('out-volt').innerText) || 23.5;
                    speed = parseFloat(document.getElementById('out-speed').value) || 35;
                    passes = parseInt(document.getElementById('inp-passes').value) || 1;
                }
                let lenM = (parseFloat(document.getElementById('inp-len').value) || 0) / 1000;
                let cW = parseFloat(document.getElementById('cost-wire').value) || 0;
                let cG = parseFloat(document.getElementById('cost-gas').value) || 0;
                
                let dep = Math.PI * Math.pow(parseFloat(CURRENT_WIRE.diameter)/2, 2) * (wfs * 60000) * 0.00000785 * CURRENT_WIRE.efficiency;
                let timeH = (1 / (speed * 0.6)) * passes * lenM;
                
                let qW = (dep * timeH / CURRENT_WIRE.efficiency);
                let qG = (15 * (timeH * 60));
                let qE = ((amp * volt / 1000) * timeH);

                document.getElementById('out-qty-wire').innerText = qW.toFixed(2) + " kg";
                document.getElementById('out-qty-gas').innerText = qG.toFixed(0) + " L";
                document.getElementById('out-qty-energy').innerText = qE.toFixed(1) + " kWh";

                let costW = qW * cW, costG = qG * cG, costE = qE * 0.3;
                document.getElementById('out-cost-wire').innerText = "‚Ç¨ " + costW.toFixed(2);
                document.getElementById('out-cost-gas').innerText = "‚Ç¨ " + costG.toFixed(2);
                document.getElementById('out-cost-energy').innerText = "‚Ç¨ " + costE.toFixed(2);
                document.getElementById('out-total-final').innerText = "‚Ç¨ " + (costW + costG + costE).toFixed(2);
            }
        };
        window.onload = () => WPS.init();
    </script>
</body>
</html>