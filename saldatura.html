<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>WPS Global Standard V17.0</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #ff9f43; --secondary: #00e5ff; --success: #2ecc71; --danger: #e74c3c; --bg-dark: #050505; --bg-panel: #1e1e1e; --text-main: #e0e0e0; --border: 1px solid rgba(255, 255, 255, 0.1); }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; padding: 0; }
        
        header { background: #000; border-bottom: 2px solid var(--primary); padding: 15px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 20px; font-weight: 900; text-transform: uppercase; color: #fff; }
        .logo span { color: var(--primary); }

        .container { padding: 20px; max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; align-items: start; }
        @media(max-width: 1100px) { .container { grid-template-columns: 1fr; } }
        
        .panel { background: var(--bg-panel); border: var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; font-size: 12px; color: #888; margin-bottom: 5px; text-transform: uppercase; }
        input[type="number"], select { width: 100%; box-sizing: border-box; background: #000; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 6px; font-size: 15px; font-weight: bold; }
        
        .wps-card { border: 2px solid var(--success); background: rgba(46, 204, 113, 0.05); }
        .wps-value { font-size: 24px; color: #fff; font-weight: 900; }
        .dual-input { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .technical-drawing { width: 100%; height: auto; max-width: 300px; display: block; margin: 0 auto; background: #222; border-radius: 8px; border: 1px solid #444; }
        .tech-dim { stroke: var(--primary); stroke-width: 2; }
        .tech-text { fill: var(--primary); font-size: 14px; font-family: monospace; font-weight: bold; }
        
        .bead-circle { stroke: #fff; stroke-width: 1.5px; }
        .bead-text { fill: #000; font-family: sans-serif; font-weight: 900; text-anchor: middle; dominant-baseline: central; pointer-events: none; }

        .multipass-box { padding: 10px; border-radius: 8px; border: 1px dashed #444; opacity: 0.5; transition: 0.3s; }
        .multipass-active { border: 2px solid #e74c3c !important; background: rgba(231, 76, 60, 0.1) !important; opacity: 1 !important; }

        .cost-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 10px; }
        .cost-table th { text-align: left; border-bottom: 1px solid #444; padding: 5px; color: #888; font-size: 11px; }
        .cost-table td { padding: 8px 5px; border-bottom: 1px solid #222; }
        .res-cost { color: #2ecc71; font-size: 20px; font-weight: bold; }
        
        .btn-nav { background: #333; color: #fff; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .btn-nav:hover { background: #444; }

        /* MODALE MANUALE TECNICO */
        #modal-manual {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1000; overflow-y: auto; padding: 40px; box-sizing: border-box;
        }
        .manual-content { 
            max-width: 900px; margin: 0 auto; background: white; color: #333; padding: 60px; 
            border-radius: 5px; line-height: 1.6; position: relative;
        }
        .manual-content h1, .manual-content h2 { color: #000; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .formula { background: #f4f4f4; padding: 15px; border-left: 5px solid var(--primary); font-family: 'Courier New', Courier, monospace; margin: 15px 0; font-weight: bold; }
        .norma-box { background: #e8f4fd; border: 1px solid #b3d7f2; padding: 10px; margin: 10px 0; font-size: 14px; font-style: italic; }

        @media print {
            body * { visibility: hidden; }
            #modal-manual, #modal-manual * { visibility: visible; }
            #modal-manual { position: absolute; left: 0; top: 0; background: white; padding: 0; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">WPS<span>GLOBAL</span> 17.0</div>
        <div style="display:flex; gap:10px;">
            <button class="btn-nav" style="background:var(--secondary); color:#000;" onclick="toggleManual()">‚ÑπÔ∏è Informazioni Tecniche</button>
            <button class="btn-nav" style="background:var(--success); color:#000;" onclick="document.getElementById('inp-listino').click()">üìÇ Importa Listino</button>
            <input type="file" id="inp-listino" accept=".xlsx" style="display:none;" onchange="ListinoManager.load(this)">
            <button class="btn-nav" onclick="window.history.back()">Indietro</button>
        </div>
    </header>

    <div id="modal-manual">
        <div class="manual-content">
            <div class="no-print" style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px;">
                <button onclick="window.print()" style="padding: 10px 20px; cursor: pointer; background: #2ecc71; color: white; border: none; border-radius: 5px;">Scarica PDF / Stampa</button>
                <button onclick="toggleManual()" style="padding: 10px 20px; cursor: pointer; background: #e74c3c; color: white; border: none; border-radius: 5px;">Chiudi</button>
            </div>
            
            <h1>Protocollo Operativo di Ingegneria della Saldatura</h1>
            <p><b>Rif. Documento:</b> SOP-WELD-001 | <b>Revisione:</b> 17.0 | <b>Processo:</b> GMAW (MAG)</p>
            
            <div class="norma-box">
                Il presente calcolatore √® conforme alle linee guida delle norme internazionali:<br>
                - <b>EN ISO 15612:</b> Specifica e qualificazione delle procedure di saldatura.<br>
                - <b>EN 1011-1/2:</b> Raccomandazioni per la saldatura di materiali metallici.<br>
                - <b>ISO 14341:</b> Classificazione dei fili elettrodi per acciaio al carbonio.
            </div>

            <h2>1. Logica Matematica della Sezione del Giunto</h2>
            <p>Per giunti ad angolo, l'area teorica della sezione √® calcolata partendo dal lato (z) o dalla gola (a). Viene applicato un coefficiente di convessit√† reale ($C = 1.1$) per compensare il sovrametallo operativo richiesto dagli standard industriali.</p>
            <div class="formula">Area (A) = (z¬≤ / 2) * 1.1</div>
            <p>Relazione geometrica fondamentale:</p>
            <div class="formula">a = z * 0.707 | z = a * 1.414</div>

            <h2>2. Modello di Deposito e Consumo Materiali</h2>
            <p>Il calcolo della massa depositata si basa sulla densit√† volumetrica dell'acciaio al carbonio ($\rho = 7.85 \, g/cm^3$) e sulla velocit√† di alimentazione del filo (WFS).</p>
            <div class="formula">Deposito (kg/h) = [Area Filo (mm¬≤) * WFS (m/min) * 60 * 0.00000785] * Œ∑</div>
            <p>L'efficienza di deposito ($\eta$) √® impostata di default a 0.96 (96%) per fili pieni, considerando uno sfrido del 4% per spruzzi e vaporizzazione arco.</p>

            <h2>3. Calcolo dell'Apporto Termico (Heat Input)</h2>
            <p>Il calcolo dell'energia termica introdotta √® cruciale per la prevenzione di cricche a freddo e la gestione della ZTA (Zona Termicamente Alterata) secondo ISO 15614-1.</p>
            <div class="formula">Q (kJ/mm) = k * [ (Volt * Ampere * 60) / (Velocit√† cm/min * 10 * 1000) ]</div>
            <p>Dove <b>k</b> (Efficienza Termica) √® impostato a <b>0.8</b> per il processo MAG, come da norma EN 1011-1.</p>

            <h2>4. Strategia Multipass</h2>
            <p>Il sistema attiva automaticamente la scomposizione dei cordoni se la Z richiesta supera il limite dimensionale per singola passata ($Z_{limit} = 7.5 \, mm$). La suddivisione segue una progressione a piramide diagonale per garantire la corretta fusione dei lembi.</p>
            
            <h2>5. Consumo Gas ed Energia</h2>
            <p>Il consumo di gas √® calcolato sulla base del tempo di arco acceso ($t_{arc}$):</p>
            <div class="formula">Gas Totale (L) = Portata (L/min) * t_{arc}</div>
            <p>L'energia elettrica considera la potenza nominale assorbita durante la fase di scarica dell'arco.</p>
            
            <hr>
            <p style="text-align: center; font-size: 12px; color: #666;">Documentazione generata automaticamente dal sistema WPS Generator Enterprise.</p>
        </div>
    </div>

    <div class="container">
        <div>
            <div class="panel" style="text-align: center;">
                <h3>üìê Visualizzazione</h3>
                <svg viewBox="0 0 250 200" class="technical-drawing" id="main-svg">
                    <defs><marker id="arrow" markerWidth="6" markerHeight="6" refX="0" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#ff9f43" /></marker></defs>
                    <rect x="20" y="20" width="40" height="130" fill="#333" stroke="#666" />
                    <rect x="20" y="150" width="180" height="30" fill="#333" stroke="#666" />
                    <g id="weld-group"></g>
                    <line x1="15" y1="100" x2="15" y2="150" class="tech-dim" id="line-zv" marker-start="url(#arrow)" marker-end="url(#arrow)"/>
                    <text x="5" y="125" class="tech-text" style="writing-mode: tb;">z</text>
                    <line x1="60" y1="165" x2="110" y2="165" class="tech-dim" id="line-zh" marker-start="url(#arrow)" marker-end="url(#arrow)"/>
                    <text x="85" y="180" class="tech-text">z</text>
                </svg>
            </div>
            <div class="panel">
                <h3>1. Configurazione</h3>
                <div class="control-group">
                    <label>Filo</label>
                    <select id="inp-mat" onchange="ListinoManager.selectWire()">
                        <option value="fe_1.2_std">Standard ISO - Fe 1.2mm</option>
                    </select>
                </div>
                <div class="dual-input">
                    <div class="control-group"><label>Lato (z) mm</label><input type="number" id="inp-z" value="6" step="0.5" oninput="WPS.findWPS()"></div>
                    <div class="control-group"><label>Gola (a) mm</label><input type="number" id="inp-a" value="4.2" step="0.1" oninput="WPS.syncAtoZ()"></div>
                </div>
                <div class="control-group"><label>Lunghezza Saldatura (mm)</label><input type="number" id="inp-len" value="1000" oninput="WPS.findWPS()"></div>
            </div>
        </div>

        <div>
            <div class="panel wps-card">
                <h3>2. Parametri Processo</h3>
                <div id="arc-mode-badge" style="padding:5px; text-align:center; border-radius:4px; font-weight:bold; margin-bottom:10px; background:#e67e22;">GLOB ARC</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div><label>m/min</label><div class="wps-value" id="out-wfs">8.5</div></div>
                    <div><label>Ampere</label><div class="wps-value" id="out-amp">230</div></div>
                    <div><label>Volt</label><div class="wps-value" id="out-volt">23.5</div></div>
                    <div><label>Speed (cm/min)</label><input type="number" id="out-speed" style="background:transparent; border:1px solid #2ecc71; color:#2ecc71; font-size:20px;" readonly></div>
                </div>
            </div>
            <div class="panel">
                <h3>Strategia Passate</h3>
                <div id="multipass-box" class="multipass-box">
                    <label>Z Singola Passata (mm)</label>
                    <input type="number" id="inp-single-z" value="6" oninput="WPS.findWPS()">
                    <label style="margin-top:10px;">Passate Totali</label>
                    <input type="number" id="inp-passes" value="1" readonly style="font-size:24px; text-align:center;">
                </div>
            </div>
        </div>

        <div>
            <div class="panel" style="border-color: #2ecc71;">
                <h3>üí∞ Preventivo Commessa</h3>
                <table class="cost-table">
                    <thead><tr><th>Risorsa</th><th style="text-align:right;">Q.t√† Tot</th><th style="text-align:right;">‚Ç¨ Tot</th></tr></thead>
                    <tbody id="preventivo-body">
                        <tr><td>Filo</td><td id="out-qty-wire" style="text-align:right;">0.00 kg</td><td id="out-cost-wire" style="text-align:right;">‚Ç¨ 0.00</td></tr>
                        <tr><td>Gas</td><td id="out-qty-gas" style="text-align:right;">0 L</td><td id="out-cost-gas" style="text-align:right;">‚Ç¨ 0.00</td></tr>
                        <tr><td>Energia</td><td id="out-qty-energy" style="text-align:right;">0.0 kWh</td><td id="out-cost-energy" style="text-align:right;">‚Ç¨ 0.00</td></tr>
                    </tbody>
                </table>
                <div style="border-top:1px solid #444; padding-top:10px; text-align:right;">
                    <div style="font-size:12px; color:#888;">TOTALE COMMESSA</div>
                    <div class="res-cost" id="out-total-final">‚Ç¨ 0.00</div>
                </div>
            </div>
            <div class="panel">
                <h3>üìä Dati Fisici</h3>
                <div style="font-size:13px; color:#aaa;">Heat Input: <b id="res-heat" style="color:#fff;">0.00 kJ/mm</b></div>
                <div style="font-size:13px; color:#aaa;">Deposito: <b id="res-dep" style="color:#fff;">0.00 kg/h</b></div>
            </div>
        </div>
    </div>

    <script>
        // MOTORE FISICO E CALCOLO
        const ISO_PHYSICS = { "1.2": [{ z_min: 0, z_max: 3.5, wfs: 4.5, amp: 130, volt: 17.5, mode: "Short" }, { z_min: 3.6, z_max: 4.5, wfs: 5.5, amp: 160, volt: 18.5, mode: "Short" }, { z_min: 4.6, z_max: 5.5, wfs: 7.0, amp: 200, volt: 21.0, mode: "Glob" }, { z_min: 5.6, z_max: 6.5, wfs: 8.5, amp: 230, volt: 23.5, mode: "Glob" }, { z_min: 6.6, z_max: 7.5, wfs: 10.0, amp: 260, volt: 26.0, mode: "Spray" }, { z_min: 7.6, z_max: 99, wfs: 11.5, amp: 290, volt: 28.5, mode: "Spray" }] };
        let WIRES_DB = []; let CURRENT_WIRE = { diameter: "1.2", efficiency: 0.96 };

        const ListinoManager = {
            load: function(input) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                    WIRES_DB = XLSX.utils.sheet_to_json(workbook.Sheets["FILI"]);
                    const sel = document.getElementById('inp-mat'); sel.innerHTML = "";
                    WIRES_DB.forEach((w, i) => sel.add(new Option(`${w.Marca} ${w["Nome Prodotto"]} (√ò${w["Diametro (mm)"]})`, i)));
                    this.selectWire();
                }; reader.readAsArrayBuffer(input.files[0]);
            },
            selectWire: function() {
                const w = WIRES_DB[document.getElementById('inp-mat').value];
                if(w) { CURRENT_WIRE = { diameter: String(w["Diametro (mm)"]), efficiency: parseFloat(w["Efficienza (0-1)"]) || 0.96 }; }
                WPS.findWPS();
            }
        };

        const WPS = {
            syncAtoZ: function() { document.getElementById('inp-z').value = (parseFloat(document.getElementById('inp-a').value) * 1.414).toFixed(1); this.findWPS(); },
            findWPS: function() {
                let z = parseFloat(document.getElementById('inp-z').value) || 0;
                document.getElementById('inp-a').value = (z * 0.707).toFixed(1);
                let curve = ISO_PHYSICS[CURRENT_WIRE.diameter] || ISO_PHYSICS["1.2"];
                let s = curve.find(w => z >= w.z_min && z <= w.z_max) || curve[curve.length-1];
                document.getElementById('out-wfs').innerText = s.wfs.toFixed(1);
                document.getElementById('out-amp').innerText = s.amp;
                document.getElementById('out-volt').innerText = s.volt;
                let singleZ = parseFloat(document.getElementById('inp-single-z').value) || 6;
                let passes = z > singleZ ? Math.ceil((z*z)/(singleZ*singleZ)) : 1;
                document.getElementById('inp-passes').value = passes;
                document.getElementById('multipass-box').className = passes > 1 ? "multipass-box multipass-active" : "multipass-box";
                let areaPass = (((z*z)/2)*1.1) / passes;
                let wireVolMin = (Math.PI * Math.pow(parseFloat(CURRENT_WIRE.diameter)/2, 2)) * (s.wfs * 1000);
                let speedCmMin = (wireVolMin / areaPass) / 10;
                document.getElementById('out-speed').value = speedCmMin.toFixed(0);
                this.updateSVG(z, passes);
                Calculator.update(s.wfs, s.amp, s.volt, speedCmMin, passes);
            },
            updateSVG: function(z, passes) {
                const group = document.getElementById('weld-group'); group.innerHTML = "";
                const xS = 60, yS = 150; let scale = z > 15 ? 100/z : 6; let z_px = z * scale;
                if (passes === 1) {
                    let p = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    p.setAttribute("d", `M${xS},${yS} L${xS},${yS-z_px} L${xS+z_px},${yS} Z`);
                    p.setAttribute("fill", "rgba(255,159,67,0.4)"); group.appendChild(p);
                } else {
                    const colors = ['#ff3b30', '#ff9500', '#ffcc00', '#4cd964', '#007aff'];
                    let cp = 0, r = (z_px / Math.sqrt(passes)) * 0.45;
                    for(let l=1; cp < passes; l++) {
                        for(let k=0; k<l && cp < passes; k++) {
                            let cx = xS + (k*2*r) + r + k*2, cy = yS - ((l-1-k)*2*r) - r - (l-1-k)*2;
                            let c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                            c.setAttribute("cx", cx); c.setAttribute("cy", cy); c.setAttribute("r", r);
                            c.setAttribute("fill", colors[(l-1)%5]); group.appendChild(c);
                            let t = document.createElementNS("http://www.w3.org/2000/svg", "text");
                            t.setAttribute("x", cx); t.setAttribute("y", cy); t.setAttribute("class", "bead-text");
                            t.style.fontSize = r + "px"; t.textContent = cp+1; group.appendChild(t); cp++;
                        }
                    }
                }
                document.getElementById('line-zv').setAttribute('y1', yS-z_px);
                document.getElementById('line-zh').setAttribute('x2', xS+z_px);
            }
        };

        const Calculator = {
            update: function(wfs, amp, volt, speed, passes) {
                let lenM = (parseFloat(document.getElementById('inp-len').value) || 0) / 1000;
                let dep = Math.PI * Math.pow(parseFloat(CURRENT_WIRE.diameter)/2, 2) * (wfs * 60000) * 0.00000785 * CURRENT_WIRE.efficiency;
                let timeH = (1 / (speed * 0.6)) * passes * lenM;
                let qW = (dep * timeH / CURRENT_WIRE.efficiency);
                document.getElementById('out-qty-wire').innerText = qW.toFixed(2) + " kg";
                document.getElementById('out-qty-gas').innerText = (15 * (timeH * 60)).toFixed(0) + " L";
                document.getElementById('out-qty-energy').innerText = ((amp * volt / 1000) * timeH).toFixed(1) + " kWh";
                document.getElementById('out-cost-wire').innerText = "‚Ç¨ " + (qW * 2.5).toFixed(2);
                document.getElementById('out-cost-gas').innerText = "‚Ç¨ " + (15 * timeH * 60 * 0.08).toFixed(2);
                document.getElementById('out-cost-energy').innerText = "‚Ç¨ " + (amp * volt / 1000 * timeH * 0.3).toFixed(2);
                document.getElementById('out-total-final').innerText = "‚Ç¨ " + (qW * 2.5 + 15 * timeH * 60 * 0.08 + amp * volt / 1000 * timeH * 0.3).toFixed(2);
                document.getElementById('res-heat').innerText = ((volt * amp * 0.048) / speed).toFixed(2) + " kJ/mm";
                document.getElementById('res-dep').innerText = dep.toFixed(2) + " kg/h";
            }
        };

        function toggleManual() {
            const m = document.getElementById('modal-manual');
            m.style.display = m.style.display === 'block' ? 'none' : 'block';
        }

        window.onload = () => WPS.findWPS();
    </script>
</body>
</html>