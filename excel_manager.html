<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Excel Manager - V6.6 (Nav Fix)</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* STILI BASE */
        body { font-family: 'Segoe UI', sans-serif; background: #111; color: white; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }

        /* TOP BAR */
        .top-bar { background: #1a1a1a; border-bottom: 1px solid #333; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; height: 60px; flex-shrink: 0; }
        .brand-area { display: flex; align-items: center; gap: 20px; }
        .title { font-size: 20px; color: #27ae60; text-transform: uppercase; font-weight: bold; }
        
        .config-area { display: flex; gap: 10px; align-items: center; background: #222; padding: 5px 15px; border-radius: 8px; border: 1px solid #444; }
        select, input { background: #111; border: 1px solid #555; color: white; padding: 5px; border-radius: 4px; font-size: 14px; text-align: center; outline: none; }
        
        .btn-settings { background: #333; border: 1px solid #555; color: #ccc; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; }
        
        /* DROP AREA */
        .drop-compact { flex: 1; margin-left: 30px; border: 2px dashed #444; border-radius: 8px; height: 45px; display: flex; align-items: center; justify-content: center; cursor: pointer; background: #151515; color: #888; font-size: 13px; transition: 0.3s; }
        .drop-compact:hover { border-color: #aaa; color: white; }
        .drop-compact.dragover { background: rgba(46, 204, 113, 0.2); border-color: #2ecc71; color: #2ecc71; }

        /* TASTO PLANNING (Ex Home) */
        .btn-back { background: #2c3e50; color: white; padding: 8px 15px; border-radius: 5px; text-decoration: none; font-size: 13px; border: 1px solid #34495e; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .btn-back:hover { background: #34495e; border-color: white; }

        /* WORKSPACE 50/50 */
        .workspace { flex: 1; display: flex; padding: 15px; gap: 15px; overflow: hidden; width: 100%; box-sizing: border-box; }
        .col-half { flex: 1; display: flex; flex-direction: column; overflow: hidden; border-radius: 8px; }
        .col-valid { background: rgba(46, 204, 113, 0.05); border: 2px solid #27ae60; }
        .col-discard { background: rgba(231, 76, 60, 0.08); border: 2px solid #c0392b; display: none; }

        /* TABELLE */
        .panel-header { padding: 10px; background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: bold; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .table-wrap { flex: 1; overflow: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: auto; }
        th { position: sticky; top: 0; background: #1f1f1f; padding: 10px 8px; text-align: left; color: #aaa; font-size: 10px; z-index: 10; border-bottom: 1px solid #444; text-transform: uppercase; }
        td { padding: 6px 8px; border-bottom: 1px solid rgba(255,255,255,0.05); white-space: nowrap; vertical-align: middle; }

        /* INPUT */
        .editable-input, .select-name { background: #000 !important; border: 1px solid #555 !important; border-radius: 4px; color: #fff !important; padding: 4px !important; width: 65px !important; text-align: center; }
        .select-name { width: 120px !important; text-align: left; cursor: pointer; color: #f1c40f !important; font-weight: bold; }
        .editable-input:focus, .select-name:focus { border-color: #27ae60 !important; outline: none; }
        .inp-text-edit { width: 120px !important; text-align: left; }
        .inp-date-edit { width: 100px !important; color: #3498db !important; font-weight: bold; }

        /* BOTTONI */
        .act-btn { cursor: pointer; display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; margin: 0 2px; transition: 0.2s; font-size: 12px; }
        .del-row { background: #c0392b; color: white; }
        .rec-row { background: #27ae60; color: white; }
        .kill-row { background: transparent; border: 1px solid #555; color: #888; font-size: 10px; }
        .full-day-btn { background: #f1c40f; color: black; }
        .note-time-btn { background: #3498db; color: white; }
        .btn-recalc { background: #f39c12; color: #000; border: none; padding: 5px 15px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .btn-recalc:hover { background: #e67e22; transform: scale(1.05); }

        /* FOOTER & STATUS */
        .footer-bar { height: 50px; background: #1a1a1a; border-top: 1px solid #333; display: flex; align-items: center; justify-content: flex-end; padding: 0 20px; gap: 20px; flex-shrink: 0; }
        .btn-confirm { background: #27ae60; color: white; padding: 10px 40px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; display: none; }
        #status-msg { color: #888; margin-right: auto; font-style: italic; }

        /* MODAL MAPPING */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: #1e1e1e; width: 500px; padding: 25px; border-radius: 12px; border: 1px solid #444; }
        .map-row { display: flex; align-items: center; justify-content: space-between; background: #222; padding: 8px; border-radius: 6px; margin-bottom: 8px; }
    </style>
</head>
<body>

    <div class="modal-overlay" id="mapping-modal">
        <div class="modal-box">
            <h2 style="margin:0; color:#3498db; font-size: 18px;">‚ö†Ô∏è ASSOCIAZIONE NOMI</h2>
            <div id="mapping-list" style="max-height:300px; overflow-y:auto; margin: 15px 0;"></div>
            <button style="width:100%; padding:10px; background:#27ae60; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;" onclick="confirmMapping()">SALVA E PROCEDI</button>
        </div>
    </div>

    <div class="top-bar">
        <div class="brand-area">
            <a href="planning.html" class="btn-back">üìÖ PLANNING</a>
            <div class="title">Excel Manager <span style="font-size:10px; color:#666;">V6.6</span></div>
            <button class="btn-settings" onclick="resetMapping()">‚öôÔ∏è RESET MAP</button>
        </div>
        
        <div id="drop-area" class="drop-compact">
            <span id="drop-text">üìÇ CLICCA O TRASCINA FILE QUI</span>
            <input type="file" id="file-inp" accept=".xlsx, .xls, .csv" style="display:none">
        </div>
    </div>

    <div class="workspace">
        <div class="col-half col-valid" id="valid-panel">
            <div class="panel-header" style="color: #27ae60;">
                <span>‚úÖ PRONTE ALL'INVIO (<span id="valid-count">0</span>)</span>
                <button class="btn-recalc" onclick="recalculateAll()">üîÑ RICALCOLA E ORDINA</button>
            </div>
            <div class="table-wrap">
                <table id="preview-table">
                    <thead>
                        <tr>
                            <th>Del</th>
                            <th class="col-date">Data</th>
                            <th>Inizio</th>
                            <th>Fine</th>
                            <th>Dipendente</th>
                            <th>Cliente</th>
                            <th>Commessa</th>
                            <th class="wide-cell">Mansione / Note</th>
                        </tr>
                    </thead>
                    <tbody id="preview-body"></tbody>
                </table>
            </div>
        </div>

        <div class="col-half col-discard" id="discard-panel">
            <div class="panel-header" style="color: #e74c3c;">‚ö†Ô∏è SCARTI DA CORREGGERE (<span id="disc-count">0</span>)</div>
            <div class="table-wrap">
                <table id="discard-table">
                    <thead>
                        <tr>
                            <th>Azioni</th>
                            <th class="col-date">Data</th>
                            <th>Inizio</th>
                            <th>Fine</th>
                            <th>Dipendente</th>
                            <th>Cliente</th>
                            <th class="wide-cell">Mansione</th>
                            <th style="color: #e74c3c;">Errore</th>
                        </tr>
                    </thead>
                    <tbody id="discard-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="footer-bar">
        <div id="status-msg">In attesa di file...</div>
        <span style="color:#888; font-size:12px; margin-right:15px;">Slot totali: <b id="total-slots" style="color:#27ae60;">0</b></span>
        <button id="btn-confirm" class="btn-confirm" onclick="uploadToFirebase()">CONFERMA E IMPORTA NEL PLANNING üöÄ</button>
    </div>

    <script>
        // CONFIGURAZIONE FIREBASE
        const firebaseConfig = { apiKey: "AIzaSyCfFDdtzkZLClamp-Z_iODl8KQbBevEAfg", authDomain: "planner-carpenteria.firebaseapp.com", databaseURL: "https://planner-carpenteria-default-rtdb.europe-west1.firebasedatabase.app", projectId: "planner-carpenteria", storageBucket: "planner-carpenteria.firebasestorage.app", messagingSenderId: "926532216818", appId: "1:926532216818:web:927f43972c81bbf580ed6b" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let dipendentiAttivi = ["Camara", "Filippo", "Fofo", "Ibra", "Ico", "Lorenzo", "Teo", "Roberto", "Simone", "Tonino"];
        let anagrafica = {};
        let rawJsonData = []; 
        let currentMapping = JSON.parse(localStorage.getItem('dip_mapping') || '{}'); 
        const mesiMap = { "GENNAIO":"01","FEBBRAIO":"02","MARZO":"03","APRILE":"04","MAGGIO":"05","GIUGNO":"06","LUGLIO":"07","AGOSTO":"08","SETTEMBRE":"09","OTTOBRE":"10","NOVEMBRE":"11","DICEMBRE":"12" };

        window.onload = function() {
        // Controllo di sicurezza tramite Firebase Auth
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                // Utente valido! Avviamo il planning
                loadAnagrafica();
                initDate();
                const sStart = document.getElementById('edit-start'); const sEnd = document.getElementById('edit-end');
                for(let h=6; h<=22; h++) { for(let m=0; m<60; m+=15) { if(h===22 && m>0) break; let t = (h<10?'0':'')+h+':'+(m===0?'00':m); sStart.innerHTML += `<option value="${t}">${t}</option>`; sEnd.innerHTML += `<option value="${t}">${t}</option>`; } }
                sEnd.innerHTML += `<option value="22:15">22:15</option>`;
            } else {
                // Utente non loggato, cacciamolo
                window.location.href = 'index.html';
            }
        });
    };

        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-inp');
        const statusMsg = document.getElementById('status-msg');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => { dropArea.addEventListener(eventName, preventDefaults, false); document.body.addEventListener(eventName, preventDefaults, false); });
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        ['dragenter', 'dragover'].forEach(eventName => { dropArea.addEventListener(eventName, () => dropArea.classList.add('dragover'), false); });
        ['dragleave', 'drop'].forEach(eventName => { dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragover'), false); });
        
        dropArea.addEventListener('drop', handleDrop, false);
        function handleDrop(e) { const dt = e.dataTransfer; const files = dt.files; handleFiles(files); }
        
        dropArea.addEventListener('click', () => { fileInput.value = ''; fileInput.click(); });
        fileInput.addEventListener('change', function() { handleFiles(this.files); });

        function handleFiles(files) {
            if(files.length > 0) {
                statusMsg.innerText = "‚è≥ Lettura file in corso...";
                const file = files[0];
                document.getElementById('drop-text').innerText = file.name;
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        rawJsonData = XLSX.utils.sheet_to_json(sheet);
                        statusMsg.innerText = `‚úÖ File letto: ${rawJsonData.length} righe. Analisi nomi...`;
                        analizzaNomi(rawJsonData);
                    } catch(err) {
                        alert("Errore lettura file: " + err.message);
                        statusMsg.innerText = "‚ùå Errore lettura";
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        // --- LOGICA EXCEL MANAGER ---
        function analizzaNomi(data) {
            let foundNames = new Set();
            data.forEach(row => { let n = row['Operatore'] || row['Dipendente']; if(n) foundNames.add(n.trim()); });
            let unknowns = [];
            foundNames.forEach(name => {
                let resolved = resolveName(name); 
                if (!resolved) unknowns.push(name);
            });
            if(unknowns.length > 0) mostraModalMapping(unknowns);
            else parseData(data);
        }

        function mostraModalMapping(names) {
            const list = document.getElementById('mapping-list'); list.innerHTML = "";
            names.forEach(n => {
                let options = `<option value="OLD">üèõÔ∏è STORICO</option><option value="SKIP">üö´ IGNORA</option><optgroup label="Mappa su:">`;
                dipendentiAttivi.forEach(d => { options += `<option value="${d}">${d}</option>`; });
                options += `</optgroup>`;
                list.innerHTML += `<div class="map-row"><span>${n}</span><select class="action-select" data-orig="${n.toUpperCase()}">${options}</select></div>`;
            });
            document.getElementById('mapping-modal').style.display = 'flex';
        }

        function confirmMapping() {
            document.querySelectorAll('.action-select').forEach(sel => { currentMapping[sel.dataset.orig] = sel.value; });
            localStorage.setItem('dip_mapping', JSON.stringify(currentMapping));
            document.getElementById('mapping-modal').style.display = 'none';
            parseData(rawJsonData);
        }

        function resetMapping() { if(confirm("Reset mappa nomi?")) { localStorage.removeItem('dip_mapping'); currentMapping = {}; location.reload(); } }

        function resolveName(name) {
            if(!name) return null;
            let upper = name.trim().toUpperCase();
            if(dipendentiAttivi.some(d => d.toUpperCase() === upper)) return dipendentiAttivi.find(d => d.toUpperCase() === upper);
            for (let realName in anagrafica) {
                let d = anagrafica[realName];
                if (d.aliases) {
                    let aliasList = d.aliases.toUpperCase().split(',').map(a => a.trim());
                    if (aliasList.includes(upper)) return realName;
                }
            }
            if(currentMapping[upper]) {
                let mapped = currentMapping[upper];
                if(mapped === "SKIP") return null;
                if(mapped === "OLD") return name.trim();
                return mapped;
            }
            return null;
        }

        function parseData(data) {
            const validBody = document.getElementById('preview-body');
            const discBody = document.getElementById('discard-body');
            validBody.innerHTML = ''; discBody.innerHTML = '';

            data.forEach((row) => {
                let nomeRaw = row['Operatore'] || row['Dipendente'];
                let nomeFinal = resolveName(nomeRaw);
                if(!nomeFinal) return; 

                // DATA AUTO
                let y = row['Anno'] || row['__EMPTY']; 
                let mRaw = row['Mese'] || row['__EMPTY_1'];
                let dNum = row['Data'] || row['Giorno']; 
                let m = mRaw && mesiMap[mRaw.toString().trim().toUpperCase()] ? mesiMap[mRaw.toString().trim().toUpperCase()] : "01";
                
                let dataStr = "";
                if(y && m && dNum) { dataStr = `${y}-${m}-${String(dNum).padStart(2,'0')}`; }

                let inizio = parseExcelTimeRound(row['Inizio']);
                let fine = parseExcelTimeRound(row['Fine']);
                let comm = row['Commessa'] || "";
                let cliente = row['Cliente'] || "";
                let mans = row['Mansione'] || "";
                let totOre = row['Tot Ore'];

                let error = null;
                if (!dataStr) error = "Data Mancante";
                else if (!totOre || totOre == 0) error = "Ore a Zero";
                else if (!inizio || !fine) error = "Manca Orario";
                else if (inizio === fine) error = "Durata 0m";

                if (error) {
                    addDiscardRow(dataStr, inizio, fine, nomeFinal, cliente, mans, error, comm);
                } else {
                    addValidRow(dataStr, inizio, fine, nomeFinal, cliente, comm, mans);
                }
            });
            updateCounts();
        }

        function addValidRow(date, start, end, name, client, comm, mans) {
            const validBody = document.getElementById('preview-body');
            let tr = document.createElement('tr');
            tr.innerHTML = `
                <td><div class="act-btn del-row" onclick="this.closest('tr').remove(); updateCounts()">‚úï</div></td>
                <td class="td-date">${date}</td>
                <td class="td-start">${start}</td>
                <td class="td-end">${end}</td>
                <td class="td-name">${name}</td>
                <td class="td-client">${client}</td>
                <td class="td-comm">${comm}</td>
                <td class="wide-cell td-mans">${mans}</td>
            `;
            validBody.appendChild(tr);
        }

        function addDiscardRow(dataStr, inizio, fine, nomeFinal, cliente, mans, error, comm) {
            const discBody = document.getElementById('discard-body');
            let nameOptions = "";
            dipendentiAttivi.forEach(d => {
                let sel = (d === nomeFinal) ? "selected" : "";
                nameOptions += `<option value="${d}" ${sel}>${d}</option>`;
            });

            let tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="display:flex; gap:2px;">
                    <div class="act-btn full-day-btn" title="07:30-16:30" onclick="setFullDay(this)">‚òÄÔ∏è</div>
                    <div class="act-btn note-time-btn" title="06:00-06:15" onclick="setNoteTime(this)">üìù</div>
                    <div class="act-btn rec-row" title="Ricicla" onclick="tryRecover(this)">‚ôªÔ∏è</div>
                    <div class="act-btn kill-row" title="Elimina" onclick="this.closest('tr').remove(); updateCounts()">‚úï</div>
                </td>
                <td><input type="text" value="${dataStr||''}" class="editable-input inp-date-edit inp-date-err" placeholder="AAAA-MM-GG"></td>
                <td><input type="text" value="${inizio||''}" class="editable-input inp-start"></td>
                <td><input type="text" value="${fine||''}" class="editable-input inp-end"></td>
                <td><select class="select-name inp-name">${nameOptions}</select></td>
                <td><input type="text" value="${cliente}" class="editable-input inp-text-edit inp-client"></td>
                <td class="wide-cell"><input type="text" value="${mans}" class="editable-input inp-text-edit inp-mans" style="width: 220px !important; text-align:left;"></td>
                <td style="color:#e74c3c; font-weight:bold;">${error}</td>
                <input type="hidden" class="hidden-comm" value="${comm}">
            `;
            discBody.appendChild(tr);
        }

        window.setFullDay = function(btn) { 
            let tr=btn.closest('tr'); 
            tr.querySelector('.inp-start').value="07:30"; 
            tr.querySelector('.inp-end').value="16:30"; 
            tryRecover(btn); 
        }
        
        window.setNoteTime = function(btn) { 
            let tr=btn.closest('tr'); 
            tr.querySelector('.inp-start').value="06:00"; 
            tr.querySelector('.inp-end').value="06:15";   
            tryRecover(btn); 
        }
        
        window.tryRecover = function(btn) {
            let tr = btn.closest('tr');
            let date = tr.querySelector('.inp-date-err').value;
            let start = tr.querySelector('.inp-start').value;
            let end = tr.querySelector('.inp-end').value;
            let name = tr.querySelector('.inp-name').value;
            let client = tr.querySelector('.inp-client').value;
            let mans = tr.querySelector('.inp-mans').value;
            let comm = tr.querySelector('.hidden-comm').value;

            if(!date || date.length < 10) { alert("Data incompleta! Usa AAAA-MM-GG"); return; }
            if(!name || !timeToMins(start) || !timeToMins(end)) { alert("Controlla orari e nome!"); return; }
            
            addValidRow(date, start, end, name, client, comm, mans);
            tr.remove(); 
            updateCounts();
        }

        function recalculateAll() {
            let rows = document.querySelectorAll('#preview-body tr');
            let validRows = []; let invalidRows = [];
            rows.forEach(tr => {
                let d = tr.querySelector('.td-date').innerText.trim();
                let s = tr.querySelector('.td-start').innerText.trim();
                let e = tr.querySelector('.td-end').innerText.trim();
                let n = tr.querySelector('.td-name').innerText.trim();
                let cl = tr.querySelector('.td-client').innerText.trim();
                let c = tr.querySelector('.td-comm').innerText.trim();
                let m = tr.querySelector('.td-mans').innerText.trim();
                if(d && n && timeToMins(s) && timeToMins(e)) validRows.push({ d, s, e, n, cl, c, m });
                else invalidRows.push({ d, s, e, n, cl, c, m, err: "Dati persi" });
            });
            document.getElementById('preview-body').innerHTML = "";
            validRows.sort((a, b) => { if (a.d !== b.d) return a.d.localeCompare(b.d); return timeToMins(a.s) - timeToMins(b.s); });
            validRows.forEach(r => addValidRow(r.d, r.s, r.e, r.n, r.cl, r.c, r.m));
            invalidRows.forEach(r => addDiscardRow(r.d, r.s, r.e, r.n, r.cl, r.m, r.err, r.c));
            updateCounts(); alert("Ricalcolo completato!");
        }

        function updateCounts() {
            let nV = document.getElementById('preview-body').rows.length, nD = document.getElementById('discard-body').rows.length;
            document.getElementById('valid-count').innerText = nV; document.getElementById('disc-count').innerText = nD;
            document.getElementById('discard-panel').style.display = nD > 0 ? 'flex' : 'none';
            document.getElementById('btn-confirm').style.display = nV > 0 ? 'block' : 'none';
            let slots = 0;
            document.querySelectorAll('#preview-body tr').forEach(tr => {
                let sTxt = tr.querySelector('.td-start').innerText;
                let eTxt = tr.querySelector('.td-end').innerText;
                let s = timeToMins(sTxt), e = timeToMins(eTxt);
                if(s && e) slots += Math.floor((e-s)/15);
            });
            document.getElementById('total-slots').innerText = slots;
        }

        // --- UPLOAD CON AUTO-PAUSA ---
        async function uploadToFirebase() {
            const rows = document.querySelectorAll('#preview-body tr');
            if(!confirm(`Caricare ${rows.length} record nel Planning?`)) return;
            const updates = {};
            
            rows.forEach(tr => {
                let d = tr.querySelector('.td-date').innerText.trim();
                let sTxt = tr.querySelector('.td-start').innerText.trim();
                let eTxt = tr.querySelector('.td-end').innerText.trim();
                let n = tr.querySelector('.td-name').innerText.trim();
                let cl = tr.querySelector('.td-client').innerText.trim();
                let c = tr.querySelector('.td-comm').innerText.trim();
                let m = tr.querySelector('.td-mans').innerText.trim();

                let sM = timeToMins(sTxt);
                let eM = timeToMins(eTxt);

                let empData = anagrafica[n] || {};
                let pStart = timeToMins(empData.pausaStart || "12:00");
                let pEnd = timeToMins(empData.pausaEnd || "13:00");

                if(sM && eM && d && n) {
                    for(let t=sM; t<eM; t+=15) {
                        let tk = String(Math.floor(t/60)).padStart(2,'0') + ":" + String(t%60).padStart(2,'0');
                        let bk = `turni/${d}/${tk}-${n}`;
                        
                        if (t >= pStart && t < pEnd) {
                            updates[bk+'-commessa'] = "PAUSA"; 
                            updates[bk+'-cliente'] = ""; 
                            updates[bk+'-note'] = "Pausa Pranzo";
                        } else {
                            updates[bk+'-commessa'] = c; 
                            updates[bk+'-cliente'] = cl; 
                            updates[bk+'-note'] = m;
                        }
                    }
                }
            });
            
            db.ref().update(updates).then(() => { 
                alert("‚úÖ IMPORTAZIONE RIUSCITA!"); 
                location.href = "planning.html"; // Redirect automatico
            }).catch(err => alert("Errore Firebase: " + err.message));
        }

        function parseExcelTimeRound(v) { let t = 0; if(typeof v === 'number') t = Math.round(v * 1440); else if(typeof v === 'string' && v.includes(':')) { let p = v.split(':'); t = parseInt(p[0]) * 60 + parseInt(p[1]); } else return null; let r = Math.round(t / 15) * 15; return String(Math.floor(r/60)).padStart(2,'0') + ":" + String(r%60).padStart(2,'0'); }
        function timeToMins(s) { if(!s || !s.includes(':')) return null; let p = s.split(':'); return parseInt(p[0])*60 + parseInt(p[1]); }
    </script>
</body>
</html>