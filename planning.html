<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Planning - Gestionale</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        /* =========================================
           STILI ORIGINALI (INTATTI)
           ========================================= */
        body { font-family: 'Segoe UI', sans-serif; background: #111; color: white; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .no-select { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }

        /* TOP NAV */
        .top-nav { background: #1a1a1a; border-bottom: 1px solid #333; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; gap: 20px; height: 60px; flex-shrink: 0; }
        .nav-left { flex: 0 0 auto; }
        .btn-home { background: transparent; border: 1px solid #444; color: #ccc; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .btn-home:hover { border-color: white; color: white; }

        .nav-center { flex: 1; display: flex; justify-content: center; align-items: center; gap: 15px; overflow-x: auto; }
        
        /* MOBILE NAV */
        .week-select { background: #222; color: white; border: 1px solid #444; padding: 5px; border-radius: 5px; font-family: inherit; font-size: 13px; cursor: pointer; }
        .day-group { display: flex; gap: 3px; background: #222; padding: 3px; border-radius: 8px; border: 1px solid #333; }
        .day-btn { padding: 6px 12px; background: transparent; border: none; color: #888; border-radius: 5px; cursor: pointer; user-select: none; font-size: 12px; font-weight: bold; transition: 0.2s; }
        .day-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .day-btn.selected { background: #eee; color: black; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .mobile-date-picker { display: none; background: #222; color: white; border: 1px solid #444; padding: 5px; border-radius: 6px; font-family: 'Segoe UI', sans-serif; width: 110px; font-size: 12px; }

        /* DESKTOP NAV */
        .desktop-nav-group { display: none; align-items: center; gap: 10px; background: #222; padding: 5px 15px; border-radius: 10px; border: 1px solid #333; }
        .desk-date-input { background: #111; border: 1px solid #444; color: white; padding: 5px; border-radius: 5px; cursor: pointer; color-scheme: dark; }
        .btn-nav-arrow { background: transparent; border: 1px solid #444; color: #ccc; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; font-size: 14px; }
        .btn-nav-arrow:hover { background: #333; color: white; border-color: #666; }
        .desk-date-text { font-size: 16px; font-weight: bold; color: #3498db; text-transform: capitalize; min-width: 220px; text-align: center; user-select: none; }

        /* VIEW BUTTONS */
        .view-group { display: flex; gap: 5px; margin-left: 10px; }
        .view-btn { padding: 6px 12px; background: transparent; border: 1px solid #444; color: #888; border-radius: 15px; cursor: pointer; font-size: 11px; font-weight: bold; text-transform: uppercase; transition: 0.2s; }
        .view-btn:hover { border-color: #666; color: white; }
        .view-btn.selected { background: #E94560; color: white; border-color: #E94560; }
        .btn-wa { border-color: #9b59b6; color: #9b59b6; } .btn-wa:hover { background: rgba(155, 89, 182, 0.2); color: #fff; border-color: #9b59b6; }
        .btn-xls { border-color: #27ae60; color: #27ae60; } .btn-xls:hover { background: rgba(39, 174, 96, 0.2); color: #fff; border-color: #27ae60; }
        .btn-manage { border-color: #34495e; color: #ccc; background: #2c3e50; } 
        .btn-manage:hover { background: #34495e; color: white; border-color: #5d6d7e; }

        .nav-right { flex: 0 0 auto; display: flex; align-items: center; gap: 10px; background: rgba(231, 76, 60, 0.1); padding: 5px 10px; border-radius: 8px; border: 1px solid rgba(231, 76, 60, 0.3); }
        .btn-clean { background: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; text-transform: uppercase; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .btn-clean:hover { background: #c0392b; transform: scale(1.05); }

        .scroll-dip { display: none; gap: 10px; overflow-x: auto; padding: 10px 20px; background: #111; border-bottom: 1px solid #333; justify-content: center; }
        .scroll-dip.visible { display: flex; }
        .btn-dip { padding: 5px 15px; border: 1px solid #333; background: #1a1a1a; color: #aaa; border-radius: 15px; cursor: pointer; white-space: nowrap; font-size: 11px; transition: 0.2s; }
        .btn-dip.selected { background: #E94560; color: white; border-color: #E94560; }

        .main-area { flex: 1; overflow: auto; padding: 10px; position: relative; }
        table { border-collapse: separate; border-spacing: 4px 2px; } 
        th { position: sticky; top: 0; background: #222; padding: 10px; font-size: 11px; border-bottom: 1px solid #444; z-index: 10; text-transform: uppercase; color: #888; }
        td { height: 35px; text-align: center; font-size: 12px; color: #ccc; cursor: pointer; background: #141414; vertical-align: top; padding: 0; border: 1px solid #222; border-radius: 4px; }
        
        /* --- CSS COLONNE DINAMICHE (MODIFICATO) --- */
        @media (min-width: 1025px) {
            #main-table { table-layout: fixed; width: 100%; }
            .col-ora { width: 50px !important; }
            /* Dipendenti SENZA ore (Stretti ma colore originale) */
            .col-inactive { width: 40px !important; overflow: hidden; font-size: 9px !important; opacity: 0.7; }
            /* Dipendenti CON ore (Si dividono lo spazio rimanente) */
            .col-active { width: auto; font-size: 12px; }
        }
        
        /* Badge Ore Semplificato */
        .hours-badge { font-weight: normal; margin-left: 3px; opacity: 0.8; font-size: 10px; }

        .col-ora { position: sticky; left: 0; background: #1a1a1a; color: rgba(255,255,255,0.8); font-weight: normal; border-right: 1px solid #333; z-index: 5; width: 60px; font-size: 11px; vertical-align: middle; }
        #main-table { width: 100%; min-width: 1000px; }
        .single-dip-table { width: 100%; max-width: 800px; margin: 0 auto; min-width: auto !important; border-collapse: separate; border-spacing: 0 2px; }
        
        .task-block { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; background: linear-gradient(145deg, #2a2a2a, #202020); border: 1px solid rgba(255, 255, 255, 0.3); border-left-width: 4px; border-radius: 6px; box-sizing: border-box; padding: 4px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: 0.2s; }
        .task-block:hover { filter: brightness(1.3); z-index: 10; transform: scale(1.02); }
        .task-client { font-size: 10px; font-style: italic; color: #aaa; margin-bottom: 1px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .task-comm { font-weight: 700; font-size: 13px; margin-bottom: 2px; text-transform: uppercase; text-align: center; color: white; letter-spacing: 0.5px; }
        .task-note { font-size: 10px; color: #ccc; white-space: normal; line-height: 1.1; text-align: center; opacity: 0.8; font-style: italic; }
        .selected-cell .task-block { border: 2px solid #fff !important; }
        .task-block.is-pausa { background: repeating-linear-gradient(45deg, rgba(255,255,255,0.05), rgba(255,255,255,0.05) 10px, rgba(255,255,255,0.1) 10px, rgba(255,255,255,0.1) 20px) !important; border-color: #666 !important; color: #aaa !important; }
        .task-block.is-pausa .task-comm { color: #aaa !important; }
        #dip-detail-container { width: 100%; display: flex; flex-direction: column; align-items: center; padding-bottom: 50px; }
        .dip-card-wrapper { padding: 10px; border-radius: 12px; border: 1px solid transparent; box-shadow: 0 0 20px rgba(0,0,0,0.5); background: #111; }

        /* MODALI */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #1e1e1e; width: 95%; height: 95%; border-radius: 15px; border: 1px solid #444; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .modal-head { padding: 15px; border-bottom: 1px solid #444; display: flex; justify-content: space-between; background: #111; }
        
        .manage-box { width: 900px; max-width: 95%; height: 80vh; background: #1e1e1e; padding: 20px; border-radius: 15px; display: flex; flex-direction: column; }
        .manage-cols { display: flex; gap: 20px; flex: 1; overflow: hidden; margin-top: 15px; }
        .manage-col { flex: 1; background: #151515; border: 1px solid #333; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; }
        .manage-title { font-weight: bold; text-transform: uppercase; text-align: center; padding: 10px; border-bottom: 1px solid #333; color: #fff; }
        .list-dip { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; padding-top: 10px; }
        .item-dip { background: #222; padding: 10px; border-radius: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; }
        .item-dip:hover { background: #2a2a2a; border-color: #555; }
        .btn-move { background: transparent; border: 1px solid #555; color: #888; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-move:hover { color: white; border-color: white; background: #444; }
        
        .alias-popup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #2c3e50; padding: 25px; border-radius: 12px; border: 2px solid #3498db; width: 400px; z-index: 10001; box-shadow: 0 0 50px rgba(0,0,0,0.9); display: none; }
        .alias-popup label { font-size: 11px; color: #aaa; text-transform: uppercase; font-weight: bold; margin-top: 10px; display: block; }
        .alias-popup input, .alias-popup textarea { width: 100%; background: #1a1a1a; border: 1px solid #444; color: white; padding: 8px; border-radius: 5px; margin-top: 5px; box-sizing: border-box; }
        .alias-popup textarea { resize: none; height: 60px; }
        .time-row { display: flex; gap: 10px; }
        .time-row div { flex: 1; }

        .clean-modal-content { width: 400px; height: auto; padding: 25px; border-left: 5px solid #e74c3c; gap: 15px; }
        .clean-checklist { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 200px; overflow-y: auto; background: #151515; padding: 10px; border: 1px solid #444; border-radius: 5px; margin-bottom: 15px; }
        .check-item { display: flex; align-items: center; gap: 8px; font-size: 14px; cursor: pointer; color: #ddd; }
        .check-item input { accent-color: #e74c3c; cursor: pointer; width: 16px; height: 16px; }
        .clean-modal-content label { color: #aaa; font-size: 11px; text-transform: uppercase; font-weight: bold; margin-bottom: 5px; display: block; }
        .clean-modal-content input[type="date"] { background: #111; border: 1px solid #444; color: white; padding: 10px; width: 100%; box-sizing: border-box; border-radius: 5px; margin-bottom: 15px; }
        .clean-modal-content button { width: 100%; padding: 12px; background: #e74c3c; color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 5px; }
        .clean-modal-content button:hover { background: #c0392b; }

        .wa-cols { display: flex; flex: 1; overflow: hidden; }
        .wa-left { flex: 1; padding: 20px; border-right: 1px solid #444; display: flex; flex-direction: column; gap: 10px; background: #181818; }
        .wa-right { flex: 2.5; padding: 20px; overflow-y: auto; background: #141414; }
        textarea { flex: 1; background: #111; border: 1px solid #444; color: #ddd; padding: 10px; resize: none; border-radius: 8px; font-family: monospace; }
        textarea:focus { outline: none; border-color: #9b59b6; }
        .wa-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 12px; }
        .wa-table th { text-align: left; padding: 8px; color: #9b59b6; border-bottom: 1px solid #444; background: #1e1e1e; position: sticky; top: 0; z-index: 5; }
        .wa-table td { padding: 4px; border-bottom: 1px solid #333; vertical-align: middle; }
        .wa-inp { background: transparent; border: 1px solid transparent; color: white; width: 100%; padding: 4px; font-family: inherit; font-size: 12px; border-radius: 4px; box-sizing: border-box; }
        .wa-inp:focus { border-color: #9b59b6; background: rgba(155, 89, 182, 0.1); outline: none; }
        .btn-del-row { color: #e74c3c; cursor: pointer; font-weight: bold; font-size: 14px; background: transparent; border: none; padding: 0 5px; }

        .modal-edit-box { background: #1e1e1e; width: 900px; max-width: 95%; padding: 40px; border-radius: 15px; border: 1px solid #444; box-shadow: 0 0 60px rgba(0,0,0,0.9); display: flex; flex-direction: column; gap: 25px; border-left: 10px solid #00ff88; }
        .edit-row { display: flex; gap: 20px; }
        .edit-group { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .edit-label { font-size: 14px; color: #aaa; text-transform: uppercase; font-weight: bold; letter-spacing: 1px; }
        .edit-inp, .edit-select { background: #111; border: 1px solid #444; color: white; padding: 15px; border-radius: 8px; font-family: 'Segoe UI', sans-serif; font-size: 16px; width: 100%; box-sizing: border-box; }
        .edit-inp:focus, .edit-select:focus { border-color: #00ff88; outline: none; background: #151515; }
        .btn-save-big { background: #00ff88; color: black; border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; flex: 1; font-size: 16px; transition: 0.2s; }
        .btn-save-big:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 0 15px rgba(0, 255, 136, 0.4); }
        .btn-del-big { background: #e74c3c; color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 16px; transition: 0.2s; }
        .btn-del-big:hover { background: #c0392b; transform: translateY(-2px); box-shadow: 0 0 15px rgba(231, 76, 60, 0.4); }
        .btn-close-edit { background: transparent; border: 1px solid #444; color: #888; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; }
        .btn-close-edit:hover { border-color: white; color: white; }
        .btn-pausa { background: #f39c12; color: white; border: none; padding: 8px; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 5px; font-size: 13px; display: flex; align-items: center; justify-content: center; width: 100%; transition: 0.2s; }
        .btn-pausa:hover { background: #e67e22; transform: translateY(-2px); }
        #edit-dip-title { font-size: 24px; letter-spacing: 2px; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 10px; }

        #editor-popup { display: none; position: absolute; background: #222; border: 2px solid #00ff88; padding: 10px; z-index: 100; width: 250px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #editor-txt { width: 100%; height: 80px; background: #111; color: white; border: 1px solid #444; margin-bottom: 5px; border-radius: 4px; resize: none; padding: 5px; box-sizing: border-box; }
        #editor-txt:focus { outline: none; border-color: #00ff88; }

        /* =========================================
           MEDIA QUERIES (DESKTOP VS MOBILE)
           ========================================= */
        @media (min-width: 1025px) {
            .week-select, .day-group, .mobile-date-picker { display: none !important; }
            .desktop-nav-group { display: flex !important; }
        }

        @media (max-width: 1024px) {
            .top-nav { padding: 5px 10px; gap: 5px; height: 50px; }
            .btn-home { padding: 8px 10px; border-radius: 10px; }
            .desktop-text { display: none; }
            .nav-right { padding: 2px 5px; border: none; background: transparent; gap: 5px; }
            .btn-clean { padding: 8px; border-radius: 5px; }
            .nav-center { flex: 1; justify-content: center; gap: 10px; }
            .week-select, .day-group { display: none !important; }
            .mobile-date-picker { display: block; }
            .view-group { display: flex !important; gap: 5px; margin-left: 0; }
            .view-btn { padding: 6px 8px; font-size: 10px; }
            .desktop-only { display: none !important; }
            .desktop-nav-group { display: none !important; }
        }
        @media (min-width: 769px) and (max-width: 1024px) {
           .week-select, .day-group { display: flex !important; }
           .mobile-date-picker { display: none; }
        }

    </style>
</head>
<body>
    
    <div class="top-nav">
        <div class="nav-left">
            <button class="btn-home" onclick="window.location.href='index.html'">
                <span>üè†</span> <span class="desktop-text">HOME</span>
            </button>
        </div>

        <div class="nav-center">
            <select id="weekSelect" class="week-select" onchange="cambiaSettimana(this.value)"></select>
            <div id="day-container" class="day-group"></div>
            <input type="date" id="mobileDatePicker" class="mobile-date-picker" onchange="selectDay(this.value, null)">

            <div class="desktop-nav-group">
                <input type="date" id="desktopDatePicker" class="desk-date-input" onchange="selectDay(this.value, null)">
                <button class="btn-nav-arrow" onclick="cambiaGiorno(-1)">‚ùÆ</button>
                <span id="deskDateLabel" class="desk-date-text">Caricamento...</span>
                <button class="btn-nav-arrow" onclick="cambiaGiorno(1)">‚ùØ</button>
            </div>

            <div class="view-group">
                <button class="view-btn selected" id="btn-tab" onclick="cambiaVista('tabellone')">GIORNALIERO</button>
                <button class="view-btn" id="btn-dip" onclick="cambiaVista('dipendente')">DIPENDENTI</button>
                <button class="view-btn btn-manage" onclick="apriGestione()">‚öôÔ∏è GESTISCI</button>
                <button class="view-btn btn-wa" onclick="apriWA()">WA</button>
                <button class="view-btn btn-xls desktop-only" onclick="window.location.href='excel_manager.html'">XLS</button>
            </div>
        </div>

        <div class="nav-right">
            <button class="btn-clean" onclick="apriPulisciAvanzato()">üóëÔ∏è <span class="desktop-text">PULISCI</span></button>
        </div>
    </div>

    <div id="dip-menu" class="scroll-dip"></div>

    <div class="main-area">
        <div id="view-tabellone">
            <table id="main-table"><thead><tr id="head-row"><th class="col-ora">Ora</th></tr></thead><tbody id="body-row"></tbody></table>
        </div>
        <div id="view-dipendente" style="display:none; overflow-y:auto;">
            <div id="dip-detail-container"></div>
        </div>
    </div>

    <div id="modal-manage" class="modal-overlay" style="display:none;">
        <div class="modal-box manage-box">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #444; padding-bottom:10px;">
                <h2 style="color:#3498db; margin:0;">ARCHIVIO DIPENDENTI</h2>
                <button onclick="document.getElementById('modal-manage').style.display='none'; location.reload();" style="background:transparent; border:none; color:white; font-size:24px; cursor:pointer;">‚úï</button>
            </div>
            <div class="manage-cols">
                <div class="manage-col">
                    <div class="manage-title" style="color:#2ecc71;">‚úÖ IN FORZA (VISIBILI)</div>
                    <div id="list-active" class="list-dip"></div>
                </div>
                <div class="manage-col">
                    <div class="manage-title" style="color:#e74c3c;">üèõÔ∏è STORICO (NASCOSTI)</div>
                    <div id="list-history" class="list-dip"></div>
                </div>
            </div>
        </div>
        
        <div id="alias-popup" class="alias-popup">
            <h4 id="alias-title" style="margin:0 0 10px 0; color:white; border-bottom:1px solid #3498db; padding-bottom:5px;"></h4>
            <label>SOPRANNOMI (separati da virgola)</label>
            <input type="text" id="alias-input" placeholder="Es. Pippo, Filo">
            
            <label style="color:#f39c12; margin-top:15px;">ORARIO PAUSA PRANZO (Automazione)</label>
            <div class="time-row">
                <div>
                    <label style="margin-top:0;">INIZIO</label>
                    <input type="time" id="alias-pausa-start">
                </div>
                <div>
                    <label style="margin-top:0;">FINE</label>
                    <input type="time" id="alias-pausa-end">
                </div>
            </div>

            <label>DATA ASSUNZIONE</label>
            <input type="date" id="alias-assunzione">
            
            <label>DATA CESSAZIONE</label>
            <input type="date" id="alias-cessazione">
            
            <label>NOTE</label>
            <textarea id="alias-note" placeholder="Scrivi note qui..."></textarea>
            
            <div style="margin-top:15px; text-align:right;">
                <button onclick="salvaAlias()" style="background:#2ecc71; border:none; padding:8px 15px; border-radius:4px; font-weight:bold; cursor:pointer;">SALVA</button>
                <button onclick="document.getElementById('alias-popup').style.display='none'" style="background:transparent; border:1px solid #555; color:#ccc; padding:8px 15px; border-radius:4px; margin-left:5px; cursor:pointer;">CHIUDI</button>
            </div>
        </div>
    </div>

    <div id="modal-clean-adv" class="modal-overlay" style="display:none;">
        <div class="modal-box clean-modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color:#e74c3c;">PULIZIA AVANZATA</h3>
                <button onclick="document.getElementById('modal-clean-adv').style.display='none'" style="background:transparent; border:none; color:white; font-size:18px; width:auto; padding:0; cursor:pointer;">‚úï</button>
            </div>
            <label>SELEZIONA DIPENDENTI</label>
            <div id="clean-checklist" class="clean-checklist"></div>
            <label>DA QUANDO (Data Inizio)</label>
            <input type="date" id="clean-start">
            <label>A QUANDO (Data Fine Inclusa)</label>
            <input type="date" id="clean-end">
            <button onclick="eseguiPuliziaAvanzata()">CONFERMA CANCELLAZIONE</button>
        </div>
    </div>

    <div id="modal-edit" class="modal-overlay" style="display: none;">
        <div class="modal-edit-box" id="edit-box-visual">
            <h3 style="margin:0; color:white; text-transform:uppercase;" id="edit-dip-title">MODIFICA MANSIONE</h3>
            <div class="edit-row"><div class="edit-group"><label class="edit-label">INIZIO</label><select id="edit-start" class="edit-select"></select></div><div class="edit-group"><label class="edit-label">FINE</label><select id="edit-end" class="edit-select"></select></div></div>
            
            <button class="btn-pausa" onclick="inserisciPausaConTaglio()">üçΩÔ∏è INSERISCI PAUSA PRANZO (12:00 - 13:00)</button>
            
            <div class="edit-row">
                <div class="edit-group"><label class="edit-label">CLIENTE</label><input type="text" id="edit-cliente" class="edit-inp" placeholder="Es. Rossi Srl"></div>
                <div class="edit-group"><label class="edit-label">COMMESSA</label><input type="text" id="edit-commessa" class="edit-inp" placeholder="Es. 136483"></div>
            </div>
            <div class="edit-group"><label class="edit-label">NOTE / DESCRIZIONE</label><textarea id="edit-note" class="edit-inp" rows="8" placeholder="Es. Saldatura nel girello..."></textarea></div>
            <div class="edit-row"><div class="edit-group"><label class="edit-label">QUANTIT√Ä</label><input type="text" id="edit-qta" class="edit-inp" placeholder="Es. 10 pz"></div><div class="edit-group"><label class="edit-label">VOTO</label><input type="text" id="edit-voto" class="edit-inp" placeholder="1-10"></div></div>
            <div class="edit-row" style="margin-top:10px;"><button class="btn-del-big" onclick="eliminaTask()">ELIMINA</button><button class="btn-save-big" onclick="salvaTaskAvanzato()">SALVA MODIFICHE</button><button class="btn-close-edit" onclick="document.getElementById('modal-edit').style.display='none'">CHIUDI</button></div>
        </div>
    </div>

    <div id="modal-wa" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-head"><span style="color:#9b59b6; font-weight:bold; font-size:18px;">IMPORTA WA</span><button onclick="document.getElementById('modal-wa').style.display='none'" style="background:transparent; border:none; color:#ccc; font-size:20px;">X</button></div>
            <div class="wa-cols"><div class="wa-left"><label style="font-size:12px; color:#888;">DATA RIFERIMENTO</label><input type="date" id="wa-date" style="background:#222; color:white; border:1px solid #444; padding:10px; border-radius:6px; width:100%; box-sizing:border-box;"><label style="font-size:12px; color:#888; margin-top:10px;">TESTO MESSAGGIO</label><textarea id="wa-input" placeholder="Incolla qui il messaggio..."></textarea><button onclick="analizzaWA()" style="padding:12px; background:#9b59b6; border:none; color:white; font-weight:bold; cursor:pointer; border-radius:6px; margin-top:10px;">ANALIZZA TESTO</button></div><div class="wa-right"><table class="wa-table"><thead><tr><th style="width: 80px;">DATA</th><th style="width: 30px;"></th><th style="width: 80px;">DIP</th><th style="width: 50px;">DA</th><th style="width: 50px;">A</th><th style="width: 120px;">COMM</th><th>DESCRIZIONE</th><th style="width: 50px;">QTA</th><th style="width: 50px;">VOTO</th></tr></thead><tbody id="wa-tbody"></tbody></table><button onclick="confermaWA()" style="margin-top:15px; padding:12px; width:100%; background:#27ae60; border:none; color:white; font-weight:bold; cursor:pointer; border-radius:6px;">INVIA AL PLANNING</button></div></div>
        </div>
    </div>

    <div id="editor-popup"><div style="font-size:11px; color:#888; margin-bottom:3px;">COMMESSA / NOTE</div><textarea id="editor-txt"></textarea><div style="text-align:right;"><button onclick="salvaEditor()" style="background:#00ff88; border:none; padding:5px 15px; font-weight:bold; border-radius:4px; cursor:pointer;">SALVA</button></div></div>
    <input type="date" id="hiddenDate" style="display:none;">

<script>
    const firebaseConfig = { apiKey: "AIzaSyCfFDdtzkZLClamp-Z_iODl8KQbBevEAfg", authDomain: "planner-carpenteria.firebaseapp.com", databaseURL: "https://planner-carpenteria-default-rtdb.europe-west1.firebasedatabase.app", projectId: "planner-carpenteria", storageBucket: "planner-carpenteria.firebasestorage.app", messagingSenderId: "926532216818", appId: "1:926532216818:web:927f43972c81bbf580ed6b" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    const dipendentiDefault = ["Camara", "Filippo", "Fofo", "Ibra", "Ico", "Lorenzo", "Teo", "Roberto", "Simone", "Tonino"];
    let anagrafica = {}; 
    let dipendentiAttuali = []; 
    const dipColors = { "Camara": "#e74c3c", "Filippo": "#3498db", "Fofo": "#f1c40f", "Ibra": "#9b59b6", "Ico": "#e67e22", "Lorenzo": "#1abc9c", "Teo": "#2ecc71", "Roberto": "#e91e63", "Simone": "#00bcd4", "Tonino": "#cddc39" };
    const colorStorico = "#777777"; 

    let currentDate = new Date().toISOString().split('T')[0];
    let dailyData = {}; 
    let waBlocks = [];
    let editDip = ""; let editOriginalStart = ""; let editOriginalEnd = "";
    let currentEditName = ""; 

    window.onload = function() {
        if(localStorage.getItem('auth_token') !== 'logged_in') window.location.href='index.html';
        loadAnagrafica();
        initDate();
        const sStart = document.getElementById('edit-start'); const sEnd = document.getElementById('edit-end');
        for(let h=6; h<=22; h++) { for(let m=0; m<60; m+=15) { if(h===22 && m>0) break; let t = (h<10?'0':'')+h+':'+(m===0?'00':m); sStart.innerHTML += `<option value="${t}">${t}</option>`; sEnd.innerHTML += `<option value="${t}">${t}</option>`; } }
        sEnd.innerHTML += `<option value="22:15">22:15</option>`;
    };

    function loadAnagrafica() {
        db.ref('anagrafica').once('value', snap => {
            anagrafica = snap.val();
            if (!anagrafica) {
                anagrafica = {};
                dipendentiDefault.forEach(d => { anagrafica[d] = { type: "active", aliases: "" }; });
                db.ref('anagrafica').set(anagrafica);
            }
            // Filtra solo attivi
            dipendentiAttuali = Object.keys(anagrafica).filter(d => anagrafica[d].type === 'active').sort();
            
            // Creazione menu selezione rapida
            const md = document.getElementById('dip-menu'); md.innerHTML = "";
            dipendentiAttuali.forEach(d => {
                md.innerHTML += `<div class="btn-dip" onclick="showDipDetail('${d}', this)">${d}</div>`;
            });
            
            loadData(currentDate);
        });
    }

    // --- CARICAMENTO DATI E CALCOLO ORE ---
    function loadData(date) { 
        db.ref('turni/' + date).once('value', snap => { 
            dailyData = snap.val() || {}; 
            
            // 1. Calcola le ore per ogni dipendente
            let dipStats = {};
            dipendentiAttuali.forEach(d => dipStats[d] = 0);

            for(let h=6; h<=22; h++) {
                for(let m=0; m<60; m+=15) {
                    if(h===22 && m>0) break;
                    let tStr = (h<10?'0':'')+h+':'+(m===0?'00':m);
                    
                    dipendentiAttuali.forEach(d => {
                        let comm = dailyData[`${tStr}-${d}-commessa`];
                        // Conta solo se c'√® una commessa E non √® PAUSA
                        if(comm && comm !== "PAUSA") {
                            dipStats[d] += 0.25; // Aggiungi 15 minuti
                        }
                    });
                }
            }

            renderHeaders(dipStats);
            renderTable(dipStats);            
            
            let b = document.querySelector('.btn-dip.selected'); 
            if(b) showDipDetail(b.innerText, b); 
        }); 
    }

    // --- RENDERIZZA INTESTAZIONI CON ORE E LARGHEZZA ---
    function renderHeaders(stats) {
        const h = document.getElementById('head-row'); 
        h.innerHTML = '<th class="col-ora">Ora</th>';
        
        dipendentiAttuali.forEach(d => {
            let color = dipColors[d] || colorStorico;
            let ore = stats[d];
            let hasWork = ore > 0;
            
            // Classe dinamica: active (largo) o inactive (stretto)
            let colClass = hasWork ? "col-active" : "col-inactive";
            
            // Testo intestazione: Nome + (Badge Ore se > 0, ma discreto)
            let label = d;
            if(hasWork) {
                label += `<span class="hours-badge">(${ore}h)</span>`;
            }

            h.innerHTML += `<th style="color:${color}" class="${colClass}">${label}</th>`;
        });
    }

    // --- RENDERIZZA TABELLA CON COLONNE DINAMICHE ---
    function renderTable(stats) {
        const tbody = document.getElementById('body-row'); tbody.innerHTML = ""; 
        let skip = new Array(dipendentiAttuali.length).fill(-1);
        
        for(let h=6; h<=22; h++) {
            for(let m=0; m<60; m+=15) {
                if(h===22 && m>0) break; let tVal = h*60+m; let tStr = (h<10?'0':'')+h+':'+(m===0?'00':m);
                let tr = document.createElement('tr'); tr.innerHTML = `<td class="col-ora">${tStr}</td>`;
                
                dipendentiAttuali.forEach((d, idx) => {
                    // Determina classe colonna (Larga o Stretta) basata sulle statistiche
                    let colClass = (stats[d] > 0) ? "col-active" : "col-inactive";

                    if(tVal < skip[idx]) return;
                    
                    let k = `${tStr}-${d}`; 
                    let rawComm = dailyData[k+'-commessa'] || ""; 
                    let note = dailyData[k+'-note'] || ""; 
                    let cliente = dailyData[k+'-cliente'] || "";
                    
                    // Logic Visibility Commessa X
                    let comm = rawComm;
                    if (comm === "" && (note !== "" || cliente !== "")) { comm = "COMMESSA X"; }

                    if(comm === "") {
                        // Cella Vuota
                        let td = document.createElement('td'); 
                        td.className = "no-select " + colClass; // Aggiungo classe larghezza
                        addTouchSupport(td, ()=>apriEditorVuoto(d, tStr)); 
                        tr.appendChild(td);
                    } else {
                        // Cella Piena (Task)
                        let span = 1; let nVal = tVal + 15;
                        while(true) {
                            let nh=Math.floor(nVal/60), nm=nVal%60; if(nh>22 || (nh===22 && nm>0)) break;
                            let nt = (nh<10?'0':'')+nh+':'+(nm===0?'00':nm); let nk = `${nt}-${d}`;
                            let nextRawComm = dailyData[nk+'-commessa'] || "";
                            let nextComm = nextRawComm;
                            if (nextComm === "" && ((dailyData[nk+'-note']||"") !== "" || (dailyData[nk+'-cliente']||"") !== "")) { nextComm = "COMMESSA X"; }

                            if(nextComm === comm && (dailyData[nk+'-note']||"")===note && (dailyData[nk+'-cliente']||"")===cliente) { span++; nVal+=15; } else break;
                        }
                        skip[idx] = tVal + (span * 15); 
                        let eh=Math.floor(nVal/60), em=nVal%60; let eStr=(eh<10?'0':'')+eh+':'+(em===0?'00':em);
                        
                        let dc = dipColors[d]||colorStorico; let bg = hexToRgba(dc, 0.1); let isP = comm==="PAUSA";
                        
                        let td = document.createElement('td'); 
                        td.rowSpan=span; 
                        td.className = "no-select " + colClass; // Aggiungo classe larghezza
                        
                        addTouchSupport(td, ()=>apriEditorPieno(d, tStr, eStr, rawComm, note));
                        td.innerHTML = `<div class="task-block${isP?' is-pausa':''}" ${isP?'':`style="border-color:${dc}; background:${bg};"`}>${cliente ? `<div class="task-client">${cliente}</div>` : ''}<div class="task-comm" ${isP?'':`style="color:${dc}"`}>${comm}</div>${note?`<div class="task-note">${note}</div>`:''}</div>`; 
                        tr.appendChild(td);
                    }
                });
                tbody.appendChild(tr);
            }
        }
    }

    // --- LE ALTRE FUNZIONI (Modali, WA, ecc.) RIMANGONO INVARIATE ---
    function apriGestione() { renderManageLists(); document.getElementById('modal-manage').style.display = 'flex'; }
    function renderManageLists() {
        const listAct = document.getElementById('list-active'); const listHist = document.getElementById('list-history');
        listAct.innerHTML = ""; listHist.innerHTML = "";
        Object.keys(anagrafica).sort().forEach(nome => {
            let data = anagrafica[nome]; let isAct = data.type === 'active'; let color = dipColors[nome] || '#ccc';
            let itemHTML = `<div class="item-dip"><div style="flex:1" onclick="apriAlias('${nome}')"><span style="color:${color}; font-weight:bold;">${nome}</span><div style="font-size:10px; color:#666;">Alias: ${data.aliases || '-'}</div></div><button class="btn-move" onclick="spostaDipendente('${nome}', '${isAct ? 'history' : 'active'}')">${isAct ? '‚û°' : '‚¨Ö'}</button></div>`;
            if(isAct) listAct.innerHTML += itemHTML; else listHist.innerHTML += itemHTML;
        });
    }
    function spostaDipendente(nome, destinazione) { anagrafica[nome].type = destinazione; db.ref('anagrafica').set(anagrafica); renderManageLists(); }
    
    function apriAlias(nome) {
        currentEditName = nome; let d = anagrafica[nome];
        document.getElementById('alias-title').innerText = "MODIFICA: " + nome;
        document.getElementById('alias-input').value = d.aliases || "";
        document.getElementById('alias-pausa-start').value = d.pausaStart || "";
        document.getElementById('alias-pausa-end').value = d.pausaEnd || "";
        document.getElementById('alias-assunzione').value = d.assunzione || "";
        document.getElementById('alias-cessazione').value = d.cessazione || "";
        document.getElementById('alias-note').value = d.note || "";
        document.getElementById('alias-popup').style.display = 'block';
    }
    
    function salvaAlias() {
        let a = document.getElementById('alias-input').value; let s = document.getElementById('alias-assunzione').value; let c = document.getElementById('alias-cessazione').value; let n = document.getElementById('alias-note').value;
        let ps = document.getElementById('alias-pausa-start').value; let pe = document.getElementById('alias-pausa-end').value;
        anagrafica[currentEditName].aliases = a; anagrafica[currentEditName].assunzione = s; anagrafica[currentEditName].cessazione = c; anagrafica[currentEditName].note = n;
        anagrafica[currentEditName].pausaStart = ps; anagrafica[currentEditName].pausaEnd = pe;
        db.ref('anagrafica').set(anagrafica); document.getElementById('alias-popup').style.display = 'none'; renderManageLists();
    }

    function initDate() { const s = document.getElementById('weekSelect'); for(let i=1; i<=53; i++) { s.innerHTML += `<option value="${i}">W ${i}</option>`; } let now = new Date(); s.value = getWeekNumber(now); cambiaSettimana(s.value); updateAllDateInputs(currentDate); }
    function updateAllDateInputs(d) { currentDate = d; document.getElementById('mobileDatePicker').value = d; document.getElementById('hiddenDate').value = d; document.getElementById('desktopDatePicker').value = d; const dateObj = new Date(d); const optionsDesk = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }; document.getElementById('deskDateLabel').innerText = dateObj.toLocaleDateString('it-IT', optionsDesk); }
    function getWeekNumber(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d - yearStart) / 86400000) + 1)/7); }
    function getDateOfISOWeek(w, y) { var d = new Date(y, 0, 4, 12, 0, 0); var dayNum = d.getDay() || 7; var diff = (w - 1) * 7; d.setDate(d.getDate() - dayNum + 1 + diff); return d; }
    function cambiaSettimana(w) { let currentY = parseInt(currentDate.split('-')[0]); let d = getDateOfISOWeek(w, currentY); const c = document.getElementById('day-container'); c.innerHTML = ""; for(let i=0; i<6; i++) { let temp = new Date(d); temp.setDate(d.getDate()+i); let val = temp.toISOString().split('T')[0]; let label = temp.toLocaleDateString('it-IT', {weekday:'short', day:'numeric'}); c.innerHTML += `<button class="day-btn${val===currentDate?' selected':''}" onclick="selectDay('${val}', this)">${label.toUpperCase()}</button>`; } }
    function selectDay(d, btn) { updateAllDateInputs(d); document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('selected')); if(btn) btn.classList.add('selected'); loadData(d); }
    function cambiaGiorno(delta) { let d = new Date(currentDate); d.setDate(d.getDate() + delta); selectDay(d.toISOString().split('T')[0], null); }

    function apriPulisciAvanzato() {
        const container = document.getElementById('clean-checklist'); container.innerHTML = "";
        let allWrap = document.createElement('label'); allWrap.className = 'check-item'; allWrap.style.gridColumn = "1 / -1"; allWrap.style.borderBottom = "1px solid #333"; allWrap.style.paddingBottom = "5px"; allWrap.innerHTML = `<input type="checkbox" id="check-all" onchange="toggleAllChecks(this)"> SELEZIONA TUTTI`; container.appendChild(allWrap);
        dipendentiAttuali.forEach(d => { let label = document.createElement('label'); label.className = 'check-item'; label.innerHTML = `<input type="checkbox" class="dip-check" value="${d}"> ${d}`; container.appendChild(label); });
        document.getElementById('clean-start').value = currentDate; document.getElementById('clean-end').value = currentDate; document.getElementById('modal-clean-adv').style.display = 'flex';
    }
    function toggleAllChecks(source) { document.querySelectorAll('.dip-check').forEach(cb => cb.checked = source.checked); }
    async function eseguiPuliziaAvanzata() {
        let selectedDips = []; document.querySelectorAll('.dip-check:checked').forEach(cb => selectedDips.push(cb.value)); if(selectedDips.length === 0) return alert("Seleziona almeno un dipendente!");
        let startStr = document.getElementById('clean-start').value; let endStr = document.getElementById('clean-end').value; if(!startStr || !endStr) return alert("Date mancanti!"); if(endStr < startStr) return alert("Data fine precedente a inizio!");
        if(!confirm(`Vuoi cancellare i dati per ${selectedDips.length} dipendenti\ndal ${startStr} al ${endStr}?`)) return;
        let startDt = new Date(startStr); let endDt = new Date(endStr); let updates = {};
        for(let d = new Date(startDt); d <= endDt; d.setDate(d.getDate() + 1)) {
            let dateKey = d.toISOString().split('T')[0];
            selectedDips.forEach(dip => {
                for(let h=6; h<=22; h++) { for(let m=0; m<60; m+=15) { if(h===22 && m>0) break; let tm = (h<10?'0':'')+h+':'+(m===0?'00':m); let baseKey = `turni/${dateKey}/${tm}-${dip}`; updates[baseKey+'-commessa'] = null; updates[baseKey+'-cliente'] = null; updates[baseKey+'-note'] = null; updates[baseKey+'-qta'] = null; updates[baseKey+'-voto'] = null; } }
            });
        }
        await db.ref().update(updates); alert("Pulizia Completata!"); document.getElementById('modal-clean-adv').style.display = 'none'; loadData(currentDate);
    }

    function addTouchSupport(el, cb) { el.ondblclick=cb; let lt=0, pt; el.addEventListener('touchstart',e=>{pt=setTimeout(()=>{if(navigator.vibrate)navigator.vibrate(50);cb()},800)},{passive:true}); el.addEventListener('touchend',e=>{clearTimeout(pt);let t=new Date().getTime();if(t-lt<300&&t-lt>0){e.preventDefault();cb()}lt=t}); el.addEventListener('touchmove',()=>clearTimeout(pt)); }
    
    function inserisciPausaConTaglio() {
        let s = document.getElementById('edit-start').value; let e = document.getElementById('edit-end').value; let cl = document.getElementById('edit-cliente').value; let c = document.getElementById('edit-commessa').value; let n = document.getElementById('edit-note').value;
        let startMins = toMins(s); let endMins = toMins(e); 
        let empData = anagrafica[editDip] || {};
        let pStartStr = empData.pausaStart || "12:00"; let pEndStr = empData.pausaEnd || "13:00";
        let pausaStart = toMins(pStartStr); let pausaEnd = toMins(pEndStr);
        if (endMins <= startMins) return alert("Orari non validi");
        let updates = {};
        for(let m = startMins; m < endMins; m += 15) { let t = toTimeStr(m); let base = `turni/${currentDate}/${t}-${editDip}`; updates[base+'-commessa'] = null; updates[base+'-cliente'] = null; updates[base+'-note'] = null; }
        if (startMins < pausaStart) { for(let m = startMins; m < Math.min(endMins, pausaStart); m += 15) { let t = toTimeStr(m); let base = `turni/${currentDate}/${t}-${editDip}`; updates[base+'-commessa'] = c; updates[base+'-cliente'] = cl; updates[base+'-note'] = n; } }
        for(let m = pausaStart; m < pausaEnd; m += 15) { let t = toTimeStr(m); let base = `turni/${currentDate}/${t}-${editDip}`; updates[base+'-commessa'] = "PAUSA"; updates[base+'-cliente'] = ""; updates[base+'-note'] = "Pausa Pranzo"; }
        if (endMins > pausaEnd) { for(let m = Math.max(startMins, pausaEnd); m < endMins; m += 15) { let t = toTimeStr(m); let base = `turni/${currentDate}/${t}-${editDip}`; updates[base+'-commessa'] = c; updates[base+'-cliente'] = cl; updates[base+'-note'] = n; } }
        db.ref().update(updates, () => { document.getElementById('modal-edit').style.display = 'none'; loadData(currentDate); });
    }
    function setPausaPranzo() { inserisciPausaConTaglio(); }





    // --- FUNZIONI MANCANTI PER APRIRE IL MODALE ---

function apriEditorVuoto(dip, oraInizio) {
    // Imposta variabili globali per il salvataggio
    editDip = dip;
    editOriginalStart = ""; // Segnala che √® un nuovo inserimento
    editOriginalEnd = "";

    // Titolo del modale
    document.getElementById('edit-dip-title').innerText = "NUOVO INSERIMENTO: " + dip;
    document.getElementById('edit-dip-title').style.borderBottomColor = dipColors[dip] || "#fff";

    // Resetta i campi input
    document.getElementById('edit-cliente').value = "";
    document.getElementById('edit-commessa').value = "";
    document.getElementById('edit-note').value = "";
    document.getElementById('edit-qta').value = "";
    document.getElementById('edit-voto').value = "";

    // Imposta orari (Default: Inizio = ora cliccata, Fine = +1 ora)
    document.getElementById('edit-start').value = oraInizio;
    
    // Calcolo automatico ora fine (+1 ora)
    let [h, m] = oraInizio.split(':').map(Number);
    let endMins = (h * 60 + m) + 60;
    let he = Math.floor(endMins / 60);
    let me = endMins % 60;
    // Formatta HH:MM
    let oraFine = (he < 10 ? '0' : '') + he + ':' + (me === 0 ? '00' : me);
    
    // Se supera le 22:15, tappa al massimo orario disponibile
    if (he >= 22 && me > 0) oraFine = "22:15";
    
    // Se il valore calcolato esiste nella select, lo imposta, altrimenti mette il valore pi√π vicino
    let selectEnd = document.getElementById('edit-end');
    if (selectEnd.querySelector(`option[value="${oraFine}"]`)) {
        selectEnd.value = oraFine;
    } else {
        selectEnd.value = "22:15"; 
    }

    // Mostra il modale
    document.getElementById('modal-edit').style.display = 'flex';
}

function apriEditorPieno(dip, start, end, comm, note) {
    // Imposta variabili globali per permettere la modifica/cancellazione
    editDip = dip;
    editOriginalStart = start;
    editOriginalEnd = end;

    // Recupera dati aggiuntivi dalla memoria locale (dailyData)
    let baseKey = `${start}-${dip}`;
    let cliente = dailyData[baseKey + '-cliente'] || "";
    let qta = dailyData[baseKey + '-qta'] || "";
    let voto = dailyData[baseKey + '-voto'] || "";

    // Popola i campi del modale
    document.getElementById('edit-dip-title').innerText = "MODIFICA: " + dip;
    document.getElementById('edit-dip-title').style.borderBottomColor = dipColors[dip] || "#fff";
    
    document.getElementById('edit-start').value = start;
    document.getElementById('edit-end').value = end;
    
    document.getElementById('edit-cliente').value = cliente;
    // Se √® "COMMESSA X" (placeholder) o "PAUSA", pulisci il campo per permettere modifica rapida
    document.getElementById('edit-commessa').value = (comm === "COMMESSA X" || comm === "PAUSA") ? "" : comm;
    document.getElementById('edit-note').value = note || "";
    document.getElementById('edit-qta').value = qta;
    document.getElementById('edit-voto').value = voto;

    // Mostra il modale
    document.getElementById('modal-edit').style.display = 'flex';
}




















































































    function salvaTaskAvanzato() {
        let s=document.getElementById('edit-start').value, e=document.getElementById('edit-end').value, cl=document.getElementById('edit-cliente').value, c=document.getElementById('edit-commessa').value, n=document.getElementById('edit-note').value;
        let sm=toMins(s), em=toMins(e); if(em<=sm) return alert("Orari errati!");
        let u={};
        if(editOriginalStart) { let os=toMins(editOriginalStart), oe=toMins(editOriginalEnd); for(let m=os; m<oe; m+=15) { let t=toTimeStr(m), b=`turni/${currentDate}/${t}-${editDip}`; u[b+'-commessa']=null; u[b+'-cliente']=null; u[b+'-note']=null; u[b+'-qta']=null; u[b+'-voto']=null; delete dailyData[b+'-commessa']; delete dailyData[b+'-note']; } }
        for(let m=sm; m<em; m+=15) { let t=toTimeStr(m), b=`turni/${currentDate}/${t}-${editDip}`; u[b+'-commessa']=c; u[b+'-cliente']=cl; u[b+'-note']=n; u[b+'-qta']=document.getElementById('edit-qta').value; u[b+'-voto']=document.getElementById('edit-voto').value; dailyData[b+'-commessa']=c; dailyData[b+'-cliente']=cl; dailyData[b+'-note']=n; }
        db.ref().update(u, ()=>{ document.getElementById('modal-edit').style.display='none'; loadData(currentDate); });
    }
    function eliminaTask() { if(!editOriginalStart) return; if(!confirm("Eliminare?")) return; let u={}, os=toMins(editOriginalStart), oe=toMins(editOriginalEnd); for(let m=os; m<oe; m+=15) { let t=toTimeStr(m), b=`turni/${currentDate}/${t}-${editDip}`; u[b+'-commessa']=null; u[b+'-cliente']=null; u[b+'-note']=null; } db.ref().update(u, ()=>{ document.getElementById('modal-edit').style.display='none'; loadData(currentDate); }); }
    







    
    // --- FUNZIONE PER LA VISTA DIPENDENTI (LISTA) ---
function showDipDetail(nome, btn) {
    // 1. Gestione estetica bottone selezionato
    document.querySelectorAll('.btn-dip').forEach(b => b.classList.remove('selected'));
    if(btn) {
        btn.classList.add('selected');
    } else {
        // Se la funzione √® chiamata senza btn, cercalo
        let found = Array.from(document.querySelectorAll('.btn-dip')).find(b => b.innerText === nome);
        if(found) found.classList.add('selected');
    }

    const container = document.getElementById('dip-detail-container');
    container.innerHTML = ""; // Pulisce la schermata precedente

    let color = dipColors[nome] || "#777";
    let totalOre = 0;
    
    // Creiamo il contenitore principale (Card)
    let cardWrapper = document.createElement('div');
    cardWrapper.className = 'dip-card-wrapper';
    cardWrapper.style.borderTop = `5px solid ${color}`;
    cardWrapper.style.width = "95%";
    cardWrapper.style.maxWidth = "600px";
    cardWrapper.style.marginTop = "20px";

    // Intestazione con Nome e Totale Ore
    let headerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
            <h2 style="margin:0; color:${color}; text-transform:uppercase; letter-spacing:1px;">${nome}</h2>
            <div id="total-hours-display" style="font-size:20px; font-weight:bold; color:white;">0h</div>
        </div>
        <div id="dip-timeline-list" style="display:flex; flex-direction:column; gap:10px;"></div>
    `;
    cardWrapper.innerHTML = headerHTML;
    container.appendChild(cardWrapper);

    const listContainer = cardWrapper.querySelector('#dip-timeline-list');
    
    // 2. Algoritmo per raggruppare i task (simile alla tabella ma verticale)
    let currentBlock = null;

    for(let h=6; h<=22; h++) {
        for(let m=0; m<60; m+=15) {
            if(h===22 && m>0) break;
            
            let tStr = (h<10?'0':'')+h+':'+(m===0?'00':m);
            let key = `${tStr}-${nome}`;
            
            let rawComm = dailyData[key+'-commessa'];
            let comm = rawComm; // Valore grezzo
            let note = dailyData[key+'-note'] || "";
            let cliente = dailyData[key+'-cliente'] || "";

            // Normalizza i dati
            if (!comm && (note !== "" || cliente !== "")) { comm = "COMMESSA X"; }

            // Calcolo Ore (escludendo la pausa)
            if (comm && comm !== "PAUSA") totalOre += 0.25;

            // Logica di raggruppamento blocchi
            if (comm) {
                if (!currentBlock) {
                    // Inizio nuovo blocco
                    currentBlock = { start: tStr, end: tStr, comm: comm, note: note, cliente: cliente, raw: rawComm };
                } else {
                    // Controlla se √® lo stesso task del blocco precedente
                    if (currentBlock.comm === comm && currentBlock.note === note && currentBlock.cliente === cliente) {
                        // Estende il blocco
                        currentBlock.end = tStr; 
                    } else {
                        // Il task √® cambiato: chiudi il precedente e aprine uno nuovo
                        renderDipBlock(listContainer, currentBlock, nome, color);
                        currentBlock = { start: tStr, end: tStr, comm: comm, note: note, cliente: cliente, raw: rawComm };
                    }
                }
            } else {
                // Slot vuoto: se c'era un blocco aperto, chiudilo
                if (currentBlock) {
                    renderDipBlock(listContainer, currentBlock, nome, color);
                    currentBlock = null;
                }
            }
        }
    }
    // Chiudi eventuale blocco rimasto aperto alla fine della giornata
    if (currentBlock) {
        renderDipBlock(listContainer, currentBlock, nome, color);
    }

    // Aggiorna il testo delle ore totali
    cardWrapper.querySelector('#total-hours-display').innerText = totalOre + "h";
}

// Funzione ausiliaria per disegnare il singolo blocco nella lista
function renderDipBlock(container, block, nome, color) {
    // Calcola l'orario di fine reale (l'ultimo slot dura 15 min, quindi aggiungiamo 15 min all'orario di fine)
    let [h, m] = block.end.split(':').map(Number);
    let endMins = h * 60 + m + 15;
    let he = Math.floor(endMins / 60);
    let me = endMins % 60;
    let finalEnd = (he < 10 ? '0' : '') + he + ':' + (me === 0 ? '00' : me);

    let isPausa = block.comm === "PAUSA";
    
    // Stile dinamico
    let bg = isPausa ? 
        "repeating-linear-gradient(45deg, #222, #222 10px, #2a2a2a 10px, #2a2a2a 20px)" : 
        `rgba(30, 30, 30, 0.8)`; // Sfondo scuro pulito
    
    let borderColor = isPausa ? "#555" : color;
    let textColor = isPausa ? "#777" : "white";

    let item = document.createElement('div');
    item.style.cssText = `
        background: ${bg}; 
        border-left: 5px solid ${borderColor}; 
        border-radius: 6px; 
        padding: 12px; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        cursor: pointer;
        transition: transform 0.1s;
    `;
    
    // Aggiungi effetto click
    item.onmouseover = () => item.style.transform = "scale(1.01)";
    item.onmouseout = () => item.style.transform = "scale(1)";
    
    // CLICK: Apre il modale di modifica (usa le funzioni che ti ho dato nella risposta precedente)
    item.onclick = () => apriEditorPieno(nome, block.start, finalEnd, block.raw, block.note);

    let html = `
        <div style="display:flex; justify-content:space-between; font-size:13px; color:#888; margin-bottom:5px;">
            <span style="font-family:monospace; font-size:14px;">üïí ${block.start} - ${finalEnd}</span>
            <span style="font-style:italic;">${block.cliente}</span>
        </div>
        <div style="font-size:16px; font-weight:bold; color:${isPausa ? '#aaa' : color}; margin-bottom:2px;">
            ${block.comm}
        </div>
    `;
    
    if(block.note) {
        html += `<div style="font-size:13px; color:#ccc; border-top:1px solid #333; margin-top:5px; padding-top:5px;">${block.note}</div>`;
    }

    item.innerHTML = html;
    container.appendChild(item);
}
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    function apriWA() { document.getElementById('modal-wa').style.display='flex'; document.getElementById('wa-date').value=currentDate; }
    function analizzaWA() { 
        let txt = document.getElementById('wa-input').value; let dateRef = document.getElementById('wa-date').value; let dArr = dateRef.split('-'); let visualDate = `${dArr[2]}/${dArr[1]}/${dArr[0]}`; let tbody = document.getElementById('wa-tbody'); tbody.innerHTML = ""; let lines = txt.split('\n').map(l=>l.trim()).filter(l=>l!==''); let curDip = null; let buffer = []; waBlocks = []; 
        lines.forEach(l => { let found = Object.keys(anagrafica).find(k => { let d = anagrafica[k]; if(k.toUpperCase() === l.toUpperCase()) return true; if(d.aliases) { let aliasList = d.aliases.toUpperCase().split(',').map(a=>a.trim()); if(aliasList.includes(l.toUpperCase())) return true; } return false; }); if(found) { if(curDip && buffer.length) processBuffer(curDip, buffer); curDip = found; buffer = []; } else if(curDip) buffer.push(l); }); 
        if(curDip && buffer.length) processBuffer(curDip, buffer); 
        waBlocks.forEach((b) => { tbody.innerHTML += `<tr><td style="color:#00ff88; font-weight:bold;">${visualDate}</td><td style="text-align:center;"><button class="btn-del-row" onclick="this.closest('tr').remove()">‚úñ</button></td><td><input class="wa-inp" name="dip" value="${b.dip}" readonly style="font-weight:bold; color:${dipColors[b.dip]};"></td><td><input class="wa-inp" name="start" value="${b.start}"></td><td><input class="wa-inp" name="end" value="${b.end}"></td><td><input class="wa-inp" name="comm" value="${b.comm}"></td><td><input class="wa-inp" name="desc" value="${b.desc}"></td><td><input class="wa-inp" name="qta" value="${b.qta}"></td><td><input class="wa-inp" name="vote" value="${b.vote}"></td></tr>`; }); 
    }
    function processBuffer(dip, lines) { let i = 0; while(i < lines.length) { let sIdx = -1; for(let j=i; j<lines.length-1; j++) { if(isTime(lines[j]) && isTime(lines[j+1])) { sIdx = j; break; } } if(sIdx === -1) break; let start = normalizeTime(lines[sIdx]); let end = normalizeTime(lines[sIdx+1]); let rawData = lines.slice(i, sIdx); let comm = rawData[0] || ""; let qta = "", desc = ""; for(let k=1; k<rawData.length; k++) { let l = rawData[k]; if(l.match(/(\d+)\s*(pz|pezzi|x)/i) || l.match(/^x\d+$/i) || (!isNaN(l) && l.length<4)) qta=l; else desc += (desc?" ":"") + l; } let vote = ""; let next = sIdx + 2; if(next < lines.length && lines[next].toUpperCase().startsWith("VOTO")) { vote = lines[next].replace(/VOTO:?/i, "").trim(); next++; } waBlocks.push({ dip, start, end, comm, desc, qta, vote }); i = next; } }
    function confermaWA() { if(!confirm("Inviare?")) return; let date = document.getElementById('wa-date').value; let u = {}; document.querySelectorAll('#wa-tbody tr').forEach(row => { let dip = row.querySelector('input[name="dip"]').value; let start = row.querySelector('input[name="start"]').value; let end = row.querySelector('input[name="end"]').value; let comm = row.querySelector('input[name="comm"]').value; let desc = row.querySelector('input[name="desc"]').value; let qta = row.querySelector('input[name="qta"]').value; let vote = row.querySelector('input[name="vote"]').value; let sm = toMins(start); let em = toMins(end); for(let m=sm; m<em; m+=15) { let t = toTimeStr(m); let base = `turni/${date}/${t}-${dip}`; u[base + '-commessa'] = comm; u[base + '-note'] = desc; u[base + '-qta'] = qta; u[base + '-voto'] = vote; } }); db.ref().update(u, () => { alert("OK!"); document.getElementById('modal-wa').style.display='none'; currentDate = date; document.getElementById('hiddenDate').value = date; document.getElementById('mobileDatePicker').value = date; loadData(currentDate); }); }
    function isTime(s){return /^\d{1,2}([.:]\d{2})?$/.test(s);}
    function normalizeTime(t){ if(typeof t === 'number') { let totalM = Math.round(t * 24 * 60); let h = Math.floor(totalM/60); let m = totalM%60; return (h<10?'0':'')+h+':'+(m<10?'0':'')+m; } t=t.toString().replace(',','.'); if(!t.includes(':')&&!t.includes('.'))t+=":00"; t=t.replace('.',':'); let p=t.split(':'); if(p[0].length==1)p[0]="0"+p[0]; return p.join(':');}
    function toMins(t){let p=t.split(':'); return parseInt(p[0])*60+parseInt(p[1]);}
    function toTimeStr(m){let h=Math.floor(m/60),mn=m%60; return (h<10?'0':'')+h+':'+(mn<10?'0':'')+mn;}
    function hexToRgba(hex, alpha) { let r=0, g=0, b=0; if(hex.length == 7) { r = parseInt(hex.slice(1,3), 16); g = parseInt(hex.slice(3,5), 16); b = parseInt(hex.slice(5,7), 16); } return `rgba(${r},${g},${b},${alpha})`; }
    function clickCell(td) { if(currentCell) currentCell.classList.remove('selected-cell'); currentCell = td; td.classList.add('selected-cell'); }
    function editCell(td) { clickCell(td); const pop = document.getElementById('editor-popup'); const txt = document.getElementById('editor-txt'); txt.value = td.querySelector('.task-block') ? td.querySelector('.task-comm').innerText : td.innerText; let rect = td.getBoundingClientRect(); pop.style.top = (rect.top + window.scrollY) + 'px'; pop.style.left = (rect.left + window.scrollX) + 'px'; pop.style.display = 'block'; txt.focus(); }
    function salvaEditor() { if(!currentCell) return; let val = document.getElementById('editor-txt').value; let key = currentCell.id.replace('MAIN-', ''); let dip = key.split('-')[1]; let span = currentCell.rowSpan; if(span > 1) { let [startH, startM] = key.split('-')[0].split(':').map(Number); let startMins = startH * 60 + startM; for(let i=0; i<span; i++) { let mVal = startMins + (i*15); let h = Math.floor(mVal/60); let m = mVal%60; let tStr = (h<10?'0':'')+h+':'+(m===0?'00':m); let k = `${tStr}-${dip}-commessa`; db.ref('turni/' + currentDate + '/' + k).set(val); dailyData[k] = val; } } else { db.ref('turni/' + currentDate + '/' + key).set(val); dailyData[key] = val; } document.getElementById('editor-popup').style.display = 'none'; renderTable(); }
    function cambiaVista(v) { document.getElementById('view-tabellone').style.display = v==='tabellone'?'block':'none'; document.getElementById('view-dipendente').style.display = v==='dipendente'?'block':'none'; document.getElementById('dip-menu').className = v==='dipendente'?'scroll-dip visible':'scroll-dip'; document.getElementById('btn-tab').className = v==='tabellone'?'view-btn selected':'view-btn'; document.getElementById('btn-dip').className = v==='dipendente'?'view-btn selected':'view-btn'; }
</script>
</body>
</html>