<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Commesse - Gestionale V3.2 (Sandbox)</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #111; color: white; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        
        /* HEADER BAR */
        .header-bar { padding: 10px 15px; background: #1a1a1a; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 20px; flex-shrink: 0; }
        .btn-back { background: transparent; border: 1px solid #666; color: #ccc; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; transition: 0.2s; }
        .btn-back:hover { border-color: white; color: white; }

        /* BARRA CLIENTI */
        .clients-scroll { display: flex; gap: 10px; overflow-x: auto; flex: 1; align-items: center; padding-bottom: 5px; }
        .clients-scroll::-webkit-scrollbar { height: 4px; }
        .clients-scroll::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }
        .btn-client { padding: 8px 25px; background: transparent; border: 1px solid rgba(255,255,255,0.3); color: #fff; border-radius: 25px; cursor: pointer; white-space: nowrap; transition: all 0.3s ease; font-family: 'Segoe UI Light', sans-serif; font-size: 14px; letter-spacing: 0.5px; }
        .btn-client:hover { border-color: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.2); }
        .btn-client.selected { background: transparent; border-color: #00ff88; color: #00ff88; box-shadow: 0 0 15px rgba(0, 255, 136, 0.4), inset 0 0 5px rgba(0, 255, 136, 0.1); font-weight: 600; }
        
        /* PULSANTE GESTISCI */
        .btn-manage { background: #222; border: 1px solid #00e5ff; color: #00e5ff; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 12px; text-transform: uppercase; margin-left: 10px; }
        .btn-manage:hover { background: #00e5ff; color: #000; }

        #workspace { flex: 1; display: none; flex-direction: column; overflow: hidden; }
        .tabs { display: flex; justify-content: center; padding: 10px; gap: 10px; background: #111; }
        .tab-btn { padding: 8px 30px; background: transparent; border: 1px solid #444; color: #777; border-radius: 20px; cursor: pointer; font-size: 12px; transition: 0.2s;}
        .tab-btn:hover { border-color: #666; color: #aaa; }
        .tab-btn.active { background: #fff; color: #000; font-weight: bold; border-color: #fff; }
        
        .kanban { display: flex; overflow-x: auto; gap: 15px; padding: 10px 20px; height: 100%; align-items: flex-start; }
        .col { min-width: 300px; width: 300px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); border-radius: 15px; display: flex; flex-direction: column; max-height: 100%; }
        .col-head { padding: 15px; text-align: center; font-weight: 300; color: #0994E6; border-bottom: 1px solid rgba(255,255,255,0.05); letter-spacing: 1px; font-size: 16px; text-transform: uppercase; font-family: 'Segoe UI Light', sans-serif; text-shadow: 0 0 10px rgba(9, 148, 230, 0.3); }
        .col-body { padding: 10px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 10px; }
        
        /* CARD */
        .card { background: linear-gradient(145deg, #252525, #1e1e1e); border: 1px solid rgba(255,255,255,0.5); border-radius: 15px; padding: 12px; cursor: pointer; position: relative; transition: all 0.2s ease; box-shadow: 0 0 10px rgba(255,255,255,0.05); min-height: 100px; display: flex; flex-direction: column; justify-content: space-between; }
        .card:hover { transform: translateY(-3px); border-color: white; box-shadow: 0 0 15px rgba(255,255,255,0.2); }
        .card-details { padding: 0 0 5px 0; font-size: 12px; color: #fff; font-weight: 300; display: flex; align-items: center; gap: 10px; opacity: 0.9; }
        .detail-sep { color: #555; font-size: 10px; }
        .card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .card-title { font-size: 15px; font-weight: normal; color: #fff; text-transform: uppercase; line-height: 1.1; flex: 1; padding-right: 5px; font-family: 'Segoe UI', sans-serif; letter-spacing: 0.5px; }
        .card-badge { background: transparent; border: 1px solid #00ff88; color: #00ff88; padding: 2px 8px; border-radius: 8px; font-size: 11px; font-weight: normal; white-space: nowrap; box-shadow: 0 0 5px rgba(0, 255, 136, 0.2); }
        .card-foot { display: flex; justify-content: space-between; align-items: center; padding-top: 8px; }
        .btn-group-right { display: flex; gap: 5px; }
        .btn-mini { width: 26px; height: 26px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #ccc; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; font-size: 12px; font-weight: bold; }
        .btn-mini:hover { background: rgba(255,255,255,0.15); color: white; border-color: white; }
        .btn-del { color: #e74c3c; border-color: rgba(231, 76, 60, 0.3); } .btn-del:hover { background: rgba(231, 76, 60, 0.2); border-color: #e74c3c; color: #e74c3c; }
        .btn-move { color: #3498db; border-color: rgba(52, 152, 219, 0.3); } .btn-move:hover { background: rgba(52, 152, 219, 0.2); border-color: #3498db; color: #3498db; }

        /* ARCHIVIO STYLES */
        .archive-list { padding: 20px; overflow-y: auto; }
        .arch-item { background: #222; border: 1px solid #333; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; align-items: center; gap: 20px; }
        .arch-img { width: 80px; height: 80px; background: white; border-radius: 5px; object-fit: contain; }
        .arch-info { flex: 1; }
        .arch-actions { display: flex; gap: 10px; }
        .btn-glass { padding: 8px 15px; border-radius: 8px; border: 1px solid #444; background: rgba(255,255,255,0.05); color: white; cursor: pointer; font-weight: bold; font-size: 12px; transition: 0.2s;}
        .btn-glass:hover { transform: translateY(-2px); }
        .green { border-color: #27ae60; color: #27ae60; } .green:hover { background: rgba(39, 174, 96, 0.2); }
        .yellow { border-color: #f1c40f; color: #f1c40f; } .yellow:hover { background: rgba(241, 196, 15, 0.2); }
        .red { border-color: #e74c3c; color: #e74c3c; } .red:hover { background: rgba(231, 76, 60, 0.2); }
        
        .btn-add-archive { width: 100%; padding: 15px; background: rgba(255,255,255,0.1); border: 1px dashed rgba(255,255,255,0.3); color: #ccc; border-radius: 10px; cursor: pointer; margin-bottom: 20px; font-weight: bold; font-size:16px; text-transform:uppercase; transition: 0.2s; }
        .btn-add-archive:hover { border-color: white; color: white; background: rgba(255,255,255,0.15); }

        /* MODALE & DETTAGLI */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #181818; width: 95%; height: 95%; border: 1px solid #333; border-radius: 15px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        
        /* HEADER MODALE DETTAGLIO */
        .modal-head { padding: 25px 30px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #111; }
        .mh-left { display: flex; align-items: center; gap: 25px; }
        .mh-icon { font-size: 50px; display:flex; align-items:center; } 
        .mh-info { display: flex; gap: 20px; font-size: 18px; font-family: 'Segoe UI', sans-serif; color: white; }
        .mh-label { color: #bbb; font-size: 16px; margin-right: 5px; font-weight: 300; }
        .mh-val { font-weight: 400; font-size: 20px; }
        .mh-right { display: flex; align-items: center; gap: 10px; }
        .mh-order-label { color: #fff; font-size: 24px; font-family: 'Segoe UI', sans-serif; font-weight: 300; }
        .btn-close-modal { background: transparent; border: 1px solid #444; color: #888; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; font-size: 14px; margin-left: 20px; display: flex; align-items: center; justify-content: center;}
        .btn-close-modal:hover { border-color: white; color: white; }

        .modal-body { display: flex; flex: 1; overflow: hidden; gap: 20px; padding: 20px; }
        .col-distinta { flex: 3; display: flex; flex-direction: column; overflow: hidden; }
        .col-fasi { flex: 1; border: none; padding: 0; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; max-width: 350px; }

        .stage-box { background: rgba(9, 148, 230, 0.05); border: 1px solid #0994E6; border-radius: 8px; padding: 15px; box-shadow: 0 0 10px rgba(9, 148, 230, 0.1); }
        .stage-title { color: #0994E6; font-weight: 400; font-size: 14px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid rgba(9, 148, 230, 0.3); padding-bottom: 5px; display: flex; justify-content: space-between; }

        .distinta-list-container { width: 100%; height: 100%; overflow-y: auto; overflow-x: auto; border: 1px solid #333; border-radius: 8px; background: rgba(0,0,0,0.3); }
        .distinta-grid-layout { display: grid; grid-template-columns: 40px 30px 50px 100px 100px 100px 50px 60px 70px 80px 50px 1fr 100px; gap: 5px; align-items: center; min-width: 1200px; }
        .distincta-header-row { font-size: 12px; font-weight: 400; color: #ccc; text-transform: uppercase; padding: 10px 5px; border-bottom: 1px solid #444; background: #1a1a1a; position: sticky; top: 0; z-index: 10; text-align: center; }
        .distinta-row-item { display: grid; grid-template-columns: 40px 30px 50px 100px 100px 100px 50px 60px 70px 80px 50px 1fr 100px; gap: 5px; align-items: center; background: rgba(255,255,255,0.02); border-bottom: 1px solid #222; padding: 8px 5px; transition: 0.2s; min-width: 1200px; font-family: 'Segoe UI', sans-serif; font-size: 13px; color: #ddd; text-align: center; }
        .distinta-row-item:hover { background: rgba(255,255,255,0.05); }
        .distinta-row-item.checked { border-left: 3px solid #27ae60; background: rgba(39, 174, 96, 0.05); }

        .d-cell { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .d-cell.left { text-align: left; padding-left: 5px; }
        
        .check-box { width: 18px; height: 18px; border: 1px solid #666; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin: 0 auto; }
        .checked .check-box { background: #27ae60; border-color: #27ae60; color: white; }
        .checked .check-box::after { content: '‚úì'; font-size: 12px; font-weight: bold; }
        
        .part-icon-thumb { width: 35px; height: 35px; object-fit: contain; background: #fff; border-radius: 4px; margin: 0 auto; display: block; }
        .part-icon-placeholder { width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; background: #333; border: 1px solid #555; border-radius: 4px; font-size: 18px; margin: 0 auto; color: #777; }
        
        .inp-mini { width: 100%; background: transparent; border: 1px solid #444; color: white; text-align: center; padding: 4px; border-radius: 4px; font-family: inherit; }
        .inp-mini:focus { border-color: #0994E6; outline: none; }

        .chk-row { 
            display: grid; 
            grid-template-columns: 30px 1fr; 
            gap: 10px; 
            align-items: center; 
            padding: 8px; 
            cursor: pointer; 
            font-size: 13px; 
            color: #ccc; 
            border-radius: 4px; 
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .chk-row:last-child { border-bottom: none; }
        .chk-row:hover { background: rgba(255,255,255,0.05); color: white; }
        
        #editor-popup { display: none; position: absolute; z-index: 1000; background: #1e1e1e; border: 2px solid var(--neon-green); border-radius: 8px; padding: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); width: 250px; }
        #editor-textarea { width: 100%; height: 100px; background: #111; color: white; border: 1px solid #444; border-radius: 4px; padding: 8px; font-family: inherit; font-size: 14px; resize: none; outline: none; }
        .btn-editor { padding: 5px 15px; border-radius: 4px; cursor: pointer; border: none; font-weight: bold; }

        /* MODALE ARTICOLO */
        .big-label { color: #888; font-size: 12px; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .big-input { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; }
        .article-grid { display: flex; gap: 20px; margin-bottom: 20px; }
        .art-img-box { width: 150px; height: 150px; border: 2px dashed #444; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 10px; position: relative; overflow: hidden; }
        .art-img-box:hover { border-color: #0994E6; }
        .art-img-prev { width: 100%; height: 100%; object-fit: contain; display: none; }
        .art-fields { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .comp-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .comp-table th { text-align: left; color: #0994E6; font-size: 12px; border-bottom: 1px solid #444; padding: 5px; }
        .comp-table td { border-bottom: 1px solid #222; padding: 5px; }
        .comp-table input { background: transparent; border: none; color: white; width: 100%; }
        .btn-add-comp { background: #333; color: white; border: 1px solid #555; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-top: 5px; }

        /* MODALE GESTIONE CLIENTI */
        .manage-box-modal { background: #181818; width: 800px; height: 600px; border: 1px solid #444; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.8); border-radius: 8px; overflow: hidden; }
        .manage-head { padding: 15px 20px; background: #111; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .manage-body { flex: 1; display: flex; padding: 20px; gap: 20px; overflow: hidden; }
        .manage-col { flex: 1; background: #111; border: 1px solid #333; display: flex; flex-direction: column; border-radius: 4px; }
        .col-title { padding: 10px; text-align: center; font-weight: bold; border-bottom: 1px solid #333; background: #1a1a1a; color: #aaa; text-transform: uppercase; font-size: 12px; }
        .col-list { flex: 1; overflow-y: auto; padding: 10px; }
        .manage-item { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 10px; margin-bottom: 5px; border-radius: 4px; border: 1px solid #333; }
        .manage-item:hover { border-color: #555; }
        .btn-arrow { background: #333; border: 1px solid #555; color: white; width: 30px; height: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 3px; }
        .btn-arrow:hover { background: #00e5ff; color:black; border-color: #00e5ff; }
        .btn-del { background: #2c0b0b; border: 1px solid #500; color: #f00; width: 30px; height: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 3px; margin-left: 5px; }
        .btn-del:hover { background: #f00; color: white; border-color: #f00; }
        .new-client-box { background: #222; border: 1px solid #444; padding: 15px; margin-top: auto; display: flex; gap: 10px; align-items: center; border-top: 1px solid #333; }
        .inp-new { background: #000; border: 1px solid #444; color: white; padding: 10px; flex: 1; border-radius: 4px; }
        .btn-save-new { background: #27ae60; color: white; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; text-transform: uppercase; }





















//===============================================================================
// SANDBOX STYLE // - INIZIO X PENSO FILE CSS
//===============================================================================















        /* SANDBOX STYLES (SOLO PROVA 1) */
        .sandbox-container { display:none; flex-direction:column; gap:20px; padding:10px; }
        .sandbox-box { border:1px solid #9b59b6; background:#16101a; border-radius:4px; margin-bottom:20px; }
        .sandbox-head { background:#2a1a35; padding:10px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #9b59b6; }
        .sandbox-title { color:#9b59b6; font-weight:bold; text-transform:uppercase; font-size:14px; }
        .sandbox-note { background:#111; border:1px solid #555; color:#ccc; padding:5px; width:250px; font-size:12px; }
        .sandbox-drop { border:2px dashed #9b59b6; color:#9b59b6; padding:15px; text-align:center; font-size:11px; margin:10px; cursor:pointer; background:rgba(155,89,182,0.05); }
        .sandbox-btn-add { background:#9b59b6; color:white; border:none; width:100%; padding:8px; font-weight:bold; cursor:pointer; margin-top:5px; text-transform:uppercase; }


/* --- STILI V4.3 (PROVA 1) --- */
    .sandbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; padding: 10px; }
    .sandbox-card { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 20px; display: flex; flex-direction: column; gap: 10px; height: 220px; justify-content: space-between; transition: 0.2s; cursor: pointer; position:relative; }
    .sandbox-card:hover { transform: translateY(-3px); border-color: #9b59b6; box-shadow: 0 5px 15px rgba(155, 89, 182, 0.1); }
    .sb-card-head { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 10px; }
    .sb-card-title { font-weight: bold; color: white; font-size: 16px; }
    .sb-card-badge { background: #2a1a35; color: #9b59b6; padding: 2px 8px; border-radius: 4px; font-size: 11px; border: 1px solid #9b59b6; }
    
    /* MODALE SMART PASTE */
    .p1-modal-grid { display: flex; gap: 20px; }
    .p1-img-area { width: 180px; height: 180px; border: 2px dashed #555; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-direction: column; cursor: pointer; background: #111; overflow: hidden; position: relative; }
    .p1-img-area:focus { border-color: #00ff88; outline: none; }
    .p1-img-prev { width: 100%; height: 100%; object-fit: contain; display: none; position:absolute; top:0; left:0; }
    .p1-fields { flex: 1; display: flex; flex-direction: column; gap: 15px; }
    .p1-row { display: flex; gap: 15px; }
    .p1-lbl { font-size: 11px; color: #888; text-transform: uppercase; display: block; margin-bottom: 5px; }
    .p1-inp { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; }







/* --- STILI V4.8 (LAYOUT ORIZZONTALE) --- */
    
    /* 1. Barra in Alto (Box Azzurro) */
    .sb-header-horizontal {
        width: 100%;
        height: 60px;
        background: #111;
        border-bottom: 1px solid #333;
        display: flex;
        align-items: center;
        padding: 0 20px;
        box-sizing: border-box;
        justify-content: space-between; /* Titolo a sx, Bottoni a dx */
        flex-shrink: 0; /* Non si schiaccia */
    }

    /* Bottoni allineati in riga */
    .sb-nav-group {
        display: flex;
        gap: 10px;
    }

    /* 2. Contenitore Colonne (Box Giallo) */
    .sb-kanban-fullwidth {
        display: flex;
        flex: 1; /* Occupa tutto lo spazio verticale rimasto */
        width: 100%;
        padding: 15px;
        gap: 15px;
        box-sizing: border-box;
        overflow-x: auto; /* Scorre se lo schermo √® minuscolo */
        background: #0a0a0a;
    }

    /* 3. Le Colonne si dividono lo spazio (flex: 1) */
    .sb-col-equal {
        flex: 1; /* <--- QUESTO DIVIDE LO SPAZIO IN MODO UGUALE */
        min-width: 200px; /* Sicurezza per non farle esplodere se restringi troppo */
        background: #141414;
        border: 1px solid #333;
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .sb-col-header {
        padding: 10px;
        text-align: center;
        font-weight: bold;
        color: #9b59b6;
        background: #1a1a1a;
        border-bottom: 1px solid #333;
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: 1px;
    }
    
    .sb-col-body {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
    }




























//===============================================================================
// SANDBOX STYLE // - FINE X PENSO FILE CSS
//===============================================================================






    </style>
</head>
<body>

    <div id="editor-popup">
        <textarea id="editor-textarea"></textarea>
        <div style="text-align:right; margin-top:10px;">
            <button class="btn-editor" style="background:#444; color:white;" onclick="chiudiEditor()">ANNULLA</button>
            <button class="btn-editor" style="background:var(--neon-green); color:black;" onclick="salvaEditor()">SALVA</button>
        </div>
    </div>

    <div id="modal-articolo" class="modal-overlay" style="display: none;">
        <div class="modal-box" style="max-width: 900px; height: 85%;">
            <div class="modal-head">
                <span class="mh-order-label" id="art-modal-title">NUOVO ARTICOLO</span>
                <button onclick="chiudiModalArticolo()" class="btn-close-modal">X</button>
            </div>
            <div class="modal-body" style="flex-direction: column; overflow-y: auto;">
                <div class="article-grid">
                    <div class="art-img-box" onclick="document.getElementById('upload-art-img').click()">
                        <span id="art-placeholder" style="font-size:40px; color:#555;">üì∑</span>
                        <img id="art-preview" class="art-img-prev">
                        <input type="file" id="upload-art-img" style="display:none;" accept="image/*" onchange="previewArtImg()">
                    </div>
                    <div class="art-fields">
                        <div style="display:flex; gap:10px;">
                            <div style="flex:1;"><label class="big-label">Matricola</label><input id="new-matr" class="big-input"></div>
                            <div style="flex:1;"><label class="big-label">Disegno</label><input id="new-dis" class="big-input"></div>
                        </div>
                        <div><label class="big-label">Descrizione</label><input id="new-desc" class="big-input"></div>
                    </div>
                </div>
                
                <div style="flex:1; display:flex; flex-direction:column;">
                    <div style="color:#0994E6; font-size:14px; border-bottom:1px solid #333; padding-bottom:5px;">COMPONENTI</div>
                    <div style="overflow-y:auto; flex:1;">
                        <table class="comp-table">
                            <thead><tr><th style="width:30px;">#</th><th style="width:40px;">IMG</th><th>Fornitore</th><th>Matricola</th><th>Disegno</th><th style="width:50px;">Qta</th><th>Descrizione</th><th>Materiale</th><th style="width:30px;"></th></tr></thead>
                            <tbody id="comp-body"></tbody>
                        </table>
                        <button class="btn-add-comp" onclick="aggiungiRigaComp()">+ Aggiungi Riga</button>
                    </div>
                </div>

                <div style="padding-top:15px; border-top:1px solid #333; text-align:right;">
                    <button class="btn-glass green" style="padding:10px 30px;" onclick="salvaArticolo()">SALVA ARTICOLO</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-overlay" style="display: none;">
        <div class="modal-box">
            <div class="modal-head">
                <div class="mh-left">
                    <div class="mh-icon" id="mh-icon-box">üì¶</div>
                    <div class="mh-info">
                        <span><span class="mh-label">Matr:</span> <span class="mh-val" id="m-matr">---</span></span>
                        <span><span class="mh-label">N¬∞ Dis:</span> <span class="mh-val" id="m-dis">---</span></span>
                        <span><span class="mh-label">Q.t√†:</span> <span class="mh-val" id="m-qta">---</span></span>
                    </div>
                </div>
                <div class="mh-right">
                    <div class="mh-order-label" id="m-title">N¬∞ Ordine: ---</div>
                    <button onclick="document.getElementById('modal-overlay').style.display='none'" class="btn-close-modal">X</button>
                </div>
            </div>

            <div class="modal-body">
                <div class="col-distinta">
                    <div style="padding:0 0 10px 5px; font-weight:400; color:#0994E6; font-size:16px; letter-spacing:1px; text-transform:uppercase;">DISTINTA BASE - CHECK MATERIALI</div>
                    <div class="distinta-list-container">
                        <div class="distinta-grid-layout distincta-header-row">
                            <div>CHK</div><div>#</div><div>IMG</div><div>FORNITORI</div><div>MATRICOLA</div><div>DISEGNO</div><div>Q/M</div><div style="color:var(--neon-cyan)">Q.TOT</div><div style="color:var(--neon-green)">ARRIVATI</div><div style="color:var(--neon-green)">DDT</div><div>%</div><div>DESCRIZIONE</div><div>MATERIALE</div>
                        </div>
                        <div id="distinta-container"></div>
                    </div>
                </div>
                <div class="col-fasi" id="fasi-container"></div>
            </div>
        </div>
    </div>

    <div id="modal-manage" class="modal-overlay">
        <div class="manage-box-modal">
            <div class="manage-head">
                <span style="color:white; font-weight:bold; font-size:16px;">DASHBOARD FORNITORI</span>
                <button onclick="document.getElementById('modal-manage').style.display='none'" style="background:none; border:none; color:#888; font-size:24px; cursor:pointer;">√ó</button>
            </div>
            <div class="manage-body">
                <div class="manage-col">
                    <div class="col-title" style="color:#00e5ff;">ATTIVI</div>
                    <div class="col-list" id="list-active"></div>
                </div>
                <div class="manage-col">
                    <div class="col-title" style="color:#666;">ARCHIVIO</div>
                    <div class="col-list" id="list-archive"></div>
                </div>
            </div>
            <div class="new-client-box">
                <input type="text" id="new-client-name" class="inp-new" placeholder="Nome Nuovo Fornitore...">
                <button class="btn-save-new" onclick="addClient()">AGGIUNGI</button>
            </div>
        </div>
    </div>

    <div class="header-bar">
        <button class="btn-back" onclick="window.location.href='index.html'">‚¨Ö HOME</button>
        <div class="clients-scroll" id="clients-bar"></div>
        <button class="btn-manage" onclick="openManage()">‚öôÔ∏è GESTISCI</button>
    </div>

    <div id="workspace">
        <div id="view-standard">
            <div class="tabs">
                <button class="tab-btn active" id="btn-lavori" onclick="switchTab('lavori')">LAVORI</button>
                <button class="tab-btn" id="btn-archivio" onclick="switchTab('archivio')">ARCHIVIO</button>
            </div>
            <div id="view-lavori" style="flex:1; overflow:hidden;">
                <div class="kanban" id="kanban-area"></div>
            </div>
            <div id="view-archivio" style="display:none; flex:1; overflow-y:auto;">
                <div class="archive-list"><button class="btn-add-archive" onclick="apriModalNuovoArticolo()">+ NUOVO ARTICOLO</button><div id="archive-list"></div></div>
            </div>
        </div>

        <div id="view-sandbox" class="sandbox-container">
            </div>
    </div>
    
    <div id="placeholder" style="text-align:center; padding:100px; color:#444; font-size: 14px; letter-spacing: 1px;">SELEZIONA UN CLIENTE DALLA BARRA IN ALTO</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCfFDdtzkZLClamp-Z_iODl8KQbBevEAfg", authDomain: "planner-carpenteria.firebaseapp.com", databaseURL: "https://planner-carpenteria-default-rtdb.europe-west1.firebasedatabase.app", projectId: "planner-carpenteria", storageBucket: "planner-carpenteria.firebasestorage.app", messagingSenderId: "926532216818", appId: "1:926532216818:web:927f43972c81bbf580ed6b" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // GESTIONE CLIENTI DINAMICA
    let allClients = JSON.parse(localStorage.getItem('my_clients')) || [
        { name: "Altro", active: true },
        { name: "F.R. srl", active: true },
        { name: "Fond-Stamp", active: true },
        { name: "Scotta", active: true },
        { name: "Tomatis", active: true },
        { name: "Tre Emme", active: true },
        { name: "Prova 1", active: true } // Aggiunto per il test
    ];

    // Se "Prova 1" non esiste nel localStorage salvato, aggiungilo
    if(!allClients.find(c => c.name === "Prova 1")) {
        allClients.push({name: "Prova 1", active: true});
        localStorage.setItem('my_clients', JSON.stringify(allClients));
    }

    const stati = ["ANCORA DA ORDINARE", "In Attesa di Materiale", "In Produzione", "Pronto per la Spedizione", "Ordini Chiusi", "Archiviati"];
    const stages = {
        stage1: { title: "IN ATTESA MATERIALE", items: ["Commerciale", "Sagomati", "Laser Tubo"] },
        stage2: { title: "IN PRODUZIONE", items: ["Assemblaggio", "Saldatura", "Lavorazioni Esterne", "Provati", "Numerati"] },
        stage3: { title: "PRONTO SPEDIZIONE", items: ["Finiti Grezzi", "Verniciati", "Pronti x Verniciatura"] }
    };
    let currentClient = null;
    let currentArtId = null;
    let currentArtImg = null;

    window.onload = function() {
        if(localStorage.getItem('auth_token') !== 'logged_in') window.location.href='index.html';
        renderClientsBar();
    };

    function renderClientsBar() {
        const bar = document.getElementById('clients-bar');
        bar.innerHTML = "";
        allClients.forEach(c => {
            if(c.active) {
                bar.innerHTML += `<button class="btn-client" onclick="selectClient('${c.name}', this)">${c.name}</button>`;
            }
        });
    }

    // --- SELEZIONE CLIENTE (CON SEMAFORO) ---
    function selectClient(c, btn) {
        currentClient = c;
        document.querySelectorAll('.btn-client').forEach(b => b.classList.remove('selected'));
        if(btn) btn.classList.add('selected');
        document.getElementById('placeholder').style.display = 'none';
        document.getElementById('workspace').style.display = 'flex';

        // --- BIVIO ---
        if (c === "Prova 1") {
            // MOSTRA SANDBOX, NASCONDI STANDARD
            document.getElementById('view-standard').style.display = 'none';
            document.getElementById('view-sandbox').style.display = 'flex';
            renderSandbox(); // Funzione isolata
        } else {
            // MOSTRA STANDARD, NASCONDI SANDBOX
            document.getElementById('view-standard').style.display = 'block';
            document.getElementById('view-sandbox').style.display = 'none';
            loadKanban();
            loadArchive();
        }
    }

















    // =======================================================================
    // AREA SANDBOX - SOLO PER CLIENTE "PROVA 1" (V4.0)
    // =======================================================================
    // =======================================================================
    // AREA SANDBOX - SOLO PER CLIENTE "PROVA 1" (V4.0)
    // =======================================================================







    // --- FUNZIONE SANDBOX ISOLATA ---






function renderSandbox() {
        const container = document.getElementById('view-sandbox');
        
        // FORZA IL LAYOUT VERTICALE (Barra sopra, Colonne sotto)
        container.style.display = 'flex';
        container.style.flexDirection = 'column'; 
        container.style.padding = '0';
        container.style.width = '100%';
        container.style.height = '100%';
        
        const columns = ["UFFICIO", "MAGAZZINO", "IN PRODUZIONE", "PRONTI", "VERNICIATURA", "FINITI", "ARCHIVIATI"];

        let html = `
            <div class="sb-header-horizontal">
                <div style="font-size: 20px; font-weight: bold; color: #9b59b6;">
                    üß™ PROVA 1
                </div>
                
                <div class="sb-nav-group">
                    <button class="sb-nav-btn active" id="sb-btn-lavori" onclick="switchSandboxTab('lavori')">LAVORI</button>
                    <button class="sb-nav-btn" id="sb-btn-archivio" onclick="switchSandboxTab('archivio')">ARCHIVIO</button>
                    <button class="sb-nav-btn" id="sb-btn-box1" onclick="switchSandboxTab('box1')">BOX 1</button>
                    <button class="sb-nav-btn" id="sb-btn-box2" onclick="switchSandboxTab('box2')">BOX 2</button>
                    <button class="sb-nav-btn" id="sb-btn-box3" onclick="switchSandboxTab('box3')">BOX 3</button>
                </div>
            </div>

            <div style="flex: 1; overflow: hidden; position: relative; width: 100%;">
                
                <div id="sb-view-lavori" style="display: flex; width: 100%; height: 100%;">
                    <div class="sb-kanban-fullwidth">
                        ${columns.map((col, i) => `
                            <div class="sb-col-equal">
                                <div class="sb-col-header">${col}</div>
                                <div class="sb-col-body" id="sb-col-${i}">
                                    
                                    ${col === "IN PRODUZIONE" ? `
                                    <div class="sandbox-card" onclick="apriModalProva1()">
                                        <div class="sb-card-head">
                                            <span class="sb-card-title">2024/001</span>
                                            <span class="sb-card-badge">PRIORIT√Ä</span>
                                        </div>
                                        <div class="sb-card-body" style="font-size:12px; color:#aaa;">
                                            <div><strong style="color:#9b59b6">CENTRALE:</strong> T-500</div>
                                            <div><strong style="color:#9b59b6">DISEGNO:</strong> D-123</div>
                                            <div style="margin-top:5px; color:white;">Lavorazione test...</div>
                                        </div>
                                    </div>` : ''}

                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div id="sb-view-archivio" style="display:none; padding:20px; width:100%; height:100%; box-sizing:border-box; overflow-y:auto;">
                    <div class="scotta-box" style="border-color:#9b59b6;">
                        <div class="scotta-head" style="border-bottom:1px solid #9b59b6;">
                            <span class="scotta-title" style="color:#9b59b6;">ARCHIVIO</span>
                        </div>
                        <div style="padding:10px;">
                            <table class="commessa-table">
                                <thead><tr><th style="color:#9b59b6;">MATR</th><th>CLIENTE</th><th>NOTE</th><th style="width:30px"></th></tr></thead>
                                <tbody id="sb-archive-body">
                                    <tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td style="color:red; cursor:pointer;" onclick="this.parentElement.remove()">‚úñ</td></tr>
                                </tbody>
                            </table>
                            <button class="btn-add-row" style="color:#9b59b6; background:#2a1a35;" onclick="addSandboxArchiveRow()">+ NUOVA</button>
                        </div>
                    </div>
                </div>

                <div id="sb-view-box1" style="display:none; padding:50px; text-align:center;">BOX 1</div>
                <div id="sb-view-box2" style="display:none; padding:50px; text-align:center;">BOX 2</div>
                <div id="sb-view-box3" style="display:none; padding:50px; text-align:center;">BOX 3</div>

            </div>
        `;

        container.innerHTML = html;
    }




























    // --- FINE SANDBOX ---




    // =======================================================================
    // FINE AREA SANDBOX
    // =======================================================================
    // =======================================================================
    // FINE AREA SANDBOX
    // =======================================================================











    // --- FUNZIONI STANDARD (NON TOCCATE) ---
    function switchTab(t) {
        document.getElementById('view-lavori').style.display = t==='lavori'?'block':'none';
        document.getElementById('view-archivio').style.display = t==='archivio'?'block':'none';
        document.getElementById('btn-lavori').className = t==='lavori'?'tab-btn active':'tab-btn';
        document.getElementById('btn-archivio').className = t==='archivio'?'tab-btn active':'tab-btn';
    }

    function loadKanban() {
        const k = document.getElementById('kanban-area'); k.innerHTML = "";
        stati.forEach((s, i) => {
            k.innerHTML += `<div class="col"><div class="col-head">${s}</div><div class="col-body" id="col-${i}"></div></div>`;
        });
        db.ref('commesse/' + currentClient).on('value', snap => {
            for(let i=0; i<stati.length; i++) document.getElementById(`col-${i}`).innerHTML="";
            let data = snap.val(); if(!data) return;
            for(let id in data) {
                let d = data[id];
                let card = document.createElement('div'); card.className = 'card';
                card.onclick = () => openModal(id, d);
                card.innerHTML = `
                    <div class="card-details">
                        <span>Matr: ${d.matricola}</span><span class="detail-sep">|</span><span>N¬∞ Dis: ${d.disegno}</span>
                    </div>
                    <div class="card-top">
                        <div class="card-title">${d.nomeOrdine}</div>
                        <div class="card-badge">Q.t√†: ${d.qtaTotale}</div>
                    </div>
                    <div class="card-foot">
                        <button class="btn-mini btn-del" onclick="del('${id}', event)">‚úñ</button>
                        <div class="btn-group-right">
                            ${d.stato > 0 ? `<button class="btn-mini btn-move" onclick="move('${id}', ${d.stato-1}, event)">‚óÄ</button>` : ''}
                            ${d.stato < stati.length-1 ? `<button class="btn-mini btn-move" onclick="move('${id}', ${d.stato+1}, event)">‚ñ∂</button>` : ''}
                        </div>
                    </div>
                `;
                let col = document.getElementById(`col-${d.stato}`);
                if(col) col.appendChild(card);
            }
        });
    }

    function move(id, s, e) { e.stopPropagation(); if(s>=0 && s<stati.length) db.ref('commesse/'+currentClient+'/'+id).update({stato:s}); }
    function del(id, e) { e.stopPropagation(); if(confirm("Eliminare?")) db.ref('commesse/'+currentClient+'/'+id).remove(); }

    function openModal(id, d) {
        document.getElementById('m-title').innerText = "N¬∞ Ordine: " + d.nomeOrdine;
        document.getElementById('m-matr').innerText = (d.matricola || '-');
        document.getElementById('m-dis').innerText = (d.disegno || '-');
        document.getElementById('m-qta').innerText = (d.qtaTotale || '-');
        
        let imgBox = document.getElementById('mh-icon-box');
        if(d.immagine) imgBox.innerHTML = `<img src="${d.immagine}" style="width:50px; height:50px; border-radius:5px; object-fit:contain;">`;
        else imgBox.innerHTML = "üì¶";

        const fc = document.getElementById('fasi-container'); fc.innerHTML = "";
        Object.keys(stages).forEach(k => {
            let conf = stages[k];
            let html = `<div class="stage-box"><div class="stage-title">${conf.title}</div>`;
            conf.items.forEach(i => {
                let checked = d.checklist && d.checklist[k] && d.checklist[k][i];
                html += `<div class="chk-row" onclick="toggleChk('${id}','${k}','${i}', this)"><div class="check-box ${checked?'checked':''}"></div> <div style="font-weight:500;">${i}</div></div>`;
            });
            html += `</div>`;
            fc.innerHTML += html;
        });

        const dc = document.getElementById('distinta-container'); dc.innerHTML = "Caricamento...";
        db.ref('archivio/' + currentClient).orderByChild('matricola').equalTo(d.matricola).once('value', snap => {
            dc.innerHTML = "";
            let arts = snap.val();
            if(arts) {
                let art = Object.values(arts)[0];
                if(art.componenti) {
                    art.componenti.forEach((c, idx) => {
                        let cid = `comp_${idx}`;
                        let checked = d.checklist && d.checklist.distintaBase && d.checklist.distintaBase[cid];
                        let qUnit = parseInt(c.qta)||0;
                        let qTot = qUnit * (parseInt(d.qtaTotale)||1);
                        let saved = (d.checklist && d.checklist.distintaDati && d.checklist.distintaDati[cid]) || {};
                        let qArr = saved.qtaArr ? parseInt(saved.qtaArr) : 0;
                        let perc = qTot > 0 ? Math.min(100, Math.round((qArr / qTot) * 100)) : 0;
                        let colorPerc = perc === 100 ? '#00ff88' : (perc > 0 ? '#f1c40f' : '#666');
                        let imgSrc = c.iconaBase64 || c.iconaBase || c.immagine || "";
                        let iconHtml = imgSrc ? `<img src="${imgSrc}" class="part-icon-thumb">` : `<div class="part-icon-placeholder">üì∑</div>`;

                        let row = document.createElement('div'); row.className = `distinta-row-item ${checked?'checked':''}`;
                        row.innerHTML = `
                            <div class="d-cell"><div class="check-box ${checked?'checked':''}" onclick="toggleDist('${id}','${cid}',this)"></div></div>
                            <div class="d-cell">${idx+1}</div>
                            <div class="d-cell">${iconHtml}</div>
                            <div class="d-cell">${c.fornitore}</div>
                            <div class="d-cell" style="color:#E94560;">${c.matricola}</div>
                            <div class="d-cell">${c.disegno}</div>
                            <div class="d-cell">${qUnit}</div>
                            <div class="d-cell" style="color:#00ff88; font-weight:bold;">${qTot}</div>
                            <div class="d-cell"><input class="inp-mini" type="number" value="${saved.qtaArr||''}" oninput="updatePerc(this, ${qTot}, this.parentElement.nextElementSibling.nextElementSibling)" onchange="saveDistData('${id}','${cid}','qtaArr',this.value)"></div>
                            <div class="d-cell"><input class="inp-mini" type="text" value="${saved.ddt||''}" onchange="saveDistData('${id}','${cid}','ddt',this.value)"></div>
                            <div class="d-cell" style="color:${colorPerc}; font-weight:bold;">${perc}%</div>
                            <div class="d-cell left">${c.denominazione}</div>
                            <div class="d-cell">${c.materiale}</div>
                        `;
                        dc.appendChild(row);
                    });
                }
            } else { dc.innerHTML = "Articolo non trovato in archivio."; }
        });
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    window.updatePerc = function(input, qTot, percCell) {
        let val = parseInt(input.value) || 0;
        let p = qTot > 0 ? Math.min(100, Math.round((val/qTot)*100)) : 0;
        percCell.innerText = p + "%";
        percCell.style.color = p === 100 ? '#00ff88' : (p > 0 ? '#f1c40f' : '#666');
    }

    window.toggleChk = function(id, s, i, row) { 
        let box = row.querySelector('.check-box');
        let isChecked = box.classList.contains('checked');
        if(isChecked) box.classList.remove('checked'); else box.classList.add('checked');
        db.ref(`commesse/${currentClient}/${id}/checklist/${s}/${i}`).set(!isChecked);
    }

    window.toggleDist = function(id, cid, div) { 
        let isC = div.classList.contains('checked');
        db.ref(`commesse/${currentClient}/${id}/checklist/distintaBase/${cid}`).set(!isC);
        let row = div.closest('.distinta-row-item');
        if(!isC) { div.classList.add('checked'); row.classList.add('checked'); }
        else { div.classList.remove('checked'); row.classList.remove('checked'); }
    }
    window.saveDistData = function(id, cid, f, v) { db.ref(`commesse/${currentClient}/${id}/checklist/distintaDati/${cid}/${f}`).set(v); }

    function loadArchive() {
        const l = document.getElementById('archive-list'); l.innerHTML = "Caricamento...";
        db.ref('archivio/' + currentClient).on('value', snap => {
            l.innerHTML = ""; let data = snap.val();
            if(!data) { l.innerHTML = "Nessun articolo."; return; }
            for(let id in data) {
                let a = data[id];
                let imgSrc = a.immagine ? `<img src="${a.immagine}" class="arch-img">` : `<div class="arch-img" style="background:#333; display:flex; align-items:center; justify-content:center;">üì¶</div>`;
                l.innerHTML += `
                    <div class="arch-item">
                        ${imgSrc}
                        <div class="arch-info">
                            <div style="font-size:20px; font-weight:bold; color:#E94560;">${a.matricola}</div>
                            <div>${a.desc}</div>
                        </div>
                        <div class="arch-actions">
                            <button class="btn-glass green" onclick="produci('${id}')">PRODUCI</button>
                            <button class="btn-glass yellow" onclick="modificaArticolo('${id}')">MODIFICA</button>
                            <button class="btn-glass red" onclick="eliminaArticolo('${id}')">ELIMINA</button>
                        </div>
                    </div>
                `;
            }
        });
    }

    window.produci = function(aid) {
        db.ref('archivio/'+currentClient+'/'+aid).once('value', s=>{
            let a = s.val();
            let nome = prompt("Nome Ordine:", "Lotto X");
            let q = prompt("Quantit√†:", "1");
            if(nome && q) {
                db.ref('commesse/'+currentClient).push({
                    nomeOrdine: nome, qtaTotale: q, stato: 0,
                    matricola: a.matricola, disegno: a.disegno, 
                    data: new Date().toISOString(), immagine: a.immagine
                });
                alert("Creato!");
                switchTab('lavori');
            }
        });
    }

    function apriModalNuovoArticolo() {
        currentArtId = null; currentArtImg = null;
        document.getElementById('art-modal-title').innerText = "NUOVO ARTICOLO";
        document.getElementById('new-matr').value = "";
        document.getElementById('new-dis').value = "";
        document.getElementById('new-desc').value = "";
        document.getElementById('comp-body').innerHTML = "";
        document.getElementById('art-preview').src = ""; document.getElementById('art-preview').style.display='none';
        document.getElementById('art-placeholder').style.display='block';
        document.getElementById('modal-articolo').style.display = 'flex';
        aggiungiRigaComp();
    }

    window.modificaArticolo = function(id) {
        currentArtId = id;
        document.getElementById('art-modal-title').innerText = "MODIFICA ARTICOLO";
        db.ref('archivio/'+currentClient+'/'+id).once('value', s=>{
            let a = s.val();
            document.getElementById('new-matr').value = a.matricola;
            document.getElementById('new-dis').value = a.disegno;
            document.getElementById('new-desc').value = a.desc;
            if(a.immagine) {
                currentArtImg = a.immagine;
                document.getElementById('art-preview').src = a.immagine;
                document.getElementById('art-preview').style.display='block';
                document.getElementById('art-placeholder').style.display='none';
            }
            document.getElementById('comp-body').innerHTML = "";
            if(a.componenti) a.componenti.forEach(c => aggiungiRigaComp(c));
            else aggiungiRigaComp();
            document.getElementById('modal-articolo').style.display = 'flex';
        });
    }

    window.eliminaArticolo = function(id) { if(confirm("Eliminare da archivio?")) db.ref('archivio/'+currentClient+'/'+id).remove(); }
    window.chiudiModalArticolo = function() { document.getElementById('modal-articolo').style.display='none'; }

    window.salvaArticolo = function() {
        let m = document.getElementById('new-matr').value;
        if(!m) return alert("Matricola obbligatoria");
        
        let comps = [];
        document.querySelectorAll('#comp-body tr').forEach(r => {
            let inps = r.querySelectorAll('input');
            if(inps[2].value || inps[3].value) { 
                let imgTag = r.querySelector('img');
                let imgData = imgTag ? imgTag.src : "";
                comps.push({
                    iconaBase64: imgData,
                    fornitore: inps[1].value, matricola: inps[2].value, disegno: inps[3].value,
                    qta: inps[4].value, denominazione: inps[5].value, materiale: inps[6].value
                });
            }
        });

        let data = {
            matricola: m,
            disegno: document.getElementById('new-dis').value,
            desc: document.getElementById('new-desc').value,
            immagine: currentArtImg,
            componenti: comps
        };

        if(currentArtId) db.ref('archivio/'+currentClient+'/'+currentArtId).update(data);
        else db.ref('archivio/'+currentClient).push(data);
        chiudiModalArticolo();
    }

    window.previewArtImg = function() {
        let f = document.getElementById('upload-art-img').files[0];
        if(!f) return;
        let r = new FileReader();
        r.onload = e => { 
            currentArtImg = e.target.result; 
            document.getElementById('art-preview').src = currentArtImg;
            document.getElementById('art-preview').style.display='block';
            document.getElementById('art-placeholder').style.display='none';
        };
        r.readAsDataURL(f);
    }

    window.aggiungiRigaComp = function(data) {
        let tbody = document.getElementById('comp-body');
        let idx = tbody.children.length + 1;
        let imgHtml = (data && (data.iconaBase64 || data.iconaBase)) ? `<img src="${data.iconaBase64 || data.iconaBase}" style="width:30px;height:30px;">` : 'üì∑';
        
        let row = `<tr>
            <td>${idx}</td>
            <td onclick="this.querySelector('input').click()" style="cursor:pointer; text-align:center;">
                ${imgHtml}
                <input type="file" style="display:none" onchange="previewCompImg(this)">
            </td>
            <td><input type="text" value="${data?data.fornitore:''}"></td>
            <td><input type="text" value="${data?data.matricola:''}"></td>
            <td><input type="text" value="${data?data.disegno:''}"></td>
            <td><input type="number" value="${data?data.qta:''}"></td>
            <td><input type="text" value="${data?data.denominazione:''}"></td>
            <td><input type="text" value="${data?data.materiale:''}"></td>
            <td onclick="this.parentElement.remove()" style="color:red;cursor:pointer;">x</td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
    }

    window.previewCompImg = function(inp) {
        let f = inp.files[0];
        if(!f) return;
        let r = new FileReader();
        r.onload = e => { 
            inp.parentElement.innerHTML = `<img src="${e.target.result}" style="width:30px;height:30px;"><input type="file" style="display:none" onchange="previewCompImg(this)">`;
        };
        r.readAsDataURL(f);
    }

    // --- NUOVE FUNZIONI DI GESTIONE CLIENTI ---
    function openManage() {
        document.getElementById('modal-manage').style.display = 'flex';
        renderManageLists();
    }

    function renderManageLists() {
        const act = document.getElementById('list-active');
        const arch = document.getElementById('list-archive');
        act.innerHTML = ""; arch.innerHTML = "";

        allClients.forEach((c, i) => {
            let item = `<div class="manage-item"><span>${c.name}</span>`;
            if(c.active) {
                item += `<div style="display:flex; gap:5px;"><button class="btn-del" onclick="deleteClient(${i})">X</button><button class="btn-arrow" onclick="toggleClient(${i})">‚¨á</button></div></div>`;
                act.innerHTML += item;
            } else {
                item += `<div style="display:flex; gap:5px;"><button class="btn-del" onclick="deleteClient(${i})">X</button><button class="btn-arrow" onclick="toggleClient(${i})">‚¨Ü</button></div></div>`;
                arch.innerHTML += item;
            }
        });
    }

    function toggleClient(idx) {
        allClients[idx].active = !allClients[idx].active;
        localStorage.setItem('my_clients', JSON.stringify(allClients));
        renderManageLists();
        renderClientsBar();
    }

    function addClient() {
        let name = document.getElementById('new-client-name').value;
        if(name) {
            allClients.push({name: name, active: true});
            document.getElementById('new-client-name').value = "";
            localStorage.setItem('my_clients', JSON.stringify(allClients));
            renderManageLists();
            renderClientsBar();
        }
    }

    function deleteClient(idx) {
        if(confirm("Eliminare definitivamente?")) {
            allClients.splice(idx, 1);
            localStorage.setItem('my_clients', JSON.stringify(allClients));
            renderManageLists();
            renderClientsBar();
        }
    }

    // EDITOR PLACEHOLDERS
    function clickCell(td) {}
    function editCell(td) {}
    function chiudiEditor() { document.getElementById('editor-popup').style.display='none'; }
    function salvaEditor() {}

</script>
</body>
</html>