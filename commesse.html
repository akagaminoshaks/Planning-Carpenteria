<!DOCTYPE html>
<html lang="it">

<head>

    <meta charset="UTF-8">
    <title>Commesse - Gestionale V3.6 (Commented & Merged)</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>















    <style>
        /* ================================================================= */
        /* FIX LAVORO (LORENZO 10/02/2026) - INTEGRATI QUI */
        /* Ho modificato il BODY per lo scroll e il workspace per non tagliare */
        /* ================================================================= */
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #111; 
            color: white; 
            margin: 0; 
            min-height: 100vh; /* Permette alla pagina di allungarsi (Fix Lavoro) */
            display: flex; 
            flex-direction: column; 
            overflow-y: auto; /* Abilita la barra di scorrimento laterale (Fix Lavoro) */
        }

        #workspace { 
            flex: 1; 
            display: none; 
            flex-direction: column; 
            overflow: visible; /* Evita che il contenuto venga tagliato (Fix Lavoro) */
        }
        
        #view-standard {
            overflow: visible;
            height: auto; /* (Fix Lavoro) */
        }
        /* ================================================================= */

        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        
        /* HEADER BAR */
        .header-bar { padding: 10px 15px; background: #1a1a1a; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 20px; flex-shrink: 0; }
        .btn-back { background: transparent; border: 1px solid #666; color: #ccc; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; transition: 0.2s; }
        .btn-back:hover { border-color: white; color: white; }

        /* BARRA CLIENTI */
        .clients-scroll { display: flex; gap: 10px; overflow-x: auto; flex: 1; align-items: center; padding-bottom: 5px; }
        .clients-scroll::-webkit-scrollbar { height: 4px; }
        .clients-scroll::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }
        .btn-client { padding: 8px 25px; background: transparent; border: 1px solid rgba(255,255,255,0.3); color: #fff; border-radius: 25px; cursor: pointer; white-space: nowrap; transition: all 0.3s ease; font-family: 'Segoe UI Light', sans-serif; font-size: 14px; letter-spacing: 0.5px; }
        .btn-client:hover { border-color: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.2); }
        .btn-client.selected { background: transparent; border-color: #00ff88; color: #00ff88; box-shadow: 0 0 15px rgba(0, 255, 136, 0.4), inset 0 0 5px rgba(0, 255, 136, 0.1); font-weight: 600; }
        
        /* PULSANTE GESTISCI */
        .btn-manage { background: #222; border: 1px solid #00e5ff; color: #00e5ff; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 12px; text-transform: uppercase; margin-left: 10px; }
        .btn-manage:hover { background: #00e5ff; color: #000; }

        .tabs { display: flex; justify-content: center; padding: 10px; gap: 10px; background: #111; }
        .tab-btn { padding: 8px 30px; background: transparent; border: 1px solid #444; color: #777; border-radius: 20px; cursor: pointer; font-size: 12px; transition: 0.2s;}
        .tab-btn:hover { border-color: #666; color: #aaa; }
        .tab-btn.active { background: #fff; color: #000; font-weight: bold; border-color: #fff; }
        
        .kanban { display: flex; overflow-x: auto; gap: 15px; padding: 10px 20px; height: 100%; align-items: flex-start; }
        .col { min-width: 300px; width: 300px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); border-radius: 15px; display: flex; flex-direction: column; max-height: 100%; }
        .col-head { padding: 15px; text-align: center; font-weight: 300; color: #0994E6; border-bottom: 1px solid rgba(255,255,255,0.05); letter-spacing: 1px; font-size: 16px; text-transform: uppercase; font-family: 'Segoe UI Light', sans-serif; text-shadow: 0 0 10px rgba(9, 148, 230, 0.3); }
        .col-body { padding: 10px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 10px; }
        
        /* CARD */
        .card { background: linear-gradient(145deg, #252525, #1e1e1e); border: 1px solid rgba(255,255,255,0.5); border-radius: 15px; padding: 12px; cursor: pointer; position: relative; transition: all 0.2s ease; box-shadow: 0 0 10px rgba(255,255,255,0.05); min-height: 100px; display: flex; flex-direction: column; justify-content: space-between; }
        .card:hover { transform: translateY(-3px); border-color: white; box-shadow: 0 0 15px rgba(255,255,255,0.2); }
        .card-details { padding: 0 0 5px 0; font-size: 12px; color: #fff; font-weight: 300; display: flex; align-items: center; gap: 10px; opacity: 0.9; }
        .detail-sep { color: #555; font-size: 10px; }
        .card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .card-title { font-size: 15px; font-weight: normal; color: #fff; text-transform: uppercase; line-height: 1.1; flex: 1; padding-right: 5px; font-family: 'Segoe UI', sans-serif; letter-spacing: 0.5px; }
        .card-badge { background: transparent; border: 1px solid #00ff88; color: #00ff88; padding: 2px 8px; border-radius: 8px; font-size: 11px; font-weight: normal; white-space: nowrap; box-shadow: 0 0 5px rgba(0, 255, 136, 0.2); }
        .card-foot { display: flex; justify-content: space-between; align-items: center; padding-top: 8px; }
        .btn-group-right { display: flex; gap: 5px; }
        .btn-mini { width: 26px; height: 26px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #ccc; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; font-size: 12px; font-weight: bold; }
        .btn-mini:hover { background: rgba(255,255,255,0.15); color: white; border-color: white; }
        .btn-del { color: #e74c3c; border-color: rgba(231, 76, 60, 0.3); } .btn-del:hover { background: rgba(231, 76, 60, 0.2); border-color: #e74c3c; color: #e74c3c; }
        .btn-move { color: #3498db; border-color: rgba(52, 152, 219, 0.3); } .btn-move:hover { background: rgba(52, 152, 219, 0.2); border-color: #3498db; color: #3498db; }

        /* ARCHIVIO STYLES */
        .archive-list { padding: 20px; overflow-y: auto; }
        .arch-item { background: #222; border: 1px solid #333; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; align-items: center; gap: 20px; }
        .arch-img { width: 80px; height: 80px; background: white; border-radius: 5px; object-fit: contain; }
        .arch-info { flex: 1; }
        .arch-actions { display: flex; gap: 10px; }
        .btn-glass { padding: 8px 15px; border-radius: 8px; border: 1px solid #444; background: rgba(255,255,255,0.05); color: white; cursor: pointer; font-weight: bold; font-size: 12px; transition: 0.2s;}
        .btn-glass:hover { transform: translateY(-2px); }
        .green { border-color: #27ae60; color: #27ae60; } .green:hover { background: rgba(39, 174, 96, 0.2); }
        .yellow { border-color: #f1c40f; color: #f1c40f; } .yellow:hover { background: rgba(241, 196, 15, 0.2); }
        .red { border-color: #e74c3c; color: #e74c3c; } .red:hover { background: rgba(231, 76, 60, 0.2); }
        
        .btn-add-archive { width: 100%; padding: 15px; background: rgba(255,255,255,0.1); border: 1px dashed rgba(255,255,255,0.3); color: #ccc; border-radius: 10px; cursor: pointer; margin-bottom: 20px; font-weight: bold; font-size:16px; text-transform:uppercase; transition: 0.2s; }
        .btn-add-archive:hover { border-color: white; color: white; background: rgba(255,255,255,0.15); }

        /* MODALE & DETTAGLI */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #181818; width: 95%; height: 95%; border: 1px solid #333; border-radius: 15px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        
        /* HEADER MODALE DETTAGLIO */
        .modal-head { padding: 25px 30px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #111; }
        .mh-left { display: flex; align-items: center; gap: 25px; }
        .mh-icon { font-size: 50px; display:flex; align-items:center; } 
        .mh-info { display: flex; gap: 20px; font-size: 18px; font-family: 'Segoe UI', sans-serif; color: white; }
        .mh-label { color: #bbb; font-size: 16px; margin-right: 5px; font-weight: 300; }
        .mh-val { font-weight: 400; font-size: 20px; }
        .mh-right { display: flex; align-items: center; gap: 10px; }
        .mh-order-label { color: #fff; font-size: 24px; font-family: 'Segoe UI', sans-serif; font-weight: 300; }
        .btn-close-modal { background: transparent; border: 1px solid #444; color: #888; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; font-size: 14px; margin-left: 20px; display: flex; align-items: center; justify-content: center;}
        .btn-close-modal:hover { border-color: white; color: white; }

        .modal-body { display: flex; flex: 1; overflow: hidden; gap: 20px; padding: 20px; }
        .col-distinta { flex: 3; display: flex; flex-direction: column; overflow: hidden; }
        .col-fasi { flex: 1; border: none; padding: 0; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; max-width: 350px; }

        .stage-box { background: rgba(9, 148, 230, 0.05); border: 1px solid #0994E6; border-radius: 8px; padding: 15px; box-shadow: 0 0 10px rgba(9, 148, 230, 0.1); }
        .stage-title { color: #0994E6; font-weight: 400; font-size: 14px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid rgba(9, 148, 230, 0.3); padding-bottom: 5px; display: flex; justify-content: space-between; }

        .distinta-list-container { width: 100%; height: 100%; overflow-y: auto; overflow-x: auto; border: 1px solid #333; border-radius: 8px; background: rgba(0,0,0,0.3); }
        .distinta-grid-layout { display: grid; grid-template-columns: 40px 30px 50px 100px 100px 100px 50px 60px 70px 80px 50px 1fr 100px; gap: 5px; align-items: center; min-width: 1200px; }
        .distincta-header-row { font-size: 12px; font-weight: 400; color: #ccc; text-transform: uppercase; padding: 10px 5px; border-bottom: 1px solid #444; background: #1a1a1a; position: sticky; top: 0; z-index: 10; text-align: center; }
        .distinta-row-item { display: grid; grid-template-columns: 40px 30px 50px 100px 100px 100px 50px 60px 70px 80px 50px 1fr 100px; gap: 5px; align-items: center; background: rgba(255,255,255,0.02); border-bottom: 1px solid #222; padding: 8px 5px; transition: 0.2s; min-width: 1200px; font-family: 'Segoe UI', sans-serif; font-size: 13px; color: #ddd; text-align: center; }
        .distinta-row-item:hover { background: rgba(255,255,255,0.05); }
        .distinta-row-item.checked { border-left: 3px solid #27ae60; background: rgba(39, 174, 96, 0.05); }

        .d-cell { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .d-cell.left { text-align: left; padding-left: 5px; }
        
        .check-box { width: 18px; height: 18px; border: 1px solid #666; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin: 0 auto; }
        .checked .check-box { background: #27ae60; border-color: #27ae60; color: white; }
        .checked .check-box::after { content: '‚úì'; font-size: 12px; font-weight: bold; }
        
        .part-icon-thumb { width: 35px; height: 35px; object-fit: contain; background: #fff; border-radius: 4px; margin: 0 auto; display: block; }
        .part-icon-placeholder { width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; background: #333; border: 1px solid #555; border-radius: 4px; font-size: 18px; margin: 0 auto; color: #777; }
        
        .inp-mini { width: 100%; background: transparent; border: 1px solid #444; color: white; text-align: center; padding: 4px; border-radius: 4px; font-family: inherit; }
        .inp-mini:focus { border-color: #0994E6; outline: none; }

        .chk-row { 
            display: grid; 
            grid-template-columns: 30px 1fr; 
            gap: 10px; 
            align-items: center; 
            padding: 8px; 
            cursor: pointer; 
            font-size: 13px; 
            color: #ccc; 
            border-radius: 4px; 
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .chk-row:last-child { border-bottom: none; }
        .chk-row:hover { background: rgba(255,255,255,0.05); color: white; }
        
        #editor-popup { display: none; position: absolute; z-index: 1000; background: #1e1e1e; border: 2px solid var(--neon-green); border-radius: 8px; padding: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); width: 250px; }
        #editor-textarea { width: 100%; height: 100px; background: #111; color: white; border: 1px solid #444; border-radius: 4px; padding: 8px; font-family: inherit; font-size: 14px; resize: none; outline: none; }
        .btn-editor { padding: 5px 15px; border-radius: 4px; cursor: pointer; border: none; font-weight: bold; }

        /* MODALE ARTICOLO */
        .big-label { color: #888; font-size: 12px; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .big-input { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; }
        .article-grid { display: flex; gap: 20px; margin-bottom: 20px; }
        .art-img-box { width: 150px; height: 150px; border: 2px dashed #444; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 10px; position: relative; overflow: hidden; }
        .art-img-box:hover { border-color: #0994E6; }
        .art-img-prev { width: 100%; height: 100%; object-fit: contain; display: none; }
        .art-fields { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .comp-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .comp-table th { text-align: left; color: #0994E6; font-size: 12px; border-bottom: 1px solid #444; padding: 5px; }
        .comp-table td { border-bottom: 1px solid #222; padding: 5px; }
        .comp-table input { background: transparent; border: none; color: white; width: 100%; }
        .btn-add-comp { background: #333; color: white; border: 1px solid #555; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-top: 5px; }

        /* MODALE GESTIONE CLIENTI */
        .manage-box-modal { background: #181818; width: 800px; height: 600px; border: 1px solid #444; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.8); border-radius: 8px; overflow: hidden; }
        .manage-head { padding: 15px 20px; background: #111; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .manage-body { flex: 1; display: flex; padding: 20px; gap: 20px; overflow: hidden; }
        .manage-col { flex: 1; background: #111; border: 1px solid #333; display: flex; flex-direction: column; border-radius: 4px; }
        .col-title { padding: 10px; text-align: center; font-weight: bold; border-bottom: 1px solid #333; background: #1a1a1a; color: #aaa; text-transform: uppercase; font-size: 12px; }
        .col-list { flex: 1; overflow-y: auto; padding: 10px; }
        .manage-item { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 10px; margin-bottom: 5px; border-radius: 4px; border: 1px solid #333; }
        .manage-item:hover { border-color: #555; }
        .btn-arrow { background: #333; border: 1px solid #555; color: white; width: 30px; height: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 3px; }
        .btn-arrow:hover { background: #00e5ff; color:black; border-color: #00e5ff; }
        .btn-del { background: #2c0b0b; border: 1px solid #500; color: #f00; width: 30px; height: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 3px; margin-left: 5px; }
        .btn-del:hover { background: #f00; color: white; border-color: #f00; }
        .new-client-box { background: #222; border: 1px solid #444; padding: 15px; margin-top: auto; display: flex; gap: 10px; align-items: center; border-top: 1px solid #333; }
        .inp-new { background: #000; border: 1px solid #444; color: white; padding: 10px; flex: 1; border-radius: 4px; }
        .btn-save-new { background: #27ae60; color: white; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; text-transform: uppercase; }










 /*QUA HO IL CODICE CSS X LA SANDBOX! MOLTO UTILE*/
/*===============================================================================*/
 SANDBOX STYLE  INIZIO X PENSO FILE CSS
/*===============================================================================*/


    /* SANDBOX STYLES (SOLO PROVA 1) */
    .sandbox-container { display:none; flex-direction:column; gap:20px; padding:10px; }
    .sandbox-box { border:1px solid #9b59b6; background:#16101a; border-radius:4px; margin-bottom:20px; }
    .sandbox-head { background:#2a1a35; padding:10px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #9b59b6; }
    .sandbox-title { color:#9b59b6; font-weight:bold; text-transform:uppercase; font-size:14px; }
    .sandbox-note { background:#111; border:1px solid #555; color:#ccc; padding:5px; width:250px; font-size:12px; }
    .sandbox-drop { border:2px dashed #9b59b6; color:#9b59b6; padding:15px; text-align:center; font-size:11px; margin:10px; cursor:pointer; background:rgba(155,89,182,0.05); }
    .sandbox-btn-add { background:#9b59b6; color:white; border:none; width:100%; padding:8px; font-weight:bold; cursor:pointer; margin-top:5px; text-transform:uppercase; }


    /* --- STILI V4.3 (PROVA 1) --- */
    .sandbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; padding: 10px; }
    .sandbox-card { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 20px; display: flex; flex-direction: column; gap: 10px; height: 220px; justify-content: space-between; transition: 0.2s; cursor: pointer; position:relative; }
    .sandbox-card:hover { transform: translateY(-3px); border-color: #9b59b6; box-shadow: 0 5px 15px rgba(155, 89, 182, 0.1); }
    .sb-card-head { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 10px; }
    .sb-card-title { font-weight: bold; color: white; font-size: 16px; }
    .sb-card-badge { background: #2a1a35; color: #9b59b6; padding: 2px 8px; border-radius: 4px; font-size: 11px; border: 1px solid #9b59b6; }
    
    /* MODALE SMART PASTE */
    .p1-modal-grid { display: flex; gap: 20px; }
    .p1-img-area { width: 180px; height: 180px; border: 2px dashed #555; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-direction: column; cursor: pointer; background: #111; overflow: hidden; position: relative; }
    .p1-img-area:focus { border-color: #00ff88; outline: none; }
    .p1-img-prev { width: 100%; height: 100%; object-fit: contain; display: none; position:absolute; top:0; left:0; }
    .p1-fields { flex: 1; display: flex; flex-direction: column; gap: 15px; }
    .p1-row { display: flex; gap: 15px; }
    .p1-lbl { font-size: 11px; color: #888; text-transform: uppercase; display: block; margin-bottom: 5px; }
    .p1-inp { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; }



    /* ============================================================= */
    /*BENE BENE BENE - DA QUA MODIFICO IL LAYOUT DELLA SCHDA PROVA 1 - LORENZO 08/02/2026 - 11:46/*
    /* ============================================================= */
    /* QUESTO DOVREBBE ESSERE IL CODICE CSS X CAMBIARE COLORI ECC... */
    /* ============================================================= */
    /* --- STILI V4.8 (LAYOUT ORIZZONTALE) --- */
    


    /* ================================================================================================================================================================================= */
    /* INIZIO CONTROLLO CSS/LAYOUT - RIGA PROVA 1 --- LAVORI ARCHIVIO BOX123 */
    /* ================================================================================================================================================================================= */
    /* QUESTA √® LA RIGA ORIZZONATALE CON IL SELETTORE  LAVORI - ARCHIVIO - BOX 1 2 3 - NE GESTISCO LE PROPRIET√† */
    .sb-header-horizontal {
        width: 100%;
        height: 50px;
        background: #111;
        border-bottom: 1px solid #333;
        display: flex;
        align-items: center;
        padding: 0 20px;
        box-sizing: border-box;
        justify-content: space-between; /* Titolo a sx, Bottoni a dx */
        flex-shrink: 0; /* Non si schiaccia */
        position: relative;  
    }

    /* 1. || GESTISCE I BOTTONI - DISPLAY:___ GAP: DISTANZA TRA I BOTTONI */
    .sb-nav-group {
        display: flex;
        gap: 10px;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        }

    /* 1.1 Aspetto del bottone a riposo */
    .sb-nav-btn {
        background: transparent;        /* Sfondo trasparente */
        border: 1px solid #444;      /* Bordo grigio scuro */
        color: #888;                 /* Colore del testo spento */
        padding: 8px 25px;             /* Dimensioni */
        border-radius: 20px;           /* Pillola arrotondata */
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
        transition: all 0.3s ease;       /* Animazione fluida */
        }

    /* 1.2 Quando passi il mouse sopra (Hover) */
    .sb-nav-btn:hover {
        border-color: white;
        color: white;
        background: rgba(255,255,255,0.1);
        transform: translateY(-3px);    /* Effetto 3D - FIGHISSIMO!!! */ 
        }

    /* 1.3 Quando il bottone √® SELEZIONATO (Active) */
    .sb-nav-btn.active {
        background: #2f1f36b0;            /* Sfondo VIOLA ACCESO */
        border-color: #9b59b6;
        color: white;
        box-shadow: 0 0 15px rgba(228, 30, 235, 0.4); /* Alone luminoso */
        }
    /* --- FINE STILE BOTTONI --- */
    /* =============================================== */


    /* 2. || QUEST√≤ √® IL CONTENITORE, LA BASE SOTTO LE COLONNE! -- CAMBIA COLORE X VEDERE -- Contenitore Colonne (Box Giallo) */
    .sb-kanban-fullwidth {
        display: flex;
        flex: 1; /* Occupa tutto lo spazio verticale rimasto */
        width: 100%;
        padding: 15px;
        gap: 15px;
        box-sizing: border-box;
        overflow-x: auto; /* Scorre se lo schermo √® minuscolo */
        background: #101011;
    }

    /* 3. Le Colonne si dividono lo spazio (flex: 1) */
    .sb-col-equal {
        flex: 1; /* <--- QUESTO DIVIDE LO SPAZIO IN MODO UGUALE */
        min-width: 200px; /* Sicurezza per non farle esplodere se restringi troppo */
        background: #141414;    /* SFONDO COLONNE */
        border: 1px solid #686666; /* BORDI COLONNE */
        border-radius: 15px; /* RAGGI DEI BORDI */ 
        display: flex;
        flex-direction: column;
        height: 100%;
    }


    /* 4. IL TITOLO DELLE COLONNE*/
    .sb-col-header {
        padding: 10px;
        text-align: center;
        font-weight: bold; /*IL TESTO √® IN GRASSETTO*/
        color: #880db9;
        background: #1a1a1a;
        border-bottom: 1px solid #333;
        text-transform: uppercase; /*TUTTO MAIUSOLO*/
        font-size: 17px;
        letter-spacing: 3px;
    }
    

    /* 5. IO NON LO SO, L'INSERITORE AUTOMATICO SUGGERISCE: IL CORPO DELLE COLONNE */
    .sb-col-body {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
    }
    /* ================================================================================================================================================================================= */
    /* FINE CONTROLLO CSS/LAYOUT - RIGA PROVA 1 --- LAVORI ARCHIVIO BOX123 */
    /* ================================================================================================================================================================================= */







    /* ================================================================================================================================================================================= */
    /* INIZIO CSS/LAYOUT - DASHBOARD ARCHIVIO --- IL LAYOUT DI COME √® FATTA LA PAGINA QUANDO SI SCLICCA NELLA RIGA IL BOTTONE ARCHIVIO - LORENZO 08/02/2026 - 15:41 */
    /* ================================================================================================================================================================================= */
    /* --- 1. ASPETTO GENERALE DELLA TABELLA --- */
    .sb-table {
        width: 100%;                /* La tabella occupa tutta la larghezza disponibile */
        border-collapse: collapse; /* Elimina gli spazi doppi tra le celle (bordi uniti) */
        font-size: 14px;            /* Grandezza del testo di base nella tabella */
    }

    /* --- 2. INTESTAZIONE DELLA TABELLA (La riga in alto con i titoli) --- */
    .sb-table th {
        text-align: center;           /* Allinea il testo a sinistra (non centrato) */
        padding: 12px;              /* Spazio interno (aria) attorno al testo */
        background: #2a1a35;        /* Sfondo: Viola molto scuro (quasi nero) */
        color: #9b59b6;             /* Testo: Viola acceso (Neon) */
        border-bottom: 2px solid #9b59b6; /* Linea spessa viola sotto i titoli */
        text-transform: uppercase; /* Trasforma tutto il testo in MAIUSCOLO */
        font-size: 12px;            /* Testo leggermente pi√π piccolo del corpo */
    }

    /* --- 3. CELLE DEL CORPO TABELLA (Dove ci sono i dati) --- */
    .sb-table td {
        padding: 12px;              /* Spazio interno per non attaccare il testo ai bordi */
        border-bottom: 1px solid #333; /* Linea sottile grigia scura tra una riga e l'altra */
        color: #ccc;                /* Colore del testo: Grigio chiaro (leggibile su scuro) */
    }

    /* --- 4. EFFETTO MOUSE SOPRA LE RIGHE (Hover) --- */
    .sb-table tr:hover {
        background: rgba(155, 89, 182, 0.05); /* Quando passi il mouse, la riga si illumina leggermente di viola trasparente */
    }

    /* --- 5. STILE DEL BOTTONE "+ NUOVA COMMESSA" --- */
    .sb-btn-add {
        background: #9b59b6;        /* Colore di sfondo: Viola base */
        color: white;               /* Testo bianco */
        border: none;               /* Nessun bordino grigio standard */
        padding: 10px 20px;         /* Grandezza del bottone (10px altezza, 20px larghezza) */
        border-radius: 6px;         /* Angoli arrotondati (non spigolosi) */
        font-weight: bold;          /* Testo in grassetto */
        cursor: pointer;            /* Cursore diventa una manina quando ci passi sopra */
        transition: 0.3s;           /* Animazione fluida di 0.3 secondi per i cambi di colore */
        font-size: 12px;            /* Grandezza testo */
        letter-spacing: 1px;        /* Leggero spazio tra le lettere per stile */
    }

    /* --- 6. EFFETTO MOUSE SOPRA IL BOTTONE (Hover) --- */
    .sb-btn-add:hover {
        background: #8e44ad;        /* Diventa un viola leggermente pi√π scuro/intenso */
        box-shadow: 0 0 15px rgba(155, 89, 182, 0.5); /* Crea un alone luminoso (effetto neon) */
        transform: translateY(-2px); /* Sposta il bottone in su di 2 pixel (effetto 3D) */
    }
    





    /* ========================================================= */
    /* INCOLLA QUI IL NUOVO CODICE PER I BOTTONI DELLA TABELLA */
    /* ========================================================= */
    /* --- STILE BOTTONI TABELLA SANDBOX --- */
    /* HO SOSTITUITO LO STILE DI PRIMA CON QUELLO DI ORA - LORENZO 10/02/2026 ----- GEMINI: Ora dobbiamo dire al browser come far apparire questi nuovi bottoni. */

    /* Stile generale per tutti i bottoni di azione */
    .sb-action-btn {
        display: inline-flex;       /* Per allineare icona e testo sulla stessa riga */
        align-items: center;        /* Centra verticalmente icona e testo */
        gap: 6px;                   /* Spazio tra l'icona e il testo */
        padding: 6px 12px;          /* Spazio interno un po' pi√π grande */
        border-radius: 20px;        /* BORDI MOLTO ARROTONDATI (forma a "pillola") */
        cursor: pointer;            /* Cursore a manina */
        border: 1px solid transparent; /* Bordo trasparente di base */
        background: rgba(255,255,255,0.05); /* Sfondo leggermente visibile */
        color: white;               /* Testo bianco */
        font-size: 11px;            /* Dimensione testo */
        font-weight: normal;          /* Testo in grassetto */
        text-transform: uppercase;  /* Testo tutto maiuscolo */
        transition: all 0.3s ease;  /* Animazione fluida per tutti i cambiamenti */
        font-family: 'Segoe UI', sans-serif; /* Font moderno */
    }

    /* Effetto generale quando passi il mouse sopra */
    .sb-action-btn:hover {
        transform: translateY(-2px); /* Si sposta leggermente verso l'alto */
        box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* Aggiunge una leggera ombreggiatura */
    }

    /* Stile per l'icona dentro il bottone */
    .sb-btn-icon {
        font-size: 14px; /* Icona leggermente pi√π grande del testo */
    }

    /* --- Colori specifici per ogni bottone --- */

    /* Bottone PRODUCI (Verde) */
    .sb-btn-prod {
        color: #00ff88; /* Colore testo e icona */
        border-color: rgba(0, 255, 136, 0.3); /* Colore bordo */
    }
    .sb-btn-prod:hover {
        background: rgba(0, 255, 136, 0.15); /* Sfondo verde chiaro al passaggio del mouse */
        border-color: #00ff88; /* Bordo verde acceso */
    }

    /* Bottone MODIFICA (Giallo/Oro) */
    .sb-btn-edit {
        color: #f1c40f; /* Colore testo e icona */
        border-color: rgba(241, 196, 15, 0.3); /* Colore bordo */
    }
    .sb-btn-edit:hover {
        background: rgba(241, 196, 15, 0.15); /* Sfondo giallo chiaro al passaggio del mouse */
        border-color: #f1c40f; /* Bordo giallo acceso */
    }

    /* Bottone ELIMINA (Rosso) */
    .sb-btn-del {
        color: #e74c3c; /* Colore testo e icona */
        border-color: rgba(231, 76, 60, 0.3); /* Colore bordo */
    }
    .sb-btn-del:hover {
        background: rgba(231, 76, 60, 0.15); /* Sfondo rosso chiaro al passaggio del mouse */
        border-color: #e74c3c; /* Bordo rosso acceso */
    }
    
    /* ================================================================================================================================================================================= */
    /* FINE CSS/LAYOUT - DASHBOARD ARCHIVIO --- IL LAYOUT DI COME √® FATTA LA PAGINA QUANDO SI SCLICCA NELLA RIGA IL BOTTONE ARCHIVIO - LORENZO 08/02/2026 - 15:41 */
    /* ================================================================================================================================================================================= */











/* ================================================================================================================================================================================= */
/* INIZIO CSS/LAYOUT - DASHBOARD MODIFICA ARTICOLO --- IL LAYOUT DI COME √® FATTA LA PAGINA QUANDO SI SCLICCA NELLA RIGA IL BOTTONE ARCHIVIO - LORENZO 10/02/2026 - 19:21 */
/* ================================================================================================================================================================================= */

/* --- STILE DASHBOARD MODALE --- */
.dashboard-header {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    background: #1e1e1e; /* Sfondo scuro pannello */
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #333;
}

/* Contenitore Immagine */
.img-preview-box {
    width: 200px;
    height: 180px;
    background-color: #fff;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px dashed #555;
    overflow: hidden;
}

.img-preview-box img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

/* Contenitore Input a Destra */
.info-fields {
    flex: 1; /* Prende tutto lo spazio rimanente */
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.input-row {
    display: flex;
    gap: 15px;
}

.input-group {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.input-group label {
    font-size: 11px;
    color: #aaa;
    margin-bottom: 5px;
    text-transform: uppercase;
}

.input-dark {
    background: #2b2b2b;
    border: 1px solid #444;
    color: white;
    padding: 10px;
    border-radius: 4px;
    outline: none;
}

/* --- BARRA DEI FILTRI (Cerchio Verde) --- */
.filter-bar-container {
    margin: 15px 0;
    padding: 10px;
    background: #1a1a1a;
    border-top: 2px solid #00d26a; /* Linea verde estetica */
    border-radius: 0 0 8px 8px;
    display: flex;
    gap: 10px;
    overflow-x: auto; /* Se sono troppi scorre */
    white-space: nowrap;
}

.filter-btn {
    background: #333;
    color: #ccc;
    border: 1px solid #444;
    padding: 6px 12px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
}

.filter-btn:hover {
    background: #444;
    color: white;
}

.filter-btn.active {
    background: #00d26a; /* Verde attivo */
    color: #000;
    font-weight: bold;
    border-color: #00d26a;
}











/* Stile per la cella Icona nella tabella materiali */
.icon-cell-materiale {
    width: 40px; 
    height: 40px; 
    border: 1px dashed #555; 
    border-radius: 4px; 
    cursor: pointer; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    overflow: hidden;
    transition: all 0.2s;
    background: #000;
}

/* Quando √® attiva per l'incolla */
.icon-cell-materiale.active-paste {
    border: 2px solid #00ff88;
    box-shadow: 0 0 8px rgba(0, 255, 136, 0.5);
    background: rgba(0, 255, 136, 0.1);
}

/* Immagine dentro la cella */
.icon-thumb-mat {
    width: 100%; 
    height: 100%; 
    object-fit: cover;
}






/* Stile per i mini bottoni filtro nella Dashboard Produzione */
.filter-mini-btn {
    background: #111;
    border: 1px solid #444;
    color: #888;
    padding: 4px 10px;
    border-radius: 12px;
    cursor: pointer;
    font-size: 10px;
    font-weight: bold;
    text-transform: uppercase;
    transition: all 0.2s;
    white-space: nowrap;
}
.filter-mini-btn:hover {
    border-color: #fff;
    color: #fff;
}
.filter-mini-btn.active {
    background: #00d26a;
    color: #000;
    border-color: #00d26a;
}








/* --- STILI PER ANTEPRIMA MATERIALI (MAIN VIEW) --- */

/* Contenitore con scroll indipendente */
.preview-table-container {
    margin-top: 15px;
    background: #111;
    border: 1px solid #333;
    border-radius: 6px;
    height: 350px; /* Altezza fissa: se la lista √® lunga, appare la barra laterale qui dentro */
    overflow-y: auto;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
}

/* Tabella compatta */
.preview-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
    font-family: 'Segoe UI', sans-serif;
}

/* Intestazione fissa (rimane in alto quando scorri) */
.preview-table th {
    position: sticky;
    top: 0;
    background: #1a1a1a;
    color: #9b59b6;
    padding: 10px 8px;
    text-align: left;
    border-bottom: 2px solid #444;
    z-index: 2;
    text-transform: uppercase;
    font-size: 10px;
    letter-spacing: 1px;
}

.preview-table td {
    border-bottom: 1px solid #222;
    padding: 6px 8px;
    color: #ccc;
    vertical-align: middle;
}

/* Riga al passaggio del mouse */
.preview-table tr:hover {
    background: rgba(255, 255, 255, 0.03);
}

/* --- IL SEMAFORO (Pallino interattivo) --- */
.traffic-light {
    width: 14px; 
    height: 14px;
    border-radius: 50%;
    cursor: pointer;
    background: #333; /* Stato 0: Spento/Neutro */
    border: 1px solid #555;
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Effetto rimbalzo */
    margin: 0 auto; /* Centrato */
    display: block;
}

/* Stati colorati */
.st-1 { background: #f1c40f; border-color: #f1c40f; box-shadow: 0 0 8px rgba(241, 196, 15, 0.4); transform: scale(1.1); } /* Giallo */
.st-2 { background: #00e5ff; border-color: #00e5ff; box-shadow: 0 0 8px rgba(0, 229, 255, 0.4); transform: scale(1.1); } /* Azzurro (Ordinato) */
.st-3 { background: #00ff88; border-color: #00ff88; box-shadow: 0 0 8px rgba(0, 255, 136, 0.4); transform: scale(1.1); } /* Verde (Arrivato) */




































































/*QUA FINISCE IL CODICE CSS X LA SANDBOX! MOLTO UTILE*/
/*===============================================================================*/
SANDBOX STYLE FINE X PENSO FILE CSS
/*===============================================================================*/

    




    </style>
    </head>
<body>
     <div id="editor-popup">
        <textarea id="editor-textarea"></textarea>
        <div style="text-align:right; margin-top:10px;">
            <button class="btn-editor" style="background:#444; color:white;" onclick="chiudiEditor()">ANNULLA</button>
            <button class="btn-editor" style="background:var(--neon-green); color:black;" onclick="salvaEditor()">SALVA</button>
        </div>
    </div>

    <div id="modal-articolo" class="modal-overlay" style="display: none;">
        <div class="modal-box" style="max-width: 900px; height: 85%;">
            <div class="modal-head">
                <span class="mh-order-label" id="art-modal-title">NUOVO ARTICOLO</span>
                <button onclick="chiudiModalArticolo()" class="btn-close-modal">X</button>
            </div>
            <div class="modal-body" style="flex-direction: column; overflow-y: auto;">
                <div class="article-grid">
                    <div class="art-img-box" onclick="document.getElementById('upload-art-img').click()">
                        <span id="art-placeholder" style="font-size:40px; color:#555;">üì∑</span>
                        <img id="art-preview" class="art-img-prev">
                        <input type="file" id="upload-art-img" style="display:none;" accept="image/*" onchange="previewArtImg()">
                    </div>
                    <div class="art-fields">
                        <div style="display:flex; gap:10px;">
                            <div style="flex:1;"><label class="big-label">Matricola</label><input id="new-matr" class="big-input"></div>
                            <div style="flex:1;"><label class="big-label">Disegno</label><input id="new-dis" class="big-input"></div>
                        </div>
                        <div><label class="big-label">Descrizione</label><input id="new-desc" class="big-input"></div>
                    </div>
                </div>
                
                <div style="flex:1; display:flex; flex-direction:column;">
                    <div style="color:#0994E6; font-size:14px; border-bottom:1px solid #333; padding-bottom:5px;">COMPONENTI</div>
                    <div style="overflow-y:auto; flex:1;">
                        <table class="comp-table">
                            <thead><tr><th style="width:30px;">#</th><th style="width:40px;">IMG</th><th>Fornitore</th><th>Matricola</th><th>Disegno</th><th style="width:50px;">Qta</th><th>Descrizione</th><th>Materiale</th><th style="width:30px;"></th></tr></thead>
                            <tbody id="comp-body"></tbody>
                        </table>
                        <button class="btn-add-comp" onclick="aggiungiRigaComp()">+ Aggiungi Riga</button>
                    </div>
                </div>

                <div style="padding-top:15px; border-top:1px solid #333; text-align:right;">
                    <button class="btn-glass green" style="padding:10px 30px;" onclick="salvaArticolo()">SALVA ARTICOLO</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-box">
            <div class="modal-head">
                <div class="mh-left">
                    <div class="mh-icon" id="mh-icon-box">üì¶</div>
                    <div class="mh-info">
                        <span><span class="mh-label">Matr:</span> <span class="mh-val" id="m-matr">---</span></span>
                        <span><span class="mh-label">N¬∞ Dis:</span> <span class="mh-val" id="m-dis">---</span></span>
                        <span><span class="mh-label">Q.t√†:</span> <span class="mh-val" id="m-qta">---</span></span>
                    </div>
                </div>



                <div class="mh-right">
                    <div class="mh-order-label" id="m-title">N¬∞ Ordine: ---</div>
                    
                    <button onclick="apriModalQRStandard()" style="background:#3498db; color:white; border:none; padding:8px 15px; border-radius:4px; font-weight:bold; cursor:pointer; margin-left: 20px;">üî≤ STAMPA QR</button>
                    
                    <button onclick="document.getElementById('modal-overlay').style.display='none'" class="btn-close-modal">X</button>
                </div>




            </div>

            <div class="modal-body">
                <div class="col-distinta">
                    <div style="padding:0 0 10px 5px; font-weight:400; color:#0994E6; font-size:16px; letter-spacing:1px; text-transform:uppercase;">DISTINTA BASE - CHECK MATERIALI</div>
                    <div class="distinta-list-container">
                        <div class="distinta-grid-layout distincta-header-row">
                            <div>CHK</div><div>#</div><div>IMG</div><div>FORNITORI</div><div>MATRICOLA</div><div>DISEGNO</div><div>Q/M</div><div style="color:var(--neon-cyan)">Q.TOT</div><div style="color:var(--neon-green)">ARRIVATI</div><div style="color:var(--neon-green)">DDT</div><div>%</div><div>DESCRIZIONE</div><div>MATERIALE</div>
                        </div>
                        <div id="distinta-container"></div>
                    </div>
                </div>
                <div class="col-fasi" id="fasi-container"></div>
            </div>
        </div>
    </div>

    <div id="modal-manage" class="modal-overlay">
        <div class="manage-box-modal">
            <div class="manage-head">
                <span style="color:white; font-weight:bold; font-size:16px;">DASHBOARD FORNITORI</span>
                <button onclick="document.getElementById('modal-manage').style.display='none'" style="background:none; border:none; color:#888; font-size:24px; cursor:pointer;">√ó</button>
            </div>
            <div class="manage-body">
                <div class="manage-col">
                    <div class="col-title" style="color:#00e5ff;">ATTIVI</div>
                    <div class="col-list" id="list-active"></div>
                </div>
                <div class="manage-col">
                    <div class="col-title" style="color:#666;">ARCHIVIO</div>
                    <div class="col-list" id="list-archive"></div>
                </div>
            </div>
            <div class="new-client-box">
                <input type="text" id="new-client-name" class="inp-new" placeholder="Nome Nuovo Fornitore...">
                <button class="btn-save-new" onclick="addClient()">AGGIUNGI</button>
            </div>
        </div>
    </div>

    <div class="header-bar">
        <button class="btn-back" onclick="window.location.href='index.html'">‚¨Ö HOME</button>
        <div class="clients-scroll" id="clients-bar"></div>
        
        <button class="btn-manage" style="background:#f1c40f; color:black; border-color:#f1c40f;" onclick="apriScanner()">üì∑ SCANSIONA QR</button>
        
        <button class="btn-manage" onclick="openManage()">‚öôÔ∏è GESTISCI</button>
    </div>

    <div id="workspace">
        <div id="view-standard">
            <div class="tabs">
                <button class="tab-btn active" id="btn-lavori" onclick="switchTab('lavori')">LAVORI</button>
                <button class="tab-btn" id="btn-archivio" onclick="switchTab('archivio')">ARCHIVIO</button>
            </div>
            <div id="view-lavori" style="flex:1; overflow:hidden;">
                <div class="kanban" id="kanban-area"></div>
            </div>
            <div id="view-archivio" style="display:none; flex:1; overflow-y:auto;">
                <div class="archive-list"><button class="btn-add-archive" onclick="apriModalNuovoArticolo()">+ NUOVO ARTICOLO</button><div id="archive-list"></div></div>
            </div>
        </div>











    <div id="view-sandbox" class="sandbox-container" style="padding: 0; width: 100%; height: 100%;">
    
        <div class="sb-header-horizontal">

        <div style="font-size: 20px; font-weight: bold; color: #9b59b6;">
            üß™ PROVA 1 
        </div>
        

        <div class="sb-nav-group">
            <button class="sb-nav-btn active" id="sb-btn-lavori" onclick="switchSandboxTab('lavori')">LAVORI</button>
            <button class="sb-nav-btn" id="sb-btn-archivio" onclick="switchSandboxTab('archivio')">ARCHIVIO</button>
            <button class="sb-nav-btn" id="sb-btn-box1" onclick="switchSandboxTab('box1')">BOX 1</button>
            <button class="sb-nav-btn" id="sb-btn-box2" onclick="switchSandboxTab('box2')">BOX 2</button>
            <button class="sb-nav-btn" id="sb-btn-box3" onclick="switchSandboxTab('box3')">BOX 3</button>
        </div>
        </div>






    <div style="flex: 1; overflow: hidden; position: relative; width: 100%;">
        
        <div id="sb-view-lavori" style="display: flex; width: 100%; height: 100%;">
            <div class="sb-kanban-fullwidth">
                

                <div class="sb-col-equal">
                    <div class="sb-col-header">UFFICIO</div>
                    <div class="sb-col-body" id="sb-col-0"></div>
                </div>
                
                <div class="sb-col-equal">
                    <div class="sb-col-header">MAGAZZINO</div>
                    <div class="sb-col-body" id="sb-col-1"></div>
                </div>
                
                <div class="sb-col-equal">
                    <div class="sb-col-header">IN PRODUZIONE</div>
                    <div class="sb-col-body" id="sb-col-2">
                        <div class="sandbox-card" onclick="alert('Dettaglio...')">
                            <div class="sb-card-head">
                                <span class="sb-card-title">2024/001</span>
                                <span class="sb-card-badge">PRIORIT√Ä</span>
                            </div>
                            <div class="sb-card-body" style="font-size:12px; color:#aaa;">
                                <div><strong style="color:#9b59b6">CENTRALE:</strong> T-500</div>
                                <div><strong style="color:#9b59b6">DISEGNO:</strong> D-123</div>
                                <div style="margin-top:5px; color:white;">Lavorazione test...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sb-col-equal">
                    <div class="sb-col-header">PRONTI</div>
                    <div class="sb-col-body" id="sb-col-3"></div>
                </div>

                <div class="sb-col-equal">
                    <div class="sb-col-header">VERNICIATURA</div>
                    <div class="sb-col-body" id="sb-col-4"></div>
                </div>

                <div class="sb-col-equal">
                    <div class="sb-col-header">FINITI</div>
                    <div class="sb-col-body" id="sb-col-5"></div>
                </div>

                <div class="sb-col-equal">
                    <div class="sb-col-header">ARCHIVIO</div>
                    <div class="sb-col-body" id="sb-col-6"></div>
                </div>

            </div>
        </div>
        <div id="sb-view-archivio" style="display:none; padding:30px; width:100%; height:100%; box-sizing:border-box; overflow-y:auto;">
    

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px;">

        <h2 style="color:#9b59b6; margin:0; font-size:24px;">üóÇÔ∏è ARCHIVIO COMMESSE</h2>

        <button class="sb-btn-add" style="background:#222; border:1px solid #00e5ff; color:#00e5ff; margin-right:10px;" onclick="apriAnagraficaFornitori()">
          üè¢ GESTIONE FORNITORI
        </button>

        <button class="sb-btn-add" onclick="apriDashboardSandbox()">+ NUOVA COMMESSA</button>

        </div>




        <table class="sb-table">
        <table class="sb-table" style="width: 100%; table-layout: fixed;">
            <thead>
                <tr>
                    <th style="width: 50px; text-align:center;">IMG</th>
                    
                    <th>COMMESSA</th>
                    <th>CLIENTE</th>
                    <th>DATA</th>
                    <th>STATO</th>
                    <th>NOTE / FORNITORI</th>
                    
                    <th style="width: 320px; text-align:center;">AZIONI</th>
                </tr>
            </thead>
            <tbody id="sb-archive-table-body">
                <tr><td colspan="7" style="text-align:center; color:#666;">Caricamento...</td></tr>
            </tbody>
        </table>
        <tbody id="sb-archive-table-body">
            <tr><td colspan="6" style="text-align:center; color:#666;">Caricamento...</td></tr>
        </tbody>
        </table>
        </div>
        <div id="sb-view-box1" style="display:none; padding:50px; text-align:center;">CONTENUTO BOX 1</div> 
        <div id="sb-view-box2" style="display:none; padding:50px; text-align:center;">CONTENUTO BOX 2</div>
        <div id="sb-view-box3" style="display:none; padding:50px; text-align:center;">CONTENUTO BOX 3</div>
        </div>
    </div>




    </div>
    

    <div id="placeholder" style="text-align:center; padding:100px; color:#444; font-size: 14px; letter-spacing: 1px;">SELEZIONA UN CLIENTE DALLA BARRA IN ALTO</div>

    <div id="modal-sb-commessa" class="modal-overlay" style="display: none;">
    <div class="modal-box" style="width: 700px; height: auto; max-height:90%; border-color:#9b59b6;">
        
        <div class="modal-head" style="background:#2a1a35; border-bottom:1px solid #9b59b6;">
            <span class="mh-order-label" style="color:#9b59b6;">NUOVA COMMESSA</span>
            <button onclick="chiudiModalSbCommessa()" class="btn-close-modal">X</button>
        </div>

        <div class="modal-body" style="flex-direction: column; overflow-y: auto; gap: 15px;">
            
            <div style="display:flex; gap:15px;">
                <div style="flex:1;">
                    <label class="big-label" style="color:#9b59b6;">Numero Commessa / Nome</label>
                    <input type="text" id="sb-inp-nome" class="big-input" placeholder="Es. 2026/005">
                </div>
                <div style="flex:1;">
                    <label class="big-label" style="color:#9b59b6;">Cliente Finale</label>
                    <input type="text" id="sb-inp-cliente" class="big-input" placeholder="Es. Ferrero">
                </div>
            </div>

            <div style="display:flex; gap:15px;">
                <div style="flex:1;">
                    <label class="big-label">Stato Attuale</label>
                    <select id="sb-inp-stato" class="big-input" style="color:white; background:#222;">
                        <option value="UFFICIO">UFFICIO</option>
                        <option value="MAGAZZINO">MAGAZZINO</option>
                        <option value="IN PRODUZIONE">IN PRODUZIONE</option>
                        <option value="PRONTI">PRONTI</option>
                        <option value="VERNICIATURA">VERNICIATURA</option>
                        <option value="FINITI">FINITI</option>
                    </select>
                </div>
                <div style="flex:1;">
                    <label class="big-label">Data Apertura</label>
                    <input type="date" id="sb-inp-data" class="big-input">
                </div>
            </div>

            <div style="margin-top:10px;">
                <label class="big-label" style="color:#00e5ff;">üìù Lista Fornitori & Materiali Ordinati</label>
                <textarea id="sb-inp-note" class="big-input" style="height:120px; resize:none;" placeholder="Scrivi qui elenco fornitori, materiali mancanti, note urgenti..."></textarea>
            </div>

        </div>

        <div style="padding:20px; background:#111; text-align:right; border-top:1px solid #333;">
            <button class="btn-glass" style="border-color:#9b59b6; color:#9b59b6;" onclick="salvaSbCommessa()">SALVA DATI</button>
        </div>
    </div>
    </div>


        <div id="modal-dashboard-overlay" class="modal-overlay" style="display: none; justify-content: center; align-items: center;">
            <div class="modal-box" style="width: 98%; height: 95%; background: #181818; border: 2px solid #9b59b6; box-shadow: 0 0 30px rgba(155, 89, 182, 0.3); overflow: hidden; border-radius: 10px;">
                <div id="modal-dashboard-container" style="width: 100%; height: 100%; overflow-y: auto;">
                </div>
            </div>
        </div>




    <div id="modal-fornitori" class="modal-overlay" style="display: none; justify-content: center; align-items: center;">
        <div class="modal-box" style="width: 900px; height: 80%; background: #181818; border: 2px solid #00e5ff; display:flex; flex-direction:column;">
            
            <div style="padding:15px; background:#111; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="color:#00e5ff; margin:0;">üè¢ ANAGRAFICA FORNITORI</h3>
                <button onclick="document.getElementById('modal-fornitori').style.display='none'" style="background:none; border:none; color:#ccc; font-size:20px; cursor:pointer;">√ó</button>
            </div>

            <div style="flex:1; display:flex; overflow:hidden;">
                
                <div style="width:250px; background:#1a1a1a; border-right:1px solid #333; display:flex; flex-direction:column;">
                    <div style="padding:10px;">
                        <button onclick="nuovoFornitore()" style="width:100%; padding:10px; background:#00e5ff; border:none; color:black; font-weight:bold; cursor:pointer; border-radius:4px;">+ NUOVO FORNITORE</button>
                    </div>
                    <div id="lista-fornitori-sidebar" style="flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:5px;">
                        </div>
                </div>

                <div style="flex:1; padding:20px; overflow-y:auto; display:flex; flex-direction:column; gap:15px;">
                    
                    <input type="hidden" id="forn-id">

                    <div style="display:flex; gap:20px;">
                        <div style="width:120px; height:120px; border:2px dashed #444; display:flex; align-items:center; justify-content:center; cursor:pointer; position:relative; overflow:hidden;"
                            onclick="document.getElementById('upload-logo-forn').click()">
                            <img id="prev-logo-forn" style="width:100%; height:100%; object-fit:contain; display:none;">
                            <span id="place-logo-forn" style="color:#666; font-size:10px; text-align:center;">LOGO<br>(Clicca)</span>
                            <input type="file" id="upload-logo-forn" accept="image/*" style="display:none" onchange="previewLogoFornitore(this)">
                        </div>

                        <div style="flex:1; display:flex; flex-direction:column; gap:10px;">
                            <div>
                                <label style="color:#888; font-size:11px;">RAGIONE SOCIALE (Nome che appare nel PDF)</label>
                                <input type="text" id="forn-nome" class="input-dark" style="width:100%; font-weight:bold; color:#00e5ff; font-size:16px;">
                            </div>
                            <div>
                                <label style="color:#888; font-size:11px;">ALIAS / NOME BREVE (Per la tabella)</label>
                                <input type="text" id="forn-alias" class="input-dark" style="width:100%;" placeholder="Es. Tomatis">
                            </div>
                        </div>
                    </div>

                    <div style="display:flex; gap:15px;">
                        <div style="flex:1;">
                            <label style="color:#888; font-size:11px;">INDIRIZZO COMPLETO</label>
                            <input type="text" id="forn-indirizzo" class="input-dark" style="width:100%;" placeholder="Via Roma 1, 10100 Torino">
                        </div>
                        <div style="flex:1;">
                            <label style="color:#888; font-size:11px;">P.IVA / C.F.</label>
                            <input type="text" id="forn-piva" class="input-dark" style="width:100%;">
                        </div>
                    </div>

                    <div style="display:flex; gap:15px;">
                        <div style="flex:1;">
                            <label style="color:#888; font-size:11px;">EMAIL (Per invio ordini)</label>
                            <input type="text" id="forn-email" class="input-dark" style="width:100%;">
                        </div>
                        <div style="flex:1;">
                            <label style="color:#888; font-size:11px;">TELEFONO</label>
                            <input type="text" id="forn-tel" class="input-dark" style="width:100%;">
                        </div>
                    </div>

                    <div style="display:flex; gap:15px;">
                        <div style="flex:1;">
                            <label style="color:#888; font-size:11px;">TERMINI DI PAGAMENTO</label>
                            <input type="text" id="forn-pagamento" class="input-dark" style="width:100%;" placeholder="Es. 30 gg D.F.F.M">
                        </div>
                        <div style="flex:1;">
                            <label style="color:#888; font-size:11px;">RESA / CONSEGNA</label>
                            <input type="text" id="forn-consegna" class="input-dark" style="width:100%;" placeholder="Es. Franco ns. sede">
                        </div>
                    </div>

                    <div style="text-align:right; margin-top:20px; padding-top:10px; border-top:1px solid #333;">
                        <button onclick="salvaFornitore()" style="padding:10px 30px; background:#00e5ff; color:black; font-weight:bold; border:none; cursor:pointer; border-radius:4px;">SALVA FORNITORE</button>
                    </div>

                </div>
            </div>
        </div>
    </div>







    <div id="modal-crea-richiesta" class="modal-overlay" style="display: none; justify-content: center; align-items: center;">
    <div class="modal-box" style="width: 1000px; height: 90%; background: #181818; border: 2px solid #f1c40f; display:flex; flex-direction:column;">
    
    <div style="padding:20px; background:#111; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
    <div>
    <h3 style="color:#f1c40f; margin:0; text-transform:uppercase;">üõí NUOVA RICHIESTA DI PREVENTIVO</h3>
    <span style="color:#888; font-size:12px;">Seleziona i fornitori a cui vuoi chiedere il prezzo per questi articoli.</span>
    </div>
    <button onclick="document.getElementById('modal-crea-richiesta').style.display='none'" style="background:none; border:none; color:#ccc; font-size:20px; cursor:pointer;">√ó</button>
    </div>

    <div style="flex:1; display:flex; overflow:hidden;">
    
    <div style="flex:2; border-right:1px solid #333; display:flex; flex-direction:column; background:#1a1a1a;">
    <div style="padding:10px; background:#222; border-bottom:1px solid #333; color:#f1c40f; font-weight:bold; font-size:12px;">
    ARTICOLI NEL CARRELLO
    </div>
    <div id="lista-carrello-body" style="flex:1; overflow-y:auto; padding:10px;">
    </div>
    </div>

    <div style="flex:1; padding:20px; display:flex; flex-direction:column; gap:20px; background:#111;">
    
    <div>
    <label style="color:#f1c40f; font-size:12px; font-weight:bold; margin-bottom:10px; display:block;">1. SELEZIONA FORNITORI (Multiselect)</label>
    <div id="box-scelta-fornitori" style="height:200px; overflow-y:auto; border:1px solid #444; background:#222; padding:5px; border-radius:4px;">
    </div>
    </div>

    <div style="padding-top:20px; border-top:1px solid #333;">
    <label style="color:#f1c40f; font-size:12px; font-weight:bold; margin-bottom:10px; display:block;">2. GENERA DOCUMENTI</label>
    <div style="display:flex; flex-direction:column; gap:10px;">




    <button onclick="generaPdfRichiesta()" style="padding:15px; background:#333; border:1px solid #555; color:white; font-weight:bold; cursor:pointer; text-align:left; display:flex; align-items:center; gap:10px; border-radius:6px;">
    <span style="font-size:20px;">üìÑ</span> GENERA PDF RICHIESTA
    </button>









    <button onclick="alert('In arrivo nello Step 3!')" style="padding:15px; background:#333; border:1px solid #555; color:white; font-weight:bold; cursor:pointer; text-align:left; display:flex; align-items:center; gap:10px; border-radius:6px;">
    <span style="font-size:20px;">üìä</span> GENERA EXCEL RICHIESTA
    </button>
    </div>
    </div>

    </div>
    </div>
    </div>
    </div>






    <div id="modal-comparatore" class="modal-overlay" style="display: none; justify-content: center; align-items: center;">
        <div class="modal-box" style="width: 95%; height: 95%; background: #181818; border: 2px solid #3498db; display:flex; flex-direction:column;">
            
            <div style="padding:15px; background:#111; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h3 style="color:#3498db; margin:0;">‚öñÔ∏è COMPARATORE PREZZI & SCELTA FORNITORE</h3>
                    <span style="color:#888; font-size:12px;">Seleziona i fornitori da confrontare, inserisci i prezzi unitari e scegli il vincitore.</span>
                </div>
                <button onclick="document.getElementById('modal-comparatore').style.display='none'" style="background:none; border:none; color:#ccc; font-size:20px; cursor:pointer;">√ó</button>
            </div>

            <div style="padding:15px; background:#222; border-bottom:1px solid #333; display:flex; align-items:center; gap:15px;" id="box-check-competitors">
                <span style="color:#3498db; font-weight:bold; font-size:12px;">CHI HA RISPOSTO?</span>
                </div>

            <div style="flex:1; overflow:auto; padding:10px;">
                <table style="width:100%; border-collapse:collapse; font-size:12px; min-width:1000px;">
                    <thead id="head-comparatore" style="background:#1a1a1a; color:#aaa; position:sticky; top:0; z-index:10;">
                        </thead>
                    <tbody id="body-comparatore">
                        </tbody>
                </table>
            </div>

            <div id="footer-comparatore" style="padding:20px; background:#111; border-top:1px solid #333; display:flex; justify-content:flex-end; gap:20px;">
                </div>

        </div>
    </div>




































    



    <div id="modal-crea-richiesta" class="modal-overlay" style="display: none; justify-content: center; align-items: center;">
        <div class="modal-box" style="width: 1000px; height: 90%; background: #181818; border: 2px solid #f1c40f; display:flex; flex-direction:column;">
            
            <div style="padding:20px; background:#111; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h3 style="color:#f1c40f; margin:0; text-transform:uppercase;">üõí NUOVA RICHIESTA DI PREVENTIVO</h3>
                    <span style="color:#888; font-size:12px;">Seleziona i fornitori a cui vuoi chiedere il prezzo per questi articoli.</span>
                </div>
                <button onclick="document.getElementById('modal-crea-richiesta').style.display='none'" style="background:none; border:none; color:#ccc; font-size:20px; cursor:pointer;">√ó</button>
            </div>

            <div style="flex:1; display:flex; overflow:hidden;">
                
                <div style="flex:2; border-right:1px solid #333; display:flex; flex-direction:column; background:#1a1a1a;">
                    <div style="padding:10px; background:#222; border-bottom:1px solid #333; color:#f1c40f; font-weight:bold; font-size:12px;">
                        ARTICOLI NEL CARRELLO
                    </div>
                    <div id="lista-carrello-body" style="flex:1; overflow-y:auto; padding:10px;">
                        </div>
                </div>

                <div style="flex:1; padding:20px; display:flex; flex-direction:column; gap:20px; background:#111;">
                    
                    <div>
                        <label style="color:#f1c40f; font-size:12px; font-weight:bold; margin-bottom:10px; display:block;">1. SELEZIONA FORNITORI (Multiselect)</label>
                        <div id="box-scelta-fornitori" style="height:200px; overflow-y:auto; border:1px solid #444; background:#222; padding:5px; border-radius:4px;">
                            </div>
                    </div>

                    <div style="padding-top:20px; border-top:1px solid #333;">
                        <label style="color:#f1c40f; font-size:12px; font-weight:bold; margin-bottom:10px; display:block;">2. GENERA DOCUMENTI</label>
                        <div style="display:flex; flex-direction:column; gap:10px;">
                            <button onclick="alert('In arrivo nello Step 3!')" style="padding:15px; background:#333; border:1px solid #555; color:white; font-weight:bold; cursor:pointer; text-align:left; display:flex; align-items:center; gap:10px; border-radius:6px;">
                                <span style="font-size:20px;">üìÑ</span> GENERA PDF RICHIESTA
                            </button>
                            <button onclick="alert('In arrivo nello Step 3!')" style="padding:15px; background:#333; border:1px solid #555; color:white; font-weight:bold; cursor:pointer; text-align:left; display:flex; align-items:center; gap:10px; border-radius:6px;">
                                <span style="font-size:20px;">üìä</span> GENERA EXCEL RICHIESTA
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>











<div id="pdf-template-container" style="position:fixed; top:-9999px; left:-9999px; width:210mm; background:white; color:black; font-family:'Segoe UI', sans-serif;">
    <div id="pdf-page" style="padding:15mm; min-height:297mm; box-sizing:border-box; position:relative;">
        
        <div style="display:flex; justify-content:space-between; margin-bottom:10mm;">
            <div style="width:45%; font-size:10pt;">
                <h2 style="margin:0 0 5px 0; color:#000;">Carpenteria Pesa s.r.l.</h2>
                <div>Strada Provinciale 12, N¬∞ 28</div>
                <div>12060, Bastia Mondov√¨ (CN)</div>
                <div>P.IVA/C.F. 03687090047</div>
                <div style="margin-top:5px;">Tel. 0174.60.555</div>
                <div>Email: info@carpenteriapesasrl.it</div>
            </div>
            
            <div style="width:45%; border:1px solid #000; padding:10px; border-radius:4px;">
                <div style="font-size:9pt; color:#666;">Spett.le</div>
                <div id="pdf-forn-nome" style="font-weight:bold; font-size:12pt; margin:5px 0;">FORNITORE S.R.L.</div>
                <div id="pdf-forn-indirizzo" style="font-size:10pt;">Via Roma 1</div>
                <div id="pdf-forn-citta" style="font-size:10pt;">10100 Torino</div>
                <div style="margin-top:5px; font-size:10pt;">P.IVA: <span id="pdf-forn-piva">---</span></div>
            </div>
        </div>

        <div style="border-top:2px solid #000; border-bottom:2px solid #000; padding:10px 0; margin-bottom:10mm; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h3 style="margin:0;">RICHIESTA DI PREVENTIVO</h3>
                <div style="font-size:10pt;">Rif. Commessa: <span id="pdf-commessa">---</span></div>
            </div>
            <div style="text-align:right; font-size:10pt;">
                <div>Data: <span id="pdf-data">---</span></div>
                <div>Richiesta N¬∞: <span id="pdf-num">---</span></div>
            </div>
        </div>

        <div style="font-size:10pt; margin-bottom:10mm;">
            Buongiorno,<br>
            si prega di inviare Vostra migliore offerta e data di consegna per i seguenti articoli:
        </div>

        <table style="width:100%; border-collapse:collapse; font-size:9pt;">
            <thead style="background:#eee;">
                <tr>
                    <th style="border:1px solid #000; padding:5px; text-align:left;">POS</th>
                    <th style="border:1px solid #000; padding:5px; text-align:left;">DISEGNO</th>
                    <th style="border:1px solid #000; padding:5px; text-align:left;">DESCRIZIONE / MISURE</th>
                    <th style="border:1px solid #000; padding:5px; text-align:center;">Q.TA'</th>
                    <th style="border:1px solid #000; padding:5px; text-align:center;">NOTE</th>
                </tr>
            </thead>
            <tbody id="pdf-table-body">
                </tbody>
        </table>

        <div style="position:absolute; bottom:15mm; left:15mm; right:15mm; text-align:center; font-size:8pt; border-top:1px solid #ccc; padding-top:5px; color:#666;">
            Carpenteria Pesa s.r.l. - Documento generato digitalmente dalla Sandbox
        </div>

    </div>
</div>



    <div id="modal-qr" class="modal-overlay" style="display: none; justify-content: center; align-items: center; z-index: 10000;">
        <div class="modal-box" style="width: 400px; height: auto; background: #181818; border: 2px solid #3498db; display:flex; flex-direction:column; align-items:center; padding: 30px; border-radius: 10px; box-shadow: 0 0 30px rgba(52, 152, 219, 0.4);">
            <h3 style="color:#3498db; margin-top:0; margin-bottom: 5px;">QR CODE COMMESSA</h3>
            <h4 id="qr-titolo-commessa" style="color:white; margin-top: 0; margin-bottom: 25px; font-size: 18px;">---</h4>
            
            <div id="box-qrcode" style="background: white; padding: 15px; border-radius: 8px; border: 4px solid #fff;"></div>
            
            <div style="margin-top:30px; display:flex; gap:15px; width: 100%; justify-content: center;">
                <button onclick="stampaSoloQR()" style="background:#27ae60; color:white; border:none; padding:10px 20px; border-radius:4px; font-weight:bold; cursor:pointer;">üñ®Ô∏è STAMPA ETICHETTA</button>
                <button onclick="document.getElementById('modal-qr').style.display='none'" style="background:transparent; border:1px solid #555; color:#ccc; padding:10px 20px; border-radius:4px; cursor:pointer;">CHIUDI</button>
            </div>
        </div>
    </div>



    <div id="modal-scanner" class="modal-overlay" style="display: none; justify-content: center; align-items: center; z-index: 10001;">
        <div class="modal-box" style="width: 90%; max-width: 500px; height: auto; background: #181818; border: 2px solid #f1c40f; display:flex; flex-direction:column; align-items:center; padding: 20px; border-radius: 10px;">
            <h3 style="color:#f1c40f; margin-top:0; margin-bottom: 15px;">INQUADRA IL QR CODE</h3>
            
            <div id="qr-reader" style="width: 100%; min-height:300px; background:black; border-radius:8px; overflow:hidden;"></div>
            
            <button onclick="chiudiScanner()" style="margin-top:20px; background:transparent; border:1px solid #555; color:#ccc; padding:15px; border-radius:4px; cursor:pointer; width:100%; font-weight:bold;">ANNULLA / CHIUDI FOTOCAMERA</button>
        </div>
    </div>












































































    <script>
    const firebaseConfig = { apiKey: "AIzaSyCfFDdtzkZLClamp-Z_iODl8KQbBevEAfg", authDomain: "planner-carpenteria.firebaseapp.com", databaseURL: "https://planner-carpenteria-default-rtdb.europe-west1.firebasedatabase.app", projectId: "planner-carpenteria", storageBucket: "planner-carpenteria.firebasestorage.app", messagingSenderId: "926532216818", appId: "1:926532216818:web:927f43972c81bbf580ed6b" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // GESTIONE CLIENTI DINAMICA
    let allClients = JSON.parse(localStorage.getItem('my_clients')) || [
        { name: "Altro", active: true },
        { name: "F.R. srl", active: true },
        { name: "Fond-Stamp", active: true },
        { name: "Scotta", active: true },
        { name: "Tomatis", active: true },
        { name: "Tre Emme", active: true },
        { name: "Prova 1", active: true } // Aggiunto per il test
    ];

    // Se "Prova 1" non esiste nel localStorage salvato, aggiungilo
    if(!allClients.find(c => c.name === "Prova 1")) {
        allClients.push({name: "Prova 1", active: true});
        localStorage.setItem('my_clients', JSON.stringify(allClients));
    }

    const stati = ["ANCORA DA ORDINARE", "In Attesa di Materiale", "In Produzione", "Pronto per la Spedizione", "Ordini Chiusi", "Archiviati"];
    const stages = {
        stage1: { title: "IN ATTESA MATERIALE", items: ["Commerciale", "Sagomati", "Laser Tubo"] },
        stage2: { title: "IN PRODUZIONE", items: ["Assemblaggio", "Saldatura", "Lavorazioni Esterne", "Provati", "Numerati"] },
        stage3: { title: "PRONTO SPEDIZIONE", items: ["Finiti Grezzi", "Verniciati", "Pronti x Verniciatura"] }
    };




    let currentClient = null;
    let currentArtId = null;
    let currentArtImg = null;
    // --- NUOVE VARIABILI PER IL QR STANDARD ---
    let currentStandardCommessaId = null; 
    let currentStandardCommessaNome = null;





    
    // --- VARIABILE AGGIUNTA PER MODIFICA SANDBOX ---
    let currentSbEditId = null; // Variabile per tracciare se stiamo modificando

    window.onload = function() {
        try {
            const parametriUrl = new URLSearchParams(window.location.search);
            const idDalQR = parametriUrl.get('qr');
            const clienteDalQR = parametriUrl.get('cliente'); // Legge anche il cliente!

            if (idDalQR) {
                // üö® ENTRATA DA QR CODE (Link diretto)
                gestisciAccessoDaQR(idDalQR, clienteDalQR);
            } else {
                // üè¢ ACCESSO NORMALE DALL'UFFICIO
                if(localStorage.getItem('auth_token') !== 'logged_in') {
                    window.location.href = 'index.html';
                    return; 
                }
                renderClientsBar();
            }
        } catch (errore) {
            alert("ERRORE DI AVVIO: " + errore.message);
        }
    };

    // =========================================================
    // üö¶ IL VIGILE URBANO: SMISTA LE COMMESSE (SANDBOX VS STANDARD)
    // =========================================================
    function gestisciAccessoDaQR(id, cliente) {
        // Mostro schermata di caricamento
        const boxPlaceholder = document.getElementById('placeholder');
        boxPlaceholder.style.display = 'block';
        boxPlaceholder.innerHTML = "<h2 style='color:#00ff88; margin-top:100px;'>‚è≥ Caricamento Commessa in corso...</h2><p style='color:#ccc;'>Estrazione dati...</p>";

        // BIVIO LOGICO
        if (!cliente || cliente === "Prova 1") {
            // STRADA A: √à LA SANDBOX (La nuova mega-dashboard)
            currentClient = "Prova 1";
            apriDashboardProduzione(id);
        } else {
            // STRADA B: √à UN CLIENTE STANDARD (Tre Emme, Scotta, ecc.)
            currentClient = cliente;
            
            // Scarico i dati della commessa da Firebase
            db.ref('commesse/' + cliente + '/' + id).once('value').then(snap => {
                let datiCommessa = snap.val();
                
                if (datiCommessa) {
                    // Prepara l'interfaccia standard (nascondo il nero, mostro l'ufficio)
                    boxPlaceholder.style.display = 'none';
                    document.getElementById('workspace').style.display = 'flex';
                    document.getElementById('view-standard').style.display = 'block';
                    document.getElementById('view-sandbox').style.display = 'none';

                    // Teletrasporto: Apro direttamente la tua vecchia modale!
                    openModal(id, datiCommessa);
                } else {
                    alert("‚ùå ERRORE: Commessa non trovata nel database del cliente " + cliente);
                    boxPlaceholder.innerHTML = "<h2 style='color:red;'>Commessa non trovata!</h2>";
                }
            }).catch(error => {
                alert("Errore di connessione: " + error.message);
            });
        }
    }

    function renderClientsBar() {
        const bar = document.getElementById('clients-bar');
        bar.innerHTML = "";
        allClients.forEach(c => {
            if(c.active) {
                bar.innerHTML += `<button class="btn-client" onclick="selectClient('${c.name}', this)">${c.name}</button>`;
            }
        });
    }

    // --- SELEZIONE CLIENTE (CON SEMAFORO) ---
    function selectClient(c, btn) {
        currentClient = c;
        document.querySelectorAll('.btn-client').forEach(b => b.classList.remove('selected'));
        if(btn) btn.classList.add('selected');
        document.getElementById('placeholder').style.display = 'none';
        document.getElementById('workspace').style.display = 'flex';

        // --- BIVIO ---
        if (c === "Prova 1") {
            // MOSTRA SANDBOX, NASCONDI STANDARD
            document.getElementById('view-standard').style.display = 'none';
            document.getElementById('view-sandbox').style.display = 'flex';
            renderSandbox(); // Funzione isolata
        } else {
            // MOSTRA STANDARD, NASCONDI SANDBOX
            document.getElementById('view-standard').style.display = 'block';
            document.getElementById('view-sandbox').style.display = 'none';
            loadKanban();
            loadArchive();
        }
    }

















    // =======================================================================
    // AREA SANDBOX - SOLO PER CLIENTE "PROVA 1" (V4.0)
    // =======================================================================
    // =======================================================================
    // AREA SANDBOX - SOLO PER CLIENTE "PROVA 1" (V4.0)
    // =======================================================================
    // --- FUNZIONE SANDBOX ISOLATA ---
    // --- LORENZO + GEMINI RICOMINCIANO IL 08/02/2026 --- 




// =======================================================================
// AREA SANDBOX - SOLO PER CLIENTE "PROVA 1" (V4.0)
// =======================================================================

function renderSandbox() {
    const container = document.getElementById('view-sandbox');
    
    // Assicuriamoci che il container sia visibile e formattato correttamente
    container.style.display = 'flex';
    container.style.flexDirection = 'column'; 
    container.style.width = '100%';
    container.style.height = '100%';

    console.log("Sandbox Inizializzata");

    // --- FIX DI LORENZO ---
    // Appena entro, simulo il click sul tasto "LAVORI" per caricare i dati e le colonne!
    switchSandboxTab('lavori'); 
}




/* INIZIO -- FUNZIONE AGGIUNTA DA LORENZO X POTER CLICCARE I BOTTONI DI SCELTA - LAVORI - ARCHIVIO - BOX 123 -- 08/02/2026 */
// --- FUNZIONE PER CAMBIARE SCHEDA (TAB) NELLA SANDBOX ---
function switchSandboxTab(tabName) { 
    
    // --- 1. GESTIONE GRAFICA DEI BOTTONI ---
    const allBtns = document.querySelectorAll('.sb-nav-btn'); 
    allBtns.forEach(btn => { 
        btn.classList.remove('active'); 
    }); 

    const btnClicked = document.getElementById('sb-btn-' + tabName); 
    if (btnClicked) { 
        btnClicked.classList.add('active'); 
    }

    // --- 2. GESTIONE DELLE VISTE ---
    document.getElementById('sb-view-lavori').style.display = 'none'; 
    document.getElementById('sb-view-archivio').style.display = 'none'; 
    document.getElementById('sb-view-box1').style.display = 'none'; 
    document.getElementById('sb-view-box2').style.display = 'none'; 
    document.getElementById('sb-view-box3').style.display = 'none'; 

    // Ora mostriamo solo quello richiesto
    const viewToShow = document.getElementById('sb-view-' + tabName); 

    if (viewToShow) { 
        if (tabName === 'lavori') { 
            viewToShow.style.display = 'flex'; 
            
            // --- QUI C'√à LA MODIFICA! ---
            // Carico i dati della Kanban solo quando apro questa scheda
            caricaKanbanSandbox(); 
            // ----------------------------

        } else { 
            viewToShow.style.display = 'block'; 
        }
    }
    
    // Se apro archivio, ricarico i dati
    if(tabName === 'archivio') {
        caricaArchivioSandbox();
    }
}
    /* FINE -- FUNZIONE AGGIUNTA DA LORENZO X POTER CLICCARE I BOTTONI DI SCELTA - LAVORI - ARCHIVIO - BOX 123 -- 08/02/2026 */



















    // --- FINE SANDBOX ---




    // =======================================================================
    // FINE AREA SANDBOX
    // =======================================================================
    // =======================================================================
    // FINE AREA SANDBOX
    // =======================================================================











    // --- FUNZIONI STANDARD (NON TOCCATE) ---
    function switchTab(t) {
        document.getElementById('view-lavori').style.display = t==='lavori'?'block':'none';
        document.getElementById('view-archivio').style.display = t==='archivio'?'block':'none';
        document.getElementById('btn-lavori').className = t==='lavori'?'tab-btn active':'tab-btn';
        document.getElementById('btn-archivio').className = t==='archivio'?'tab-btn active':'tab-btn';
    }

    function loadKanban() {
        const k = document.getElementById('kanban-area'); k.innerHTML = "";
        stati.forEach((s, i) => {
            k.innerHTML += `<div class="col"><div class="col-head">${s}</div><div class="col-body" id="col-${i}"></div></div>`;
        });
        db.ref('commesse/' + currentClient).on('value', snap => {
            for(let i=0; i<stati.length; i++) {
                let col = document.getElementById(`col-${i}`);
                if(col) col.innerHTML="";
            }
            let data = snap.val(); if(!data) return;
            for(let id in data) {
                let d = data[id];
                // Ignora le commesse sandbox nella vista standard
                if(d.layout === 'sandbox') continue;

                let card = document.createElement('div'); card.className = 'card';
                card.onclick = () => openModal(id, d);
                card.innerHTML = `
                    <div class="card-details">
                        <span>Matr: ${d.matricola}</span><span class="detail-sep">|</span><span>N¬∞ Dis: ${d.disegno}</span>
                    </div>
                    <div class="card-top">
                        <div class="card-title">${d.nomeOrdine}</div>
                        <div class="card-badge">Q.t√†: ${d.qtaTotale}</div>
                    </div>
                    <div class="card-foot">
                        <button class="btn-mini btn-del" onclick="del('${id}', event)">‚úñ</button>
                        <div class="btn-group-right">
                            ${d.stato > 0 ? `<button class="btn-mini btn-move" onclick="move('${id}', ${d.stato-1}, event)">‚óÄ</button>` : ''}
                            ${d.stato < stati.length-1 ? `<button class="btn-mini btn-move" onclick="move('${id}', ${d.stato+1}, event)">‚ñ∂</button>` : ''}
                        </div>
                    </div>
                `;
                let col = document.getElementById(`col-${d.stato}`);
                if(col) col.appendChild(card);
            }
        });
    }

    function move(id, s, e) { e.stopPropagation(); if(s>=0 && s<stati.length) db.ref('commesse/'+currentClient+'/'+id).update({stato:s}); }
    function del(id, e) { e.stopPropagation(); if(confirm("Eliminare?")) db.ref('commesse/'+currentClient+'/'+id).remove(); }





    function openModal(id, d) {


        // Salvo in memoria l'ID e il Nome per il QR Code
        currentStandardCommessaId = id;
        currentStandardCommessaNome = d.nomeOrdine;

        document.getElementById('m-title').innerText = "N¬∞ Ordine: " + d.nomeOrdine;
        // ... (il resto della funzione rimane identico, non toccare nulla!)



        document.getElementById('m-title').innerText = "N¬∞ Ordine: " + d.nomeOrdine;
        document.getElementById('m-matr').innerText = (d.matricola || '-');
        document.getElementById('m-dis').innerText = (d.disegno || '-');
        document.getElementById('m-qta').innerText = (d.qtaTotale || '-');
        
        let imgBox = document.getElementById('mh-icon-box');
        if(d.immagine) imgBox.innerHTML = `<img src="${d.immagine}" style="width:50px; height:50px; border-radius:5px; object-fit:contain;">`;
        else imgBox.innerHTML = "üì¶";

        const fc = document.getElementById('fasi-container'); fc.innerHTML = "";
        Object.keys(stages).forEach(k => {
            let conf = stages[k];
            let html = `<div class="stage-box"><div class="stage-title">${conf.title}</div>`;
            conf.items.forEach(i => {
                let checked = d.checklist && d.checklist[k] && d.checklist[k][i];
                html += `<div class="chk-row" onclick="toggleChk('${id}','${k}','${i}', this)"><div class="check-box ${checked?'checked':''}"></div> <div style="font-weight:500;">${i}</div></div>`;
            });
            html += `</div>`;
            fc.innerHTML += html;
        });

        const dc = document.getElementById('distinta-container'); dc.innerHTML = "Caricamento...";
        db.ref('archivio/' + currentClient).orderByChild('matricola').equalTo(d.matricola).once('value', snap => {
            dc.innerHTML = "";
            let arts = snap.val();
            if(arts) {
                let art = Object.values(arts)[0];
                if(art.componenti) {
                    art.componenti.forEach((c, idx) => {
                        let cid = `comp_${idx}`;
                        let checked = d.checklist && d.checklist.distintaBase && d.checklist.distintaBase[cid];
                        let qUnit = parseInt(c.qta)||0;
                        let qTot = qUnit * (parseInt(d.qtaTotale)||1);
                        let saved = (d.checklist && d.checklist.distintaDati && d.checklist.distintaDati[cid]) || {};
                        let qArr = saved.qtaArr ? parseInt(saved.qtaArr) : 0;
                        let perc = qTot > 0 ? Math.min(100, Math.round((qArr / qTot) * 100)) : 0;
                        let colorPerc = perc === 100 ? '#00ff88' : (perc > 0 ? '#f1c40f' : '#666');
                        let imgSrc = c.iconaBase64 || c.iconaBase || c.immagine || "";
                        let iconHtml = imgSrc ? `<img src="${imgSrc}" class="part-icon-thumb">` : `<div class="part-icon-placeholder">üì∑</div>`;

                        let row = document.createElement('div'); row.className = `distinta-row-item ${checked?'checked':''}`;
                        row.innerHTML = `
                            <div class="d-cell"><div class="check-box ${checked?'checked':''}" onclick="toggleDist('${id}','${cid}',this)"></div></div>
                            <div class="d-cell">${idx+1}</div>
                            <div class="d-cell">${iconHtml}</div>
                            <div class="d-cell">${c.fornitore}</div>
                            <div class="d-cell" style="color:#E94560;">${c.matricola}</div>
                            <div class="d-cell">${c.disegno}</div>
                            <div class="d-cell">${qUnit}</div>
                            <div class="d-cell" style="color:#00ff88; font-weight:bold;">${qTot}</div>
                            <div class="d-cell"><input class="inp-mini" type="number" value="${saved.qtaArr||''}" oninput="updatePerc(this, ${qTot}, this.parentElement.nextElementSibling.nextElementSibling)" onchange="saveDistData('${id}','${cid}','qtaArr',this.value)"></div>
                            <div class="d-cell"><input class="inp-mini" type="text" value="${saved.ddt||''}" onchange="saveDistData('${id}','${cid}','ddt',this.value)"></div>
                            <div class="d-cell" style="color:${colorPerc}; font-weight:bold;">${perc}%</div>
                            <div class="d-cell left">${c.denominazione}</div>
                            <div class="d-cell">${c.materiale}</div>
                        `;
                        dc.appendChild(row);
                    });
                }
            } else { dc.innerHTML = "Articolo non trovato in archivio."; }
        });
        document.getElementById('modal-overlay').style.display = 'flex';
    }




    window.updatePerc = function(input, qTot, percCell) {
        let val = parseInt(input.value) || 0;
        let p = qTot > 0 ? Math.min(100, Math.round((val/qTot)*100)) : 0;
        percCell.innerText = p + "%";
        percCell.style.color = p === 100 ? '#00ff88' : (p > 0 ? '#f1c40f' : '#666');
    }

    window.toggleChk = function(id, s, i, row) { 
        let box = row.querySelector('.check-box');
        let isChecked = box.classList.contains('checked');
        if(isChecked) box.classList.remove('checked'); else box.classList.add('checked');
        db.ref(`commesse/${currentClient}/${id}/checklist/${s}/${i}`).set(!isChecked);
    }

    window.toggleDist = function(id, cid, div) { 
        let isC = div.classList.contains('checked');
        db.ref(`commesse/${currentClient}/${id}/checklist/distintaBase/${cid}`).set(!isC);
        let row = div.closest('.distinta-row-item');
        if(!isC) { div.classList.add('checked'); row.classList.add('checked'); }
        else { div.classList.remove('checked'); row.classList.remove('checked'); }
    }
    window.saveDistData = function(id, cid, f, v) { db.ref(`commesse/${currentClient}/${id}/checklist/distintaDati/${cid}/${f}`).set(v); }

    function loadArchive() {
        const l = document.getElementById('archive-list'); l.innerHTML = "Caricamento...";
        db.ref('archivio/' + currentClient).on('value', snap => {
            l.innerHTML = ""; let data = snap.val();
            if(!data) { l.innerHTML = "Nessun articolo."; return; }
            for(let id in data) {
                let a = data[id];
                let imgSrc = a.immagine ? `<img src="${a.immagine}" class="arch-img">` : `<div class="arch-img" style="background:#333; display:flex; align-items:center; justify-content:center;">üì¶</div>`;
                l.innerHTML += `
                    <div class="arch-item">
                        ${imgSrc}
                        <div class="arch-info">
                            <div style="font-size:20px; font-weight:bold; color:#E94560;">${a.matricola}</div>
                            <div>${a.desc}</div>
                        </div>
                        <div class="arch-actions">
                            <button class="btn-glass green" onclick="produci('${id}')">PRODUCI</button>
                            <button class="btn-glass yellow" onclick="modificaArticolo('${id}')">MODIFICA</button>
                            <button class="btn-glass red" onclick="eliminaArticolo('${id}')">ELIMINA</button>
                        </div>
                    </div>
                `;
            }
        });
    }

    window.produci = function(aid) {
        db.ref('archivio/'+currentClient+'/'+aid).once('value', s=>{
            let a = s.val();
            let nome = prompt("Nome Ordine:", "Lotto X");
            let q = prompt("Quantit√†:", "1");
            if(nome && q) {
                db.ref('commesse/'+currentClient).push({
                    nomeOrdine: nome, qtaTotale: q, stato: 0,
                    matricola: a.matricola, disegno: a.disegno, 
                    data: new Date().toISOString(), immagine: a.immagine
                });
                alert("Creato!");
                switchTab('lavori');
            }
        });
    }

    function apriModalNuovoArticolo() {
        currentArtId = null; currentArtImg = null;
        document.getElementById('art-modal-title').innerText = "NUOVO ARTICOLO";
        document.getElementById('new-matr').value = "";
        document.getElementById('new-dis').value = "";
        document.getElementById('new-desc').value = "";
        document.getElementById('comp-body').innerHTML = "";
        document.getElementById('art-preview').src = ""; document.getElementById('art-preview').style.display='none';
        document.getElementById('art-placeholder').style.display='block';
        document.getElementById('modal-articolo').style.display = 'flex';
        aggiungiRigaComp();
    }

    window.modificaArticolo = function(id) {
        currentArtId = id;
        document.getElementById('art-modal-title').innerText = "MODIFICA ARTICOLO";
        db.ref('archivio/'+currentClient+'/'+id).once('value', s=>{
            let a = s.val();
            document.getElementById('new-matr').value = a.matricola;
            document.getElementById('new-dis').value = a.disegno;
            document.getElementById('new-desc').value = a.desc;
            if(a.immagine) {
                currentArtImg = a.immagine;
                document.getElementById('art-preview').src = a.immagine;
                document.getElementById('art-preview').style.display='block';
                document.getElementById('art-placeholder').style.display='none';
            }
            document.getElementById('comp-body').innerHTML = "";
            if(a.componenti) a.componenti.forEach(c => aggiungiRigaComp(c));
            else aggiungiRigaComp();
            document.getElementById('modal-articolo').style.display = 'flex';
        });
    }

    window.eliminaArticolo = function(id) { if(confirm("Eliminare da archivio?")) db.ref('archivio/'+currentClient+'/'+id).remove(); }
    window.chiudiModalArticolo = function() { document.getElementById('modal-articolo').style.display='none'; }

    window.salvaArticolo = function() {
        let m = document.getElementById('new-matr').value;
        if(!m) return alert("Matricola obbligatoria");
        
        let comps = [];
        document.querySelectorAll('#comp-body tr').forEach(r => {
            let inps = r.querySelectorAll('input');
            if(inps[2].value || inps[3].value) { 
                let imgTag = r.querySelector('img');
                let imgData = imgTag ? imgTag.src : "";
                comps.push({
                    iconaBase64: imgData,
                    fornitore: inps[1].value, matricola: inps[2].value, disegno: inps[3].value,
                    qta: inps[4].value, denominazione: inps[5].value, materiale: inps[6].value
                });
            }
        });

        let data = {
            matricola: m,
            disegno: document.getElementById('new-dis').value,
            desc: document.getElementById('new-desc').value,
            immagine: currentArtImg,
            componenti: comps
        };

        if(currentArtId) db.ref('archivio/'+currentClient+'/'+currentArtId).update(data);
        else db.ref('archivio/'+currentClient).push(data);
        chiudiModalArticolo();
    }

    window.previewArtImg = function() {
        let f = document.getElementById('upload-art-img').files[0];
        if(!f) return;
        let r = new FileReader();
        r.onload = e => { 
            currentArtImg = e.target.result; 
            document.getElementById('art-preview').src = currentArtImg;
            document.getElementById('art-preview').style.display='block';
            document.getElementById('art-placeholder').style.display='none';
        };
        r.readAsDataURL(f);
    }

    window.aggiungiRigaComp = function(data) {
        let tbody = document.getElementById('comp-body');
        let idx = tbody.children.length + 1;
        
        // Uso la stessa classe delle icone della sandbox
        let imgHtml = (data && (data.iconaBase64 || data.iconaBase)) 
            ? `<img src="${data.iconaBase64 || data.iconaBase}" class="icon-thumb-mat">` 
            : '<span style="font-size:16px; color:#555;">üì∑</span>';
        
        let row = `<tr>
            <td>${idx}</td>
            <td style="padding:5px; text-align:center;">
                <div class="icon-cell-materiale"
                     onclick="attivaIncollaRiga(this)"
                     ondblclick="this.nextElementSibling.click()"
                     ondragover="event.preventDefault(); this.style.borderColor='#00ff88';"
                     ondragleave="this.style.borderColor='#555';"
                     ondrop="gestisciDropStandardRiga(event, this)">
                    ${imgHtml}
                </div>
                <input type="file" style="display:none" accept="image/*" onchange="previewCompImg(this)">
            </td>
            <td><input type="text" value="${data?data.fornitore:''}"></td>
            <td><input type="text" value="${data?data.matricola:''}"></td>
            <td><input type="text" value="${data?data.disegno:''}"></td>
            <td><input type="number" value="${data?data.qta:''}"></td>
            <td><input type="text" value="${data?data.denominazione:''}"></td>
            <td><input type="text" value="${data?data.materiale:''}"></td>
            <td onclick="this.parentElement.remove()" style="color:red; cursor:pointer; text-align:center; font-weight:bold;">x</td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
    }

    window.previewCompImg = function(inp) {
        let f = inp.files[0];
        if(!f) return;
        
        // Invece di distruggere l'HTML, usiamo la funzione avanzata della Sandbox
        // che comprime l'immagine e la inserisce correttamente
        let divTarget = inp.previousElementSibling; 
        comprimiEIncollaInRiga(f, divTarget);
        
        inp.value = ""; // Resetta l'input per permettere di ricaricare la stessa foto se serve
    }

    // NUOVA FUNZIONE: Gestisce il trascinamento dell'immagine (Drag & Drop) nella tabella standard
    window.gestisciDropStandardRiga = function(e, divTarget) {
        e.preventDefault();
        divTarget.style.borderColor = '#555'; // Resetta il colore del bordo
        const dt = e.dataTransfer;
        if (dt.files && dt.files.length > 0) {
            // Ricicliamo il motore di compressione della Sandbox!
            comprimiEIncollaInRiga(dt.files[0], divTarget);
        }
    }

    // --- NUOVE FUNZIONI DI GESTIONE CLIENTI ---
    function openManage() {
        document.getElementById('modal-manage').style.display = 'flex';
        renderManageLists();
    }

    function renderManageLists() {
        const act = document.getElementById('list-active');
        const arch = document.getElementById('list-archive');
        act.innerHTML = ""; arch.innerHTML = "";

        allClients.forEach((c, i) => {
            let item = `<div class="manage-item"><span>${c.name}</span>`;
            if(c.active) {
                item += `<div style="display:flex; gap:5px;"><button class="btn-del" onclick="deleteClient(${i})">X</button><button class="btn-arrow" onclick="toggleClient(${i})">‚¨á</button></div></div>`;
                act.innerHTML += item;
            } else {
                item += `<div style="display:flex; gap:5px;"><button class="btn-del" onclick="deleteClient(${i})">X</button><button class="btn-arrow" onclick="toggleClient(${i})">‚¨Ü</button></div></div>`;
                arch.innerHTML += item;
            }
        });
    }

    function toggleClient(idx) {
        allClients[idx].active = !allClients[idx].active;
        localStorage.setItem('my_clients', JSON.stringify(allClients));
        renderManageLists();
        renderClientsBar();
    }

    function addClient() {
        let name = document.getElementById('new-client-name').value;
        if(name) {
            allClients.push({name: name, active: true});
            document.getElementById('new-client-name').value = "";
            localStorage.setItem('my_clients', JSON.stringify(allClients));
            renderManageLists();
            renderClientsBar();
        }
    }

    function deleteClient(idx) {
        if(confirm("Eliminare definitivamente?")) {
            allClients.splice(idx, 1);
            localStorage.setItem('my_clients', JSON.stringify(allClients));
            renderManageLists();
            renderClientsBar();
        }
    }

    // EDITOR PLACEHOLDERS
    function clickCell(td) {}
    function editCell(td) {}
    function chiudiEditor() { document.getElementById('editor-popup').style.display='none'; }
    function salvaEditor() {}






// INIZIO JAVASCRIPT --- IL JAVASCRIPT PER FAR FUNZIONAREIL BOX ARCHIVIO //
// INIZIO JAVASCRIPT --- IL JAVASCRIPT PER FAR FUNZIONAREIL BOX ARCHIVIO //
// INIZIO JAVASCRIPT --- IL JAVASCRIPT PER FAR FUNZIONAREIL BOX ARCHIVIO //
// PASSO 4 - MOTORE ARCHIVIO SANDBOX (Gestione Modale e Database)
/* --- 1. APRE LA MODALE PULITA (Prepara i campi vuoti) --- */
function apriModalSbCommessa(isEdit = false) {
    if (!isEdit) {
        // Se √® NUOVA, pulisco tutto
        currentSbEditId = null;
        document.getElementById('sb-inp-nome').value = ""; 
        document.getElementById('sb-inp-cliente').value = "";
        document.getElementById('sb-inp-data').value = new Date().toISOString().split('T')[0];
        document.getElementById('sb-inp-note').value = ""; 
        // Resetto il titolo della modale
        document.querySelector('#modal-sb-commessa .mh-order-label').innerText = "NUOVA COMMESSA";
    } else {
        // Se √® MODIFICA, cambio il titolo
        document.querySelector('#modal-sb-commessa .mh-order-label').innerText = "MODIFICA COMMESSA";
    }
    document.getElementById('modal-sb-commessa').style.display = 'flex'; 
}

/* --- 2. CHIUDE LA MODALE (Nasconde la finestra) --- */
function chiudiModalSbCommessa() {
    document.getElementById('modal-sb-commessa').style.display = 'none';
}

/* --- 3. SALVA I DATI SU FIREBASE (Crea la commessa) --- */
function salvaSbCommessa() {
    // Prendo i valori scritti dall'utente nelle caselle
    const nome = document.getElementById('sb-inp-nome').value;
    const cliente = document.getElementById('sb-inp-cliente').value;
    const stato = document.getElementById('sb-inp-stato').value;
    const data = document.getElementById('sb-inp-data').value;
    const note = document.getElementById('sb-inp-note').value;

    // Controllo di sicurezza: se non c'√® il nome, mi fermo e avviso
    if(!nome) return alert("Inserisci almeno il Nome/Numero Commessa!");

    // Creo l'oggetto "Pacchetto" da spedire al Database
    const pacchettoDati = {
        nomeOrdine: nome,       // Il nome (es. 2026/005)
        clienteFinale: cliente, // Il cliente (es. Ferrero)
        statoSandbox: stato,    // Lo stato (es. UFFICIO, IN PRODUZIONE)
        data: data,             // La data
        descrizione: note,      // Le note/fornitori
        layout: 'sandbox'       // Etichetta per dire "Questa √® roba della Sandbox"
    };

    if (currentSbEditId) {
        // --- MODALIT√Ä MODIFICA (Aggiorna esistente) ---
        db.ref('commesse/Prova 1/' + currentSbEditId).update(pacchettoDati);
    } else {
        // --- MODALIT√Ä NUOVA (Crea nuova) ---
        db.ref('commesse/Prova 1').push(pacchettoDati);
    }
    
    // Chiudo la finestra e ricarico la tabella per vedere la novit√†
    chiudiModalSbCommessa();
    caricaArchivioSandbox(); 
}







/* --- 4. LEGGE I DATI E RIEMPIE LA TABELLA (Aggiornato con il link CORRETTO al Modifica) --- */
function caricaArchivioSandbox() {
    const tbody = document.getElementById('sb-archive-table-body');
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">Caricamento...</td></tr>';

    db.ref('commesse/Prova 1').once('value', snap => {
        const data = snap.val();
        tbody.innerHTML = ""; // Pulisco
        
        if(!data) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">Nessuna commessa trovata.</td></tr>';
            return;
        }

        // Converto l'oggetto in array e lo ordino per data (dal pi√π recente)
        const elenco = Object.keys(data).reverse(); 

        elenco.forEach(id => {
            let c = data[id];
            
            // GESTIONE ICONA
            let htmlIcona = c.immagine 
                ? `<img src="${c.immagine}" style="width:35px; height:35px; object-fit:contain; border-radius:4px; border:1px solid #444; background:#000;">` 
                : `<div style="width:35px; height:35px; display:flex; align-items:center; justify-content:center; background:#222; border-radius:4px; color:#555;">üì∑</div>`;

            let riga = `
                <tr style="border-bottom:1px solid #333;">
                    <td style="text-align:center; padding:5px;">${htmlIcona}</td>

                    <td style="font-weight:bold; color:white; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${c.nomeOrdine}</td>

                    <td style="color:#ddd; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${c.clienteFinale || '-'}</td>

                    <td style="color:#aaa; font-size:12px;">${c.data || '-'}</td>

                    <td>
                        <span style="padding:3px 8px; border-radius:4px; background:#333; border:1px solid #555; font-size:11px; color:#ccc;">
                            ${c.statoSandbox || 'N.D.'}
                        </span>
                    </td>

                    <td style="font-style:italic; font-size:12px; color:#aaa; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                        ${c.descrizione ? c.descrizione : ''}
                    </td>

                    <td style="text-align:center; padding:8px;"> 
                        <div style="display:flex; justify-content:center; gap:5px;">
                            <button class="sb-action-btn sb-btn-prod" onclick="produciSandbox('${id}')">
                                <span class="sb-btn-icon">üöÄ</span> PRODUCI
                            </button>
                            
                            <button class="sb-action-btn sb-btn-edit" onclick="apriDashboardSandbox('${id}')">
                                <span class="sb-btn-icon">‚úèÔ∏è</span> MODIFICA
                            </button>
                            
                            <button class="sb-action-btn sb-btn-del" onclick="eliminaCommessaSandbox('${id}')">
                                <span class="sb-btn-icon">üóëÔ∏è</span> ELIMINA
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            tbody.innerHTML += riga;
        });
    });
}


/* --- 5. ELIMINA COMMESSA --- */
function eliminaCommessaSandbox(id) {
    if(confirm("Sei sicuro di voler eliminare questa commessa?")) {
        db.ref('commesse/Prova 1/' + id).remove(); // Cancella dal database
        caricaArchivioSandbox(); // Aggiorna la vista
    }
}






//INIZIO - Sistemiamo il Layout (Griglia 2 Colonne x 3 Righe) e implementiamo il "Super Box Immagini" (Incolla col tasto destro, Ctrl+V e Trascina). (10/02/2026)
//INIZIO - Sistemiamo il Layout (Griglia 2 Colonne x 3 Righe) e implementiamo il "Super Box Immagini" (Incolla col tasto destro, Ctrl+V e Trascina). (10/02/2026)
//INIZIO - Sistemiamo il Layout (Griglia 2 Colonne x 3 Righe) e implementiamo il "Super Box Immagini" (Incolla col tasto destro, Ctrl+V e Trascina). (10/02/2026)
// --- FUNZIONE MODIFICA DASHBOARD (VERSIONE CORRETTA DEFINITIVA) ---

// ====================================================================================
// PASSO 1: NUOVA DASHBOARD CON GESTIONE IMMAGINI AVANZATA E GRIGLIA ORDINATA
// ====================================================================================
let currentImageBase64 = null; // Variabile globale per tenere l'immagine in memoria prima di salvare

// ====================================================================================
// PASSO 2: SUPER FUNZIONE UNIFICATA (NUOVA + MODIFICA)
// ====================================================================================

// ====================================================================================
// PASSO 1: NUOVA DASHBOARD MASTER-DETAIL (SIDEBAR + AREA DI LAVORO)
// ====================================================================================

let currentCommessaId = null; // ID della commessa aperta
let currentDisegnoId = null;  // ID del disegno selezionato (o 'main' per la generale)
let datiCommessaGlobal = {};  // Contenitore di tutti i dati per lavorare in memoria

function apriDashboardSandbox(id = null) {
    currentCommessaId = id;
    currentDisegnoId = 'main'; // Di default apro la schermata principale
    currentImageBase64 = null;

    // A. CARICAMENTO DATI
    let caricamento;
    if (id) {
        caricamento = db.ref('commesse/Prova 1/' + id).once('value').then(snap => snap.val());
    } else {
        // Struttura dati vuota per nuova commessa
        caricamento = Promise.resolve({
            nomeOrdine: "",
            clienteFinale: "",
            data: new Date().toISOString().split('T')[0],
            statoSandbox: "UFFICIO",
            disegni: {} // Qui ci saranno i figli (SAL02525, SAL02744...)
        });
    }

    // B. COSTRUZIONE INTERFACCIA
    caricamento.then(dati => {
        datiCommessaGlobal = dati || {};
        if(!datiCommessaGlobal.disegni) datiCommessaGlobal.disegni = {};

        // 1. Costruisco il Guscio HTML (Layout a 2 Colonne)
        let modalContent = `
            <div style="display:flex; flex-direction:column; height:100%; color:white; font-family:'Segoe UI', sans-serif;">
                
                <div style="background:#1a1a1a; padding:15px 20px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; height:50px;">
                    <div style="font-size:18px; font-weight:bold; color:#9b59b6;">
                        ${datiCommessaGlobal.nomeOrdine ? datiCommessaGlobal.nomeOrdine : 'NUOVA COMMESSA'} 
                        <span style="font-size:12px; color:#666; margin-left:10px;">(MASTER VIEW)</span>
                    </div>




                    <div>
                        <button onclick="salvaTutto()" style="background:#27ae60; color:white; border:none; padding:8px 20px; border-radius:4px; font-weight:bold; cursor:pointer; margin-right:10px;">SALVA TUTTO</button>
                        <button onclick="apriModalQR()" style="background:#3498db; color:white; border:none; padding:8px 20px; border-radius:4px; font-weight:bold; cursor:pointer; margin-right:10px;">üî≤ STAMPA QR</button>
                        <button onclick="chiudiDashboard()" style="background:transparent; border:1px solid #444; color:#888; padding:8px 15px; border-radius:4px; cursor:pointer;">CHIUDI</button>
                    </div>





                </div>







                <div style="display:flex; flex:1; overflow:hidden;">
                    
                    <div style="width:240px; background:#111; border-right:1px solid #333; display:flex; flex-direction:column;">
                        <div style="padding:15px; border-bottom:1px solid #222; font-size:11px; color:#555; font-weight:bold; letter-spacing:1px;">STRUTTURA COMMESSA</div>
                        
                        <div id="sidebar-list" style="flex:1; overflow-y:auto; padding:10px;">
                            </div>

                        <div style="padding:10px; border-top:1px solid #222;">
                            <button onclick="aggiungiNuovoDisegno()" style="width:100%; padding:10px; background:rgba(255,255,255,0.05); border:1px dashed #444; color:#888; cursor:pointer; font-size:12px; transition:0.2s;">+ AGGIUNGI DISEGNO</button>
                        </div>
                        <div onclick="cambiaVista('riepilogo')" id="btn-riepilogo" style="padding:15px; background:#2a1a35; border-top:1px solid #9b59b6; color:white; text-align:center; font-weight:bold; cursor:pointer; font-size:13px;">
                            üìä RIEPILOGO TOTALE
                        </div>
                    </div>

                    <div id="main-area" style="flex:1; background:#181818; padding:20px; overflow-y:auto; position:relative;">
                        </div>

                </div>
            </div>
        `;

        // Inietto l'HTML
        const container = document.getElementById('modal-dashboard-container');
        if(container) {
            container.innerHTML = modalContent; 
            document.getElementById('modal-dashboard-overlay').style.display = 'flex'; 
            
            // Renderizzo la sidebar e apro la vista principale
            renderSidebar();
            cambiaVista('main'); 
        }
    });
}

// ====================================================================================
// FUNZIONI DI NAVIGAZIONE E RENDER (IL "MOTORE" VISIVO)
// ====================================================================================

// 1. Disegna la Sidebar a sinistra
function renderSidebar() {
    const list = document.getElementById('sidebar-list');
    list.innerHTML = "";

    // Tasto "HOME / DATI GENERALI"
    list.innerHTML += `
        <div onclick="cambiaVista('main')" class="drawing-btn ${currentDisegnoId === 'main' ? 'active' : ''}" 
             style="padding:10px; margin-bottom:5px; border-radius:4px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; 
             background:${currentDisegnoId === 'main' ? 'rgba(155,89,182,0.2)' : 'transparent'}; 
             color:${currentDisegnoId === 'main' ? '#9b59b6' : '#ccc'}; border:1px solid ${currentDisegnoId === 'main' ? '#9b59b6' : 'transparent'};">
            <span>üè† Dati Generali</span>
        </div>
    `;

    // Elenco Disegni (Figli)
    Object.keys(datiCommessaGlobal.disegni).forEach(key => {
        let dis = datiCommessaGlobal.disegni[key];
        list.innerHTML += `
            <div onclick="cambiaVista('${key}')" class="drawing-btn ${currentDisegnoId === key ? 'active' : ''}" 
                 style="padding:10px; margin-bottom:5px; border-radius:4px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; 
                 background:${currentDisegnoId === key ? 'rgba(155,89,182,0.2)' : 'transparent'}; 
                 color:${currentDisegnoId === key ? '#9b59b6' : '#ccc'}; border:1px solid ${currentDisegnoId === key ? '#9b59b6' : 'transparent'};">
                <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${dis.nome || 'Senza Nome'}</span>
                <span style="font-size:10px; opacity:0.5;">üìÑ</span>
            </div>
        `;
    });
}

// 2. Crea un Nuovo Disegno Vuoto
function aggiungiNuovoDisegno() {
    const idTemp = 'dis_' + Date.now(); // Genero un ID unico temporaneo
    datiCommessaGlobal.disegni[idTemp] = {
        nome: "NUOVO DISEGNO",
        descrizione: "",
        materiali: [],
        immagine: null
    };
    renderSidebar(); // Ridisegno la sidebar per mostrare il nuovo bottone
    cambiaVista(idTemp); // Vado subito al nuovo disegno
}


// 3. Cambia Vista (CON SALVATAGGIO AUTOMATICO TEMPORANEO)
function cambiaVista(targetId) {
    // A. PRIMA DI CAMBIARE: Salvo i dati della vista che sto lasciando!
    if (currentDisegnoId && currentDisegnoId !== 'main' && currentDisegnoId !== 'riepilogo' && currentDisegnoId !== targetId) {
        salvaDatiVistaCorrente();
    }

    // B. CAMBIO IL TARGET
    currentDisegnoId = targetId;
    renderSidebar(); // Aggiorno colori sidebar

    const area = document.getElementById('main-area');
    
    // Recupero immagine corretta
    let imgAttuale = "";
    if(targetId === 'main') {
        imgAttuale = datiCommessaGlobal.immagine;
    } else if(targetId !== 'riepilogo' && datiCommessaGlobal.disegni[targetId]) {
        imgAttuale = datiCommessaGlobal.disegni[targetId].immagine;
    }

    // HTML Box Foto (Standard)
    const htmlBoxFoto = `
        <div id="drop-area" tabindex="0" style="width: 250px; height: 200px; background: #000; border: 2px dashed #555; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-direction: column; cursor: pointer; position: relative; overflow: hidden; transition: all 0.2s;"
             onclick="document.getElementById('fileElem').click()" onpaste="gestisciIncolla(event)" ondragover="event.preventDefault(); this.style.borderColor='#00ff88';" ondragleave="this.style.borderColor='#555';" ondrop="gestisciDrop(event)">
            <input type="file" id="fileElem" accept="image/*" style="display:none" onchange="gestisciFile(this.files)">
            <img id="anteprima-img" src="${imgAttuale || ''}" style="max-width:100%; max-height:100%; display:${imgAttuale ? 'block' : 'none'}; object-fit:contain; z-index:1;">
            <div id="placeholder-text" style="text-align:center; color:#666; font-size:11px; position:absolute; z-index:0; display:${imgAttuale ? 'none' : 'block'};">
                <span style="font-size:24px; display:block; margin-bottom:5px;">üì∑</span>CLICCA, TRASCINA<br>O <b>CTRL+V</b>
            </div>
        </div>`;
    
    // C. RENDERIZZO LA NUOVA VISTA
    // --- VISTA MAIN (AGGIORNATA: CON TABELLA RIEPILOGO MATERIALI) ---
    if (targetId === 'main') {
        area.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:15px; margin-bottom:20px;">
                <h3 style="color:#9b59b6; margin:0; text-transform:uppercase; letter-spacing:1px;">DATI GENERALI COMMESSA</h3>
                <div style="display:flex; align-items:center; gap:10px;">
                    <label style="color:#888; font-size:12px; font-weight:bold;">STATO ATTUALE:</label>
                    <select onchange="datiCommessaGlobal.statoSandbox = this.value" 
                        style="padding:8px 15px; background:#111; border:1px solid #9b59b6; color:white; font-weight:bold; border-radius:4px; cursor:pointer; outline:none;">
                        <option value="UFFICIO" ${datiCommessaGlobal.statoSandbox === 'UFFICIO' ? 'selected' : ''}>UFFICIO</option>
                        <option value="MAGAZZINO" ${datiCommessaGlobal.statoSandbox === 'MAGAZZINO' ? 'selected' : ''}>MAGAZZINO</option>
                        <option value="IN PRODUZIONE" ${datiCommessaGlobal.statoSandbox === 'IN PRODUZIONE' ? 'selected' : ''}>IN PRODUZIONE</option>
                        <option value="PRONTI" ${datiCommessaGlobal.statoSandbox === 'PRONTI' ? 'selected' : ''}>PRONTI</option>
                        <option value="VERNICIATURA" ${datiCommessaGlobal.statoSandbox === 'VERNICIATURA' ? 'selected' : ''}>VERNICIATURA</option>
                        <option value="FINITI" ${datiCommessaGlobal.statoSandbox === 'FINITI' ? 'selected' : ''}>FINITI</option>
                    </select>
                </div>
            </div>
            
            <div style="display:flex; gap:20px;">
                <div style="flex-shrink:0;">${htmlBoxFoto}</div>

                <div style="flex:1; display:flex; flex-direction:column; gap:10px;">
                    
                    <div style="display:flex; gap:15px;">
                        <div style="flex:1;"><label style="color:#888; font-size:11px;">CENTRALE</label><input type="text" class="input-dark" value="${datiCommessaGlobal.centrale || ''}" oninput="datiCommessaGlobal.centrale = this.value" style="width:100%;"></div>
                        <div style="flex:1;"><label style="color:#888; font-size:11px;">CLIENTE</label><input type="text" class="input-dark" value="${datiCommessaGlobal.clienteFinale || ''}" oninput="datiCommessaGlobal.clienteFinale = this.value" style="width:100%;"></div>
                    </div>

                    <div><label style="color:#888; font-size:11px;">N¬∞ COMMESSA</label><input type="text" class="input-dark" value="${datiCommessaGlobal.nomeOrdine || ''}" oninput="datiCommessaGlobal.nomeOrdine = this.value; document.querySelector('.mh-order-label').innerText = this.value + ' (MASTER)'; renderSidebar();" style="width:100%; font-weight:bold;"></div>

                    <div style="display:flex; gap:15px;">
                        <div style="flex:1;"><label style="color:#888; font-size:11px;">QUANTIT√Ä</label><input type="text" class="input-dark" value="${datiCommessaGlobal.qtaTotale || ''}" oninput="datiCommessaGlobal.qtaTotale = this.value" style="width:100%;"></div>
                        <div style="flex:1;"><label style="color:#888; font-size:11px;">PESO KG</label><input type="text" class="input-dark" value="${datiCommessaGlobal.peso || ''}" oninput="datiCommessaGlobal.peso = this.value" style="width:100%;"></div>
                    </div>

                    <div>
                        <label style="color:#888; font-size:11px;">NOTE GENERALI</label>
                        <textarea class="input-dark" oninput="datiCommessaGlobal.note = this.value" style="width:100%; height:60px; resize:none;">${datiCommessaGlobal.note || ''}</textarea>
                    </div>

                </div>
            </div>

            <div style="margin-top:20px;">
                <div style="display:flex; justify-content:space-between; align-items:end; margin-bottom:5px;">
                <label style="color:#00ff88; font-size:12px; font-weight:bold; letter-spacing:1px;">ANTEPRIMA MATERIALI & STATO AVANZAMENTO</label>
                
                <div style="display:flex; gap:10px;"> <button onclick="apriComparatore()" style="background:#3498db; color:white; border:none; padding:5px 15px; border-radius:4px; font-weight:bold; font-size:11px; cursor:pointer;">
                        ‚öñÔ∏è CONFRONTA PREZZI
                    </button>
                    
                    <button onclick="apriCarrelloRichiesta()" style="background:#f1c40f; color:black; border:none; padding:5px 15px; border-radius:4px; font-weight:bold; font-size:11px; cursor:pointer;">
                        üõí CREA RICHIESTA PREVENTIVO
                    </button>
                </div>
            </div>
                <div class="preview-table-container">
                    ${generaAnteprimaMaterialiHTML()}
                </div>
            </div>
        `;
    

} else if (targetId === 'riepilogo') {
        // --- VISTA RIEPILOGO TOTALE ---
        
        // 1. Calcolo l'elenco dei fornitori presenti per creare i bottoni
        let tuttiMateriali = [];
        let fornitoriSet = new Set();
        
        Object.values(datiCommessaGlobal.disegni).forEach(d => {
            if(d.materiali) {
                d.materiali.forEach(m => {
                    tuttiMateriali.push({...m, disegnoRif: d.nome}); // Aggiungo il rif. del disegno
                    if(m.fornitore) fornitoriSet.add(m.fornitore.toUpperCase().trim());
                });
            }
        });
        
        // Creo l'HTML dei bottoni fornitore
        let htmlFiltri = `<button class="filter-btn active" onclick="filtraRiepilogo('TUTTI', this)">TUTTI</button>`;
        fornitoriSet.forEach(f => {
            if(f) htmlFiltri += `<button class="filter-btn" onclick="filtraRiepilogo('${f}', this)">${f}</button>`;
        });

        area.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:10px;">
                <h3 style="color:#9b59b6; margin:0;">üìä RIEPILOGO TOTALE COMMESSA</h3>
                <button onclick="stampaPDF()" style="background:#e74c3c; color:white; border:none; padding:8px 15px; border-radius:4px; font-weight:bold; cursor:pointer;">üìÑ STAMPA ORDINE PDF</button>
            </div>

            <div class="filter-bar-container" style="margin-top:20px; border-top:none; background:#111; border-bottom:2px solid #9b59b6;">
                <span style="color:#666; font-size:11px; margin-right:10px; text-transform:uppercase; font-weight:bold;">Filtra per Fornitore:</span>
                ${htmlFiltri}
            </div>

            <div id="print-area" style="margin-top:0px; flex:1; overflow:hidden; background:#181818;">
                <div style="overflow-x:auto; height:100%;">
                    <table style="min-width:1400px; width:100%; text-align:left; border-collapse:collapse; font-size:12px;">
                        <thead style="background:#222; color:#ccc; position:sticky; top:0;">
                            <tr>
                                <th style="padding:8px; width:120px; color:#9b59b6;">RIF. DISEGNO</th> <th style="padding:8px; width:100px;">Fornitore</th>
                                <th style="padding:8px; width:40px;">#</th>
                                <th style="padding:8px; width:150px;">Tipologia</th>
                                <th style="padding:8px; width:100px;">Dim.</th>
                                <th style="padding:8px; width:60px;">Spess.</th>
                                <th style="padding:8px; width:60px;">Lungh.</th>
                                <th style="padding:8px; width:50px; color:#00ff88;">Qta</th>
                                <th style="padding:8px; width:100px;">Materiale</th>
                                <th style="padding:8px; width:60px;">Kg</th>
                                <th style="padding:8px; width:150px;">Tipo Scant.</th>
                                <th style="padding:8px; width:100px;">Scant.</th>
                                <th style="padding:8px; width:80px;">Fori</th>
                            </tr>
                        </thead>
                        <tbody id="tb-riepilogo-body">
                            ${generareRigheRiepilogo(tuttiMateriali)}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    
   } else {
        // --- VISTA DISEGNO SPECIFICO (CON TABELLA E BOTTONE EXCEL!) ---
        let dis = datiCommessaGlobal.disegni[targetId];
        area.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #444; padding-bottom:10px;">
                <h3 style="color:#00ff88; margin:0;">DISEGNO: ${dis.nome}</h3>
                <button onclick="eliminaDisegno('${targetId}')" style="color:#e74c3c; background:none; border:1px solid #e74c3c; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:11px;">ELIMINA DISEGNO</button>
            </div>

            <div style="display:flex; gap:20px; margin-top:20px;">
                <div style="flex-shrink:0;">${htmlBoxFoto}</div>
                <div style="flex:1; display:flex; flex-direction:column; gap:10px;">
                    <div><label style="color:#888; font-size:11px;">NOME DISEGNO</label><input type="text" value="${dis.nome}" oninput="datiCommessaGlobal.disegni['${targetId}'].nome = this.value; renderSidebar();" style="width:100%; padding:10px; background:#222; border:1px solid #444; color:white; font-weight:bold;"></div>
                    <div><label style="color:#888; font-size:11px;">DESCRIZIONE / NOTE</label><textarea oninput="datiCommessaGlobal.disegni['${targetId}'].descrizione = this.value" style="width:100%; height:100px; background:#222; border:1px solid #444; color:white; padding:10px; resize:none;">${dis.descrizione || ''}</textarea></div>
                </div>
            </div>

            <div style="margin-top:20px; flex:1; display:flex; flex-direction:column;">
                <div style="display:flex; justify-content:space-between; align-items:end; margin-bottom:5px;">
                    <label style="color:#00d26a; font-size:12px; font-weight:bold;">DISTINTA TECNICA COMPLETA</label>
                    <div style="display:flex; gap:10px;">
                        <button onclick="aggiungiRigaMateriale()" style="background:#444; color:white; border:1px solid #666; font-size:11px; padding:4px 12px; cursor:pointer;">+ AGGIUNGI RIGA</button>
                        <input type="file" id="excel-upload" accept=".xlsx, .xls, .csv" style="display:none;" onchange="leggiExcel(this)">
                        <button onclick="document.getElementById('excel-upload').click()" style="background:#27ae60; color:white; border:none; font-size:11px; padding:4px 12px; cursor:pointer; font-weight:bold; border-radius:4px;">+ IMPORTA EXCEL</button>
                    </div>
                </div>
                
                <div style="background:#111; border:1px solid #333; border-radius:6px; overflow-x:auto; overflow-y:visible;">
                    <table style="min-width:1400px; width:100%; text-align:left; border-collapse:collapse; font-size:12px;">
                        <thead style="background:#222; color:#ccc;">
                            <tr>
                                <th style="padding:8px; width:50px; text-align:center;">ICON</th> 
                                <th style="padding:8px; width:120px;">Fornitore</th>
                                <th style="padding:8px; width:40px;">#</th>
                                <th style="padding:8px; width:150px;">Tipologia</th>
                                <th style="padding:8px; width:100px;">Dim.</th>
                                <th style="padding:8px; width:60px;">Spess.</th>
                                <th style="padding:8px; width:60px;">Lungh.</th>
                                <th style="padding:8px; width:50px; color:#00ff88;">Qta</th>
                                <th style="padding:8px; width:100px;">Materiale</th>
                                <th style="padding:8px; width:60px;">Kg</th>
                                <th style="padding:8px; width:150px;">Tipo Scant.</th>
                                <th style="padding:8px; width:100px;">Scant.</th>
                                <th style="padding:8px; width:80px;">Fori</th>
                                <th style="padding:8px; width:30px;"></th>
                            </tr>
                        </thead>
                        <tbody id="tb-disegno-body">
                            ${getTabellaMaterialiHTML(dis.materiali || [])}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
} // <--- QUESTA E' LA PARENTESI CHE MANCAVA (Chiude la funzione cambiaVista)



// --- Genera l'HTML delle righe (VERSIONE PULITA) ---
function getTabellaMaterialiHTML(materiali) {
    if (!materiali || materiali.length === 0) return '';
    
    return materiali.map(function(m, index) {
        // Controllo se c'√® l'icona
        var iconHtml = '';
        if (m.icona) {
            iconHtml = '<img src="' + m.icona + '" class="icon-thumb-mat">';
        } else {
            iconHtml = '<span style="font-size:16px; color:#555;">üì∑</span>';
        }

        return `
        <tr class="riga-materiale-dinamica" style="border-bottom:1px solid #222;">
            <td style="padding:5px; text-align:center;">
                <div class="icon-cell-materiale" onclick="attivaIncollaRiga(this)">
                    ${iconHtml}
                </div>
                <input type="hidden" class="inp-icona" value="${m.icona || ''}">
            </td>

            <td style="padding:0;"><input type="text" value="${m.fornitore || ''}" class="inp-fornitore" style="width:100%; background:transparent; border:none; color:#00d26a; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" value="${m.pos || ''}" class="inp-pos" style="width:100%; background:transparent; border:none; color:#aaa; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" value="${m.tipologia || ''}" class="inp-tipologia" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" value="${m.dim || ''}" class="inp-dim" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" value="${m.spessore || ''}" class="inp-spessore" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" value="${m.lunghezza || ''}" class="inp-lunghezza" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" value="${m.qta || ''}" class="inp-qta" style="width:100%; background:transparent; border:none; color:#fff; font-weight:bold; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" value="${m.materiale || ''}" class="inp-materiale" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" value="${m.kg || ''}" class="inp-kg" style="width:100%; background:transparent; border:none; color:#888; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" value="${m.tipoScant || ''}" class="inp-tipoScant" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" value="${m.scant || ''}" class="inp-scant" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" value="${m.fori || ''}" class="inp-fori" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="text-align:center; color:red; cursor:pointer;" onclick="this.parentElement.remove()">√ó</td>
        </tr>`;
    }).join('');
}


// 4. Salva Tutto su Firebase
function salvaTutto() {
    // 1. Salva i dati della vista aperta in questo momento!
    if (currentDisegnoId !== 'main' && currentDisegnoId !== 'riepilogo') {
        salvaDatiVistaCorrente();
    }

    if(!datiCommessaGlobal.nomeOrdine) return alert("Inserisci almeno il nome della commessa!");
    
    // ... resto del codice uguale a prima ...
    // Se √® nuova
    if (!currentCommessaId) {
        db.ref('commesse/Prova 1').push(datiCommessaGlobal).then(() => {
            alert("Salvata!");
            chiudiDashboard();
            caricaArchivioSandbox();
        });
    } else {
        // Se √® modifica
        db.ref('commesse/Prova 1/' + currentCommessaId).update(datiCommessaGlobal).then(() => {
            alert("Aggiornata!");
            chiudiDashboard();
            caricaArchivioSandbox();
        });
    }
}

// 5. Elimina un disegno dalla lista (in memoria)
function eliminaDisegno(id) {
    if(confirm("Eliminare questo disegno?")) {
        delete datiCommessaGlobal.disegni[id];
        cambiaVista('main');
    }
}


// --- FUNZIONE PER AGGIUNGERE UNA RIGA VUOTA ---
function aggiungiRigaManuale() {
    const tbody = document.getElementById('tb-materiali-body');
    // Se c'√® la riga "Nessun materiale", la togliamo
    if(tbody.innerHTML.includes('Nessun materiale')) tbody.innerHTML = "";

    const nuovaRiga = `
        <tr class="riga-dati" style="border-bottom:1px solid #222; background:rgba(255,255,255,0.05);">
            <td style="padding:0;"><input type="text" placeholder="Fornitore..." style="width:100%; background:transparent; border:none; color:#00d26a; padding:8px; outline:none;"></td>
            <td style="padding:0;"><input type="text" placeholder="Descrizione..." style="width:100%; background:transparent; border:none; color:#ddd; padding:8px; outline:none;"></td>
            <td style="padding:0;"><input type="text" placeholder="Qta" style="width:100%; background:transparent; border:none; color:#fff; padding:8px; outline:none; font-weight:bold;"></td>
            <td style="text-align:center; color:red; cursor:pointer; font-weight:bold;" onclick="this.parentElement.remove()">√ó</td>
        </tr>
    `;
    tbody.insertAdjacentHTML('beforeend', nuovaRiga);
}

// =========================================================
// MOTORE GESTIONE IMMAGINI (COMPRESSIONE + PASTE + DROP)
// =========================================================

function gestisciIncolla(e) {
    // Gestisce il CTRL+V
    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
    for (const item of items) {
        if (item.type.indexOf("image") === 0) {
            const blob = item.getAsFile();
            comprimiEVisualizza(blob);
        }
    }
}

function gestisciDrop(e) {
    // Gestisce il trascinamento file
    e.preventDefault();
    document.getElementById('drop-area').style.borderColor = '#555';
    const dt = e.dataTransfer;
    const files = dt.files;
    gestisciFile(files);
}

function gestisciFile(files) {
    if(files.length > 0) {
        comprimiEVisualizza(files[0]);
    }
}

// Funzione che processa l'immagine e la salva NELLA MEMORIA GIUSTA
function comprimiEVisualizza(file) {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = event => {
        const img = new Image();
        img.src = event.target.result;
        img.onload = () => {
            const elem = document.createElement('canvas');
            const scaleFactor = 800 / Math.max(img.width, img.height);
            const finalScale = scaleFactor < 1 ? scaleFactor : 1;
            
            elem.width = img.width * finalScale;
            elem.height = img.height * finalScale;
            
            const ctx = elem.getContext('2d');
            ctx.drawImage(img, 0, 0, elem.width, elem.height);
            
            const dataUrl = elem.toDataURL('image/jpeg', 0.7);
            
            // 1. Aggiorno l'anteprima a video
            const imgTag = document.getElementById('anteprima-img');
            const placeTag = document.getElementById('placeholder-text');
            if(imgTag) { imgTag.src = dataUrl; imgTag.style.display = 'block'; }
            if(placeTag) { placeTag.style.display = 'none'; }
            
            // 2. SALVO NEL POSTO GIUSTO IN MEMORIA (Main o Disegno)
            if (currentDisegnoId === 'main') {
                datiCommessaGlobal.immagine = dataUrl; // Salvo nell'assieme
            } else if (datiCommessaGlobal.disegni[currentDisegnoId]) {
                datiCommessaGlobal.disegni[currentDisegnoId].immagine = dataUrl; // Salvo nel disegno specifico
            }
        }
    }
}

// =========================================================
// FUNZIONE SALVATAGGIO (Aggiornata per leggere la tabella)
// =========================================================
// =========================================================
// FUNZIONE SALVATAGGIO UNIFICATA (CREA + MODIFICA)
// =========================================================
function salvaModificheSandbox(id) {
    // 1. Raccogliamo i dati della tabella
    let materialiSalvabili = [];
    const righe = document.querySelectorAll('#tb-materiali-body tr');
    
    righe.forEach(riga => {
        const inputs = riga.querySelectorAll('input');
        if(inputs.length >= 3 && inputs[0].value) { // Salvo solo se c'√® almeno il fornitore
            materialiSalvabili.push({
                fornitore: inputs[0].value,
                descrizione: inputs[1].value,
                qta: inputs[2].value
            });
        }
    });

    // 2. Prepariamo il pacchetto
    const datiForm = {
        nomeOrdine: document.getElementById('edit-nome').value,
        qtaTotale: document.getElementById('edit-qta').value,
        disegno: document.getElementById('edit-disegno').value,
        peso: document.getElementById('edit-peso').value,
        descrizione: document.getElementById('edit-desc').value,
        note: document.getElementById('edit-note').value,
        data: document.getElementById('edit-data').value || new Date().toISOString().split('T')[0],
        immagine: currentImageBase64,
        materiali: materialiSalvabili,
        layout: 'sandbox' // Importante per filtrarlo
    };

    if (id && id !== "null" && id !== "") {
        // --- MODIFICA ESISTENTE ---
        db.ref('commesse/Prova 1/' + id).update(datiForm)
        .then(() => {
            alert("Commessa aggiornata!");
            chiudiDashboard();
            caricaArchivioSandbox(); 
        });
    } else {
        // --- CREA NUOVA ---
        // Se √® nuova, aggiungo lo stato di default
        datiForm.statoSandbox = "UFFICIO"; 
        
        db.ref('commesse/Prova 1').push(datiForm)
        .then(() => {
            alert("Nuova commessa creata!");
            chiudiDashboard();
            caricaArchivioSandbox(); 
        });
    }
}
//FINE - Sistemiamo il Layout (Griglia 2 Colonne x 3 Righe) e implementiamo il "Super Box Immagini" (Incolla col tasto destro, Ctrl+V e Trascina). (10/02/2026)
//FINE - Sistemiamo il Layout (Griglia 2 Colonne x 3 Righe) e implementiamo il "Super Box Immagini" (Incolla col tasto destro, Ctrl+V e Trascina). (10/02/2026)
//FINE - Sistemiamo il Layout (Griglia 2 Colonne x 3 Righe) e implementiamo il "Super Box Immagini" (Incolla col tasto destro, Ctrl+V e Trascina). (10/02/2026)






// INIZIO - La funzione modificaSandbox crea la finestra con i bottoni, e filtraTabella gestisce quei bottoni. √à buona norma tenere il codice che "disegna" vicino al codice che "fa funzionare". (10/02/2026) 19:32
// INIZIO - La funzione modificaSandbox crea la finestra con i bottoni, e filtraTabella gestisce quei bottoni. √à buona norma tenere il codice che "disegna" vicino al codice che "fa funzionare". (10/02/2026) 19:32
// INIZIO - La funzione modificaSandbox crea la finestra con i bottoni, e filtraTabella gestisce quei bottoni. √à buona norma tenere il codice che "disegna" vicino al codice che "fa funzionare". (10/02/2026) 19:32
// --- FUNZIONE FILTRO TABELLA (LOGICA BOTTONI VERDI) ---
function filtraTabella(filtro, btn) {
    // 1. GESTIONE GRAFICA: Accendi il bottone cliccato, spegni gli altri
    // Cerco tutti i bottoni filtro dentro la modale attiva
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    // Aggiungo la classe 'active' (verde) solo a quello cliccato
    btn.classList.add('active');

    // 2. GESTIONE RIGHE: Mostra/Nascondi in base al fornitore
    const righe = document.querySelectorAll('.riga-materiale'); // Prendo tutte le righe della tabella materiali

    righe.forEach(riga => {
        // Leggo il fornitore salvato nell'attributo data-fornitore della riga
        const fornitoreRiga = riga.getAttribute('data-fornitore');

        // Se il filtro √® 'TUTTI' oppure il fornitore corrisponde -> MOSTRA
        if (filtro === 'TUTTI' || fornitoreRiga === filtro) {
            riga.style.display = 'table-row';
        } else {
            // Altrimenti -> NASCONDI
            riga.style.display = 'none';
        }
    });
}
// FINE - La funzione modificaSandbox crea la finestra con i bottoni, e filtraTabella gestisce quei bottoni. √à buona norma tenere il codice che "disegna" vicino al codice che "fa funzionare". (10/02/2026) 19:32
// FINE - La funzione modificaSandbox crea la finestra con i bottoni, e filtraTabella gestisce quei bottoni. √à buona norma tenere il codice che "disegna" vicino al codice che "fa funzionare". (10/02/2026) 19:32
// FINE - La funzione modificaSandbox crea la finestra con i bottoni, e filtraTabella gestisce quei bottoni. √à buona norma tenere il codice che "disegna" vicino al codice che "fa funzionare". (10/02/2026) 19:32











// --- FUNZIONE PRODUCI: Sposta in Kanban ---
function produciSandbox(id) {
    if(confirm("Vuoi lanciare questa commessa in produzione?")) {
        // 1. Aggiorno lo stato a "UFFICIO" (o quello che preferisci come partenza)
        db.ref('commesse/Prova 1/' + id).update({ statoSandbox: 'UFFICIO' });
        
        // 2. Porto l'utente alla schermata "LAVORI"
        switchSandboxTab('lavori');
        
        // 3. Avviso (Per ora, nel prossimo step collegheremo la Kanban vera!)
        alert("Commessa lanciata! (Nel prossimo passaggio collegheremo la Kanban per vederla apparire nelle colonne)");
    }
}

// FINE JAVASCRIPT --- IL JAVASCRIPT PER FAR FUNZIONAREIL BOX ARCHIVIO //
// FINE JAVASCRIPT --- IL JAVASCRIPT PER FAR FUNZIONAREIL BOX ARCHIVIO //
// FINE JAVASCRIPT --- IL JAVASCRIPT PER FAR FUNZIONAREIL BOX ARCHIVIO //



// --- FUNZIONE MANCANTE PER CHIUDERE LA FINESTRA ---
function chiudiDashboard() {
    document.getElementById('modal-dashboard-overlay').style.display = 'none';
}

// --- Genera l'HTML delle righe (VERSIONE CORRETTA) ---
function getTabellaMaterialiHTML(materiali) {
    if (!materiali || materiali.length === 0) return '';
    
    return materiali.map(function(m, index) {
        // Controllo icona
        var contenutoIcona = m.icona 
            ? '<img src="' + m.icona + '" class="icon-thumb-mat">' 
            : '<span style="font-size:16px; color:#555;">üì∑</span>';

        return `
        <tr class="riga-materiale-dinamica" style="border-bottom:1px solid #222;">
            <td style="padding:5px; text-align:center;">
                <div class="icon-cell-materiale" onclick="attivaIncollaRiga(this)">
                    ${contenutoIcona}
                </div>
                <input type="hidden" class="inp-icona" value="${m.icona || ''}">
            </td>

            <td style="padding:0;"><input type="text" value="${m.fornitore || ''}" class="inp-fornitore" style="width:100%; background:transparent; border:none; color:#00d26a; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" value="${m.pos || ''}" class="inp-pos" style="width:100%; background:transparent; border:none; color:#aaa; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" value="${m.tipologia || ''}" class="inp-tipologia" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" value="${m.dim || ''}" class="inp-dim" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" value="${m.spessore || ''}" class="inp-spessore" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" value="${m.lunghezza || ''}" class="inp-lunghezza" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" value="${m.qta || ''}" class="inp-qta" style="width:100%; background:transparent; border:none; color:#fff; font-weight:bold; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" value="${m.materiale || ''}" class="inp-materiale" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" value="${m.kg || ''}" class="inp-kg" style="width:100%; background:transparent; border:none; color:#888; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" value="${m.tipoScant || ''}" class="inp-tipoScant" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" value="${m.scant || ''}" class="inp-scant" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" value="${m.fori || ''}" class="inp-fori" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="text-align:center; color:red; cursor:pointer;" onclick="this.parentElement.remove()">√ó</td>
        </tr>`;
    }).join('');
}

// --- Aggiunge una riga vuota (VERSIONE 12 COLONNE) ---
function aggiungiRigaMateriale() {
    const tbody = document.getElementById('tb-disegno-body');
    // Genero un ID univoco temporaneo per la cella (basato sul tempo) per evitare conflitti
    const tempIndex = Date.now(); 

    const nuovaRiga = `
        <tr class="riga-materiale-dinamica" style="border-bottom:1px solid #222; background:rgba(255,255,255,0.05);">
            <td style="padding:5px; text-align:center;">
                <div class="icon-cell-materiale" onclick="attivaIncollaRiga(this)">
                    <span style="font-size:16px; color:#555;">üì∑</span>
                </div>
                <input type="hidden" class="inp-icona" value="">
            </td>

            <td style="padding:0;"><input type="text" placeholder="Forn..." class="inp-fornitore" style="width:100%; background:transparent; border:none; color:#00d26a; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" class="inp-pos" style="width:100%; background:transparent; border:none; color:#aaa; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" placeholder="Tipologia" class="inp-tipologia" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" class="inp-dim" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" class="inp-spessore" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" class="inp-lunghezza" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" placeholder="1" class="inp-qta" style="width:100%; background:transparent; border:none; color:#fff; font-weight:bold; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" class="inp-materiale" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" class="inp-kg" style="width:100%; background:transparent; border:none; color:#888; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" class="inp-tipoScant" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" class="inp-scant" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="padding:0;"><input type="text" class="inp-fori" style="width:100%; background:transparent; border:none; color:#ddd; padding:5px; outline:none;"></td>
            <td style="text-align:center; color:red; cursor:pointer;" onclick="this.parentElement.remove()">√ó</td>
        </tr>
    `;
    tbody.insertAdjacentHTML('beforeend', nuovaRiga);
}

// --- SALVATAGGIO TEMPORANEO (Mentre navighi) ---
function salvaDatiVistaCorrente() {
    if(!currentDisegnoId || currentDisegnoId === 'main') return;

    const righe = document.querySelectorAll('.riga-materiale-dinamica');
    let nuoviMateriali = [];

    righe.forEach(r => {
        let obj = {
            // *** NUOVO CAMPO ICONA ***
            icona: r.querySelector('.inp-icona').value, 
            
            fornitore: r.querySelector('.inp-fornitore').value,
            pos: r.querySelector('.inp-pos').value,
            tipologia: r.querySelector('.inp-tipologia').value,
            dim: r.querySelector('.inp-dim').value,
            spessore: r.querySelector('.inp-spessore').value,
            lunghezza: r.querySelector('.inp-lunghezza').value,
            qta: r.querySelector('.inp-qta').value,
            materiale: r.querySelector('.inp-materiale').value,
            kg: r.querySelector('.inp-kg').value,
            tipoScant: r.querySelector('.inp-tipoScant').value,
            scant: r.querySelector('.inp-scant').value,
            fori: r.querySelector('.inp-fori').value
        };

        if(obj.tipologia || obj.fornitore) {
            nuoviMateriali.push(obj);
        }
    });

    if(datiCommessaGlobal.disegni[currentDisegnoId]) {
        datiCommessaGlobal.disegni[currentDisegnoId].materiali = nuoviMateriali;
    }
}

// --- SALVATAGGIO ANCHE NELLA FUNZIONE "salvaModificheSandbox" (Se la usi ancora) ---
// Nota: Se stai usando la nuova "apriDashboardSandbox", questa parte √® gestita da "salvaTutto" che 
// chiama internamente "salvaDatiVistaCorrente", quindi sei gi√† a posto!






// ====================================================================================
// PASSO 3: SEGUGIO 2.0 (IMPORTAZIONE FILE TECNICO CON FORNITORE)
// ====================================================================================

function leggiExcel(input) {
    if (!input.files || input.files.length === 0) return;
    if (currentDisegnoId === 'main' || currentDisegnoId === 'riepilogo') {
        alert("Seleziona prima un disegno specifico (es. Scudo) dalla colonna sinistra per importare la sua distinta.");
        input.value = ""; 
        return;
    }

    const file = input.files[0];
    const reader = new FileReader();

    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        
        // Prendo il primo foglio
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        // Converto in matrice (array di array) con header:1 per avere le righe grezze
        const righeExcel = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

        elaboraDatiExcel(righeExcel);
        input.value = ""; // Reset
    };

    reader.readAsArrayBuffer(file);
}



function elaboraDatiExcel(righe) {
    // 1. CERCO L'INTESTAZIONE
    let rigaHeader = -1;
    for (let i = 0; i < Math.min(righe.length, 30); i++) {
        const rigaStr = righe[i].map(x => String(x).toLowerCase().trim());
        if (rigaStr[0] === "fornitore" || (rigaStr.includes("tipologia") && rigaStr.includes("quantita"))) {
            rigaHeader = i;
            break;
        }
    }

    if (rigaHeader === -1) {
        alert("ERRORE: Non trovo la riga di intestazione 'Fornitore'. Usa il file Master corretto.");
        return;
    }

    // 2. ESTRAZIONE DATI
    let nuoviMateriali = [];
    
    for (let i = rigaHeader + 1; i < righe.length; i++) {
        const r = righe[i];
        if (!r || r.length < 5) continue; // Salta righe troppo corte

        // MAPPATURA ESATTA DEL TUO MASTER FILE:
        // A=0: Fornitore, B=1: #, C=2: Tipologia, D=3: Dim, E=4: Spessore(Label) -> F=5: Spessore(Val)
        // I=8: Lunghezza(Label) -> J=9: Lunghezza(Val), K=10: N¬∞, L=11: Qta
        // M=12: Materiale, N=13: Kg, O=14: Tipo Scant, Q=16: Scant, R=17: Fori
        
        let qta = r[11]; // Colonna L
        if(!qta && r[10] && !isNaN(r[10])) qta = r[10]; // Fallback se spostato
        
        // Se non c'√® la tipologia, probabilmente √® una riga vuota o spuria
        if(!r[2]) continue;

        nuoviMateriali.push({
            fornitore: r[0],
            pos: r[1],
            tipologia: r[2],
            dim: r[3],
            spessore: r[5],  // Prendo il valore (col F), saltando "x Sp."
            lunghezza: r[9], // Prendo il valore (col J), saltando "x L="
            qta: qta,
            materiale: r[12],
            kg: r[13],
            tipoScant: r[14],
            scant: r[16],
            fori: r[17]
        });
    }

    // 3. AGGIUNGO AI DATI ESISTENTI
    if (!datiCommessaGlobal.disegni[currentDisegnoId].materiali) {
        datiCommessaGlobal.disegni[currentDisegnoId].materiali = [];
    }
    
    datiCommessaGlobal.disegni[currentDisegnoId].materiali = [
        ...datiCommessaGlobal.disegni[currentDisegnoId].materiali, 
        ...nuoviMateriali
    ];

    cambiaVista(currentDisegnoId);
    alert(`Importate ${nuoviMateriali.length} righe!`);
}



// =========================================================
// FUNZIONI RIEPILOGO E FILTRI
// =========================================================

// 1. Genera HTML Tabella Riepilogo (CON INDICATORE "ORDINATO")
function generareRigheRiepilogo(listaMateriali) {
    if(!listaMateriali || listaMateriali.length === 0) return '<tr><td colspan="13" style="padding:20px; text-align:center; color:#555;">Nessun materiale inserito nei disegni.</td></tr>';
    
    return listaMateriali.map(m => {
        // Controllo se √® gi√† stato ordinato
        const isOrdinato = m.statoOrdine === 'ORDINATO';
        const bgStyle = isOrdinato ? 'background:rgba(39, 174, 96, 0.15); border-left: 3px solid #27ae60;' : 'border-bottom:1px solid #333;';
        const checkIcon = isOrdinato ? '‚úÖ' : '';

        return `
        <tr class="riga-riepilogo" data-fornitore="${(m.fornitore||'').toUpperCase().trim()}" style="${bgStyle} color:#ccc;">
            <td style="padding:8px; color:#9b59b6; font-weight:bold;">${m.disegnoRif}</td>
            <td style="padding:8px; color:${isOrdinato ? '#27ae60' : '#00d26a'}; font-weight:bold;">${m.fornitore || '-'} ${checkIcon}</td>
            <td style="padding:8px;">${m.pos || ''}</td>
            <td style="padding:8px;">${m.tipologia || ''}</td>
            <td style="padding:8px;">${m.dim || ''}</td>
            <td style="padding:8px;">${m.spessore || ''}</td>
            <td style="padding:8px;">${m.lunghezza || ''}</td>
            <td style="padding:8px; color:white; font-weight:bold;">${m.qta || ''}</td>
            <td style="padding:8px;">${m.materiale || ''}</td>
            <td style="padding:8px;">${m.kg || ''}</td>
            <td style="padding:8px;">${m.tipoScant || ''}</td>
            <td style="padding:8px;">${m.scant || ''}</td>
            <td style="padding:8px;">${m.fori || ''}</td>
        </tr>
        `;
    }).join('');
}

// 2. Filtra la tabella Riepilogo
function filtraRiepilogo(filtro, btn) {
    // Gestione Grafica Bottoni
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');

    // Gestione Visibilit√† Righe
    const righe = document.querySelectorAll('.riga-riepilogo');
    righe.forEach(r => {
        const fornitoreRiga = r.getAttribute('data-fornitore');
        if (filtro === 'TUTTI' || fornitoreRiga === filtro) {
            r.style.display = 'table-row';
        } else {
            r.style.display = 'none';
        }
    });
}

// 3. GENERA ORDINE FORNITORE (PDF + SALVATAGGIO STATO)
function stampaPDF() {
    // 1. Controllo: Devo aver selezionato un fornitore specifico!
    const btnAttivo = document.querySelector('.filter-btn.active');
    const fornitoreSelezionato = btnAttivo ? btnAttivo.innerText : 'TUTTI';

    if (fornitoreSelezionato === 'TUTTI') {
        alert("‚ö†Ô∏è ATTENZIONE: Seleziona un Fornitore specifico (es. TOMATIS) prima di stampare l'ordine.");
        return;
    }

    if (!confirm(`Vuoi generare l'ordine PDF per ${fornitoreSelezionato} e segnare i materiali come ORDINATI?`)) {
        return;
    }

    // 2. Preparo l'area di stampa (Aggiungo un'intestazione al volo)
    const elemento = document.getElementById('print-area');
    const originaleHTML = elemento.innerHTML; // Salvo com'√® adesso

    // Aggiungo un'intestazione per il PDF
    const dataOggi = new Date().toLocaleDateString();
    const headerPDF = `
        <div style="padding:20px; background:white; color:black; margin-bottom:10px;">
            <h1 style="margin:0;">ORDINE MATERIALE: ${fornitoreSelezionato}</h1>
            <h3 style="margin:5px 0 0 0;">Commessa: ${datiCommessaGlobal.nomeOrdine} - Data: ${dataOggi}</h3>
            <p>Si prega di confermare ricezione e data di consegna.</p>
        </div>
    `;
    
    // Inietto temporaneamente l'intestazione bianca (brutto trucco ma funziona)
    // Nota: html2pdf user√† lo sfondo che trova.
    
    const opt = {
        margin:       5,
        filename:     `Ordine_${fornitoreSelezionato}_${datiCommessaGlobal.nomeOrdine}.pdf`,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2, backgroundColor: "#ffffff" }, // Sfondo bianco per risparmiare inchiostro
        jsPDF:        { unit: 'mm', format: 'a3', orientation: 'landscape' }
    };

    // 3. Genero il PDF
    html2pdf().set(opt).from(elemento).save().then(() => {
        // 4. QUANDO HA FINITO DI SCARICARE -> SALVO "ORDINATO" NEL DB
        marcaComeOrdinato(fornitoreSelezionato);
    });
}

// Funzione ausiliaria che segna i pezzi come ordinati nel database
function marcaComeOrdinato(fornitoreTarget) {
    let modificheFatte = false;

    // Giro su tutti i disegni
    Object.keys(datiCommessaGlobal.disegni).forEach(disKey => {
        let disegno = datiCommessaGlobal.disegni[disKey];
        if(disegno.materiali) {
            disegno.materiali.forEach(m => {
                // Se il materiale √® di questo fornitore (e non √® gi√† ordinato)
                if (m.fornitore && m.fornitore.toUpperCase().trim() === fornitoreTarget) {
                    m.statoOrdine = 'ORDINATO'; // <--- ECCO LA MODIFICA
                    modificheFatte = true;
                }
            });
        }
    });

    if (modificheFatte) {
        // Salvo su Firebase senza chiudere la dashboard
        db.ref('commesse/Prova 1/' + currentCommessaId).update(datiCommessaGlobal).then(() => {
            // Ricarico la vista Riepilogo per vedere le righe verdi
            cambiaVista('riepilogo');
            // Rimetto il filtro sul fornitore giusto
            setTimeout(() => {
                const btn = Array.from(document.querySelectorAll('.filter-btn')).find(b => b.innerText === fornitoreTarget);
                if(btn) filtraRiepilogo(fornitoreTarget, btn);
            }, 500);
            
            alert(`‚úÖ Ordine inviato! I materiali di ${fornitoreTarget} sono ora segnati in VERDE.`);
        });
    } else {
        alert("Non c'erano materiali nuovi da ordinare per questo fornitore.");
    }
}




// =========================================================
// MOTORE KANBAN SANDBOX (CON IMMAGINE E CENTRALE)
// =========================================================

function caricaKanbanSandbox() {
    // 1. Definisco l'ordine esatto delle colonne
    const statiSequenza = ["UFFICIO", "MAGAZZINO", "IN PRODUZIONE", "PRONTI", "VERNICIATURA", "FINITI", "ARCHIVIO"];

    // 2. Pulisco le colonne
    for(let i=0; i<7; i++) {
        const col = document.getElementById(`sb-col-${i}`);
        if(col) col.innerHTML = "";
    }

    // 3. Leggo i dati
    db.ref('commesse/Prova 1').once('value', snap => {
        const data = snap.val();
        if(!data) return;

        Object.keys(data).forEach(id => {
            const c = data[id];
            
            // Trovo l'indice numerico dello stato attuale
            let colIndex = statiSequenza.indexOf(c.statoSandbox);
            if(colIndex === -1) colIndex = 0;

            // --- CALCOLO BARRA % ---
            let totRighe = 0;
            let totOrdinati = 0;
            if(c.disegni) {
                Object.values(c.disegni).forEach(dis => {
                    if(dis.materiali) {
                        dis.materiali.forEach(m => {
                            totRighe++;
                            if(m.statoOrdine === 'ORDINATO') totOrdinati++;
                        });
                    }
                });
            }
            let perc = totRighe > 0 ? Math.round((totOrdinati / totRighe) * 100) : 0;
            let coloreBarra = perc === 100 ? '#00ff88' : '#f1c40f'; 

            // --- COSTRUZIONE BOTTONI FRECCIA ---
            let btnPrev = colIndex > 0 
                ? `<button onclick="spostaCardSandbox('${id}', ${colIndex - 1}, event)" style="cursor:pointer; background:none; border:1px solid #555; color:#888; border-radius:4px; padding:2px 8px;">‚óÄ</button>` 
                : `<div style="width:25px;"></div>`; 

            let btnNext = colIndex < 6 
                ? `<button onclick="spostaCardSandbox('${id}', ${colIndex + 1}, event)" style="cursor:pointer; background:none; border:1px solid #555; color:#00ff88; border-radius:4px; padding:2px 8px;">‚ñ∂</button>` 
                : `<div style="width:25px;"></div>`;

            // --- NUOVA LOGICA VISIVA (FOTO + CENTRALE) ---
            
            // 1. Immagine di Copertina (Se esiste)
            let htmlImmagine = c.immagine
                ? `<div style="width:100%; height:120px; background-image:url('${c.immagine}'); background-size:cover; background-position:center; border-radius:4px; margin-bottom:10px; border:1px solid #333;"></div>`
                : ``; // Se non c'√® foto, non metto nulla per risparmiare spazio

            // 2. Titolo (Uso la CENTRALE se c'√®, altrimenti il NOME ORDINE)
            let titoloCard = c.centrale ? c.centrale : c.nomeOrdine;
            
            // 3. Sottotitolo (Se ho usato la Centrale come titolo, mostro qui la commessa)
            let sottoTitolo = c.centrale ? `<div style="color:#9b59b6; font-weight:bold; margin-bottom:3px;">${c.nomeOrdine}</div>` : '';

            // 4. DISEGNO LA CARD
            const card = document.createElement('div');
            card.className = 'sandbox-card';
            // Aumento l'altezza minima della card via stile inline se c'√® l'immagine, per farla stare comoda
            if(c.immagine) card.style.height = "auto"; 
            
            card.onclick = () => apriDashboardProduzione(id); 

            card.innerHTML = `
                ${htmlImmagine}

                <div class="sb-card-head">
                    <span class="sb-card-title" style="font-size:15px; color:#fff; text-transform:uppercase;">${titoloCard}</span>
                    <span class="sb-card-badge" style="border:1px solid ${coloreBarra}; color:${coloreBarra}; font-weight:bold; font-size:10px;">
                        ${perc}%
                    </span>
                </div>
                
                <div class="sb-card-body" style="font-size:11px; color:#aaa; display:flex; flex-direction:column; gap:2px; flex:1;">
                    ${sottoTitolo}
                    
                    <div><strong style="color:#ddd;">CLI:</strong> ${c.clienteFinale || '-'}</div>
                    
                    <div style="width:100%; height:4px; background:#333; border-radius:2px; margin-top:8px; overflow:hidden;">
                        <div style="width:${perc}%; height:100%; background:${coloreBarra}; transition:width 0.5s;"></div>
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; padding-top:8px; border-top:1px solid #333;">
                    ${btnPrev}
                    <span style="font-size:10px; color:#555;">SPOSTA</span>
                    ${btnNext}
                </div>
            `;

            const colonnaDestinazione = document.getElementById(`sb-col-${colIndex}`);
            if(colonnaDestinazione) colonnaDestinazione.appendChild(card);
        });
    });
}





// =========================================================
// DASHBOARD DI PRODUZIONE (CON FILTRI FORNITORE PER DISEGNO)
// =========================================================
function apriDashboardProduzione(id) {
    try {
        db.ref('commesse/Prova 1/' + id).once('value')
        .then(snap => {
            const c = snap.val();
            
            // SE LA COMMESSA NON ESISTE O L'ID E' SBAGLIATO
            if (!c) {
                alert("‚ùå ERRORE: Nessun dato trovato per la commessa ID: " + id);
                document.getElementById('placeholder').innerHTML = "<h2 style='color:red;'>‚ùå Commessa non trovata nel database!</h2>";
                return;
            }

            // Tutto ok: nascondo la scritta "Caricamento in corso..."
            document.getElementById('placeholder').style.display = 'none';

            let htmlDisegni = "";
            
            if(c.disegni) {
                Object.keys(c.disegni).forEach(k => {
                    let d = c.disegni[k];
                    let p = (c.produzione && c.produzione[k]) ? c.produzione[k] : {};
                    
                    let fornitoriSet = new Set();
                    if(d.materiali) {
                        d.materiali.forEach(m => {
                            if(m.fornitore) fornitoriSet.add(m.fornitore.toUpperCase().trim());
                        });
                    }

                    let htmlFiltri = `<button class="filter-mini-btn active" onclick="filtraDisegno(this, 'TUTTI')">TUTTI</button>`;
                    fornitoriSet.forEach(f => {
                        htmlFiltri += `<button class="filter-mini-btn" onclick="filtraDisegno(this, '${f}')">${f}</button>`;
                    });

                    let tabellaMaterialiHTML = generaTabellaProduzione(d.materiali || [], id, k);

                    htmlDisegni += `
                        <div style="background:#222; border:1px solid #333; border-radius:8px; margin-bottom:20px; overflow:hidden;">
                            <div style="padding:15px; background:#2a2a2a; border-bottom:1px solid #444; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                                <div style="display:flex; align-items:center; gap:15px;">
                                    ${d.immagine ? `<img src="${d.immagine}" style="width:50px; height:50px; object-fit:contain; background:black; border:1px solid #555; border-radius:4px;">` : ''}
                                    <div>
                                        <div style="color:#00e5ff; font-weight:bold; font-size:16px;">${d.nome}</div>
                                        <div style="color:#aaa; font-size:12px;">${d.descrizione || ''}</div>
                                    </div>
                                </div>
                                <div style="display:flex; gap:5px; overflow-x:auto; max-width:400px; padding-bottom:2px;">
                                    ${htmlFiltri}
                                </div>
                                <div style="display:flex; gap:15px; align-items:center;">
                                    <label style="color:#ccc; font-size:11px; display:flex; align-items:center; gap:5px; cursor:pointer; background:#111; padding:4px 8px; border-radius:4px; border:1px solid #444;">
                                        <input type="checkbox" ${p.taglio ? 'checked' : ''} onchange="aggiornaFase('${id}', '${k}', 'taglio', this.checked)"> TAGLIO
                                    </label>
                                    <label style="color:#ccc; font-size:11px; display:flex; align-items:center; gap:5px; cursor:pointer; background:#111; padding:4px 8px; border-radius:4px; border:1px solid #444;">
                                        <input type="checkbox" ${p.saldatura ? 'checked' : ''} onchange="aggiornaFase('${id}', '${k}', 'saldatura', this.checked)"> SALD.
                                    </label>
                                    <label style="color:#ccc; font-size:11px; display:flex; align-items:center; gap:5px; cursor:pointer; background:#111; padding:4px 8px; border-radius:4px; border:1px solid #444;">
                                        <input type="checkbox" ${p.verniciatura ? 'checked' : ''} onchange="aggiornaFase('${id}', '${k}', 'verniciatura', this.checked)"> VERN.
                                    </label>
                                </div>
                            </div>
                            <div style="overflow-x:auto; padding:0;">
                                ${tabellaMaterialiHTML}
                            </div>
                        </div>
                    `;
                });
            }

            let modalContent = `
                <div style="padding:20px; color:white; font-family:'Segoe UI'; height:100%; display:flex; flex-direction:column;">
                    <div style="border-bottom:1px solid #444; padding-bottom:15px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h2 style="margin:0; color:#00ff88;">GESTIONE MATERIALI & PRODUZIONE</h2>
                            <span style="color:#888; font-size:14px;">Commessa: <b style="color:white;">${c.nomeOrdine || 'N.D.'}</b></span>
                        </div>
                        <button onclick="chiudiDashboard()" style="background:none; border:1px solid #555; color:#ccc; padding:5px 15px; border-radius:4px; cursor:pointer;">CHIUDI</button>
                    </div>
                    <div style="flex:1; overflow-y:auto; padding-right:5px;">
                        ${htmlDisegni || '<div style="text-align:center; padding:30px; color:#555;">Nessun disegno presente.</div>'}
                    </div>
                </div>
            `;

            const container = document.getElementById('modal-dashboard-container');
            if(container) {
                container.innerHTML = modalContent; 
                document.getElementById('modal-dashboard-overlay').style.display = 'flex'; 
            }
        })
        .catch(error => {
            // SE FIREBASE NON CARICA O IL WI-FI BLOCCA I DATI
            alert("‚ùå ERRORE DATABASE: Non riesco a scaricare i dati. Controlla il Wi-Fi del telefono. Errore: " + error.message);
            document.getElementById('placeholder').innerHTML = "<h3 style='color:red;'>Connessione al database fallita.</h3>";
        });
    } catch (e) {
        // SE IL CODICE JAVASCRIPT IMPAZZISCE
        alert("‚ùå ERRORE CRITICO DI SISTEMA: " + e.message);
    }
}

// Funzione per salvare le spunte (Taglio/Saldatura/Verniciatura) su Firebase
function aggiornaFase(commessaId, disegnoId, fase, valore) {
    db.ref(`commesse/Prova 1/${commessaId}/produzione/${disegnoId}/${fase}`).set(valore);
}

// Funzione per spostare la card tra le colonne della Kanban
function spostaStato(id, nuovoStato) {
    db.ref('commesse/Prova 1/' + id).update({ statoSandbox: nuovoStato });
    chiudiDashboard();
    // Aggiorno la vista Kanban per vedere la card spostarsi
    setTimeout(caricaKanbanSandbox, 300); 
}




// Funzione che disegna la tabella materiali (CON GESTIONE QUANTIT√Ä ARRIVATA, DDT E PERCENTUALE)
function generaTabellaProduzione(materiali, commessaId, disegnoId) {
    if (!materiali || materiali.length === 0) return '<div style="padding:15px; color:#666; font-size:12px; font-style:italic;">Nessun materiale in distinta.</div>';

    let righe = materiali.map((m, index) => {
        let isArrivato = m.arrivato === true ? 'checked' : '';
        let bgRow = m.arrivato === true ? 'background:rgba(39, 174, 96, 0.1);' : '';
        let colorFornitore = m.statoOrdine === 'ORDINATO' ? '#00ff88' : '#aaa';
        
        let iconHtml = m.icona 
            ? `<img src="${m.icona}" style="width:45px; height:45px; object-fit:cover; border:1px solid #444; border-radius:4px; background:black;">` 
            : `<span style="opacity:0.2; font-size:16px;">üì∑</span>`;

        let fornitoreTag = m.fornitore ? m.fornitore.toUpperCase().trim() : 'ND';

        // --- CALCOLI PERCENTUALE E ARRIVI ---
        let qTot = parseFloat(m.qta) || 1; // Quantit√† totale richiesta
        let qArr = parseFloat(m.qtaArr) || 0; // Quantit√† arrivata finora
        let ddtVal = m.ddt || ""; // Valore DDT

        // Calcolo %
        let perc = Math.min(100, Math.round((qArr / qTot) * 100));
        
        // Colore Percentuale
        let colorPerc = '#666'; // Grigio (0%)
        if(perc > 0 && perc < 100) colorPerc = '#f1c40f'; // Giallo (Parziale)
        if(perc === 100) colorPerc = '#00ff88'; // Verde (Completo)










        // ATTENZIONE!!! UTILE!!! qua sotto metto flex:1; oppure width:60px x decidere la grandezza delle colonne in festione materiale quando apro da lavori una commessa!!! qua me li posso gestire!!! 
        // ATTENZIONE!!! UTILE!!! qua sotto metto flex:1; oppure width:60px x decidere la grandezza delle colonne in festione materiale quando apro da lavori una commessa!!! qua me li posso gestire!!! 
        // ATTENZIONE!!! UTILE!!! qua sotto metto flex:1; oppure width:60px x decidere la grandezza delle colonne in festione materiale quando apro da lavori una commessa!!! qua me li posso gestire!!! 
        return `
            <tr class="riga-prod-filter" data-forn="${fornitoreTag}" style="border-bottom:1px solid #333; font-size:12px; ${bgRow}">
                <td style="padding:8px; text-align:center; border-right:1px solid #333; width:30px;">
                    <input type="checkbox" style="transform:scale(1.2); cursor:pointer;" ${isArrivato} 
                           onchange="toggleArrivoMateriale('${commessaId}', '${disegnoId}', ${index}, this.checked)">
                </td>
                
                <td style="padding:5px; text-align:center; width:50px;">${iconHtml}</td>

                <td style="padding:8px; color:${colorFornitore}; font-weight:bold;">${m.fornitore || '-'}</td>
                <td style="padding:8px; color:#888;">${m.pos || ''}</td>
                <td style="flex:1; padding:8px; color:#ddd;">${m.tipologia || ''}</td>
                <td style="flex:1; padding:8px; color:#ddd;">${m.dim || ''}</td>
                
                <td style="flex:1; padding:8px; color:white; font-weight:bold; font-size:13px; text-align:center;">${m.qta || ''}</td>

                <td style="padding:5px;">
                    <input type="number" value="${qArr > 0 ? qArr : ''}" placeholder="0"
                        onchange="salvaQtaArrSandbox('${commessaId}', '${disegnoId}', ${index}, this.value)"
                        style="flex:1; background:#111; border:1px solid #444; color:${colorPerc}; text-align:center; border-radius:4px; font-weight:bold;">
                </td>

                <td style="padding:5px;">
                    <input type="text" value="${ddtVal}" placeholder="..."
                        onchange="salvaDDTSandbox('${commessaId}', '${disegnoId}', ${index}, this.value)"
                        style="flex:1; background:#111; border:1px solid #444; color:#ccc; text-align:center; border-radius:4px;">
                </td>

                <td style="padding:8px; width:60px;">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <div style="flex:1; height:6px; background:#333; border-radius:3px; overflow:hidden;">
                            <div style="width:${perc}%; height:100%; background:${colorPerc}; transition:width 0.3s;"></div>
                        </div>
                        <span style="font-size:10px; color:${colorPerc}; font-weight:bold;">${perc}%</span>
                    </div>
                </td>

                <td style="flex:1; padding:8px; color:#ddd;">${m.materiale || ''}</td>
                <td style="flex:1; padding:8px; color:#888;">${m.kg || ''}</td>
                <td style="flex:1; padding:8px; color:#ddd;">${m.tipoScant || ''}</td>
            </tr>
        `;
    }).join('');

    return `
        <table style="width:100%; text-align:left; border-collapse:collapse; min-width:1400px;">
            <thead style="background:#1a1a1a; color:#888; font-size:11px; text-transform:uppercase;">
                <tr>
                    <th style="padding:8px; text-align:center;">OK</th> 
                    <th style="padding:8px; text-align:center;">ICON</th>
                    <th style="padding:8px;">Fornitore</th>
                    <th style="padding:8px;">#</th>
                    <th style="padding:8px;">Tipologia</th>
                    <th style="padding:8px;">Dim.</th>
                    
                    <th style="padding:8px;  color:##384147;">Q.TOT</th>
                    <th style="padding:8px;  color:##384147;">Q.ARR</th>
                    <th style="padding:8px;  color:##384147;">DDT</th>
                    <th style="padding:8px; width:80px;">% ARRIVO</th>

                    <th style="padding:8px;">Materiale</th>
                    <th style="padding:8px;">Kg</th>
                    <th style="padding:8px;">Tipo Scant.</th>
                </tr>
            </thead>
            <tbody class="tbody-prod-list">
                ${righe}
            </tbody>
        </table>
    `;
}
// ATTENZIONE!!! UTILE!!! qua sotto metto flex:1; oppure width:60px x decidere la grandezza delle colonne in festione materiale quando apro da lavori una commessa!!! qua me li posso gestire!!! 
// ATTENZIONE!!! UTILE!!! qua sotto metto flex:1; oppure width:60px x decidere la grandezza delle colonne in festione materiale quando apro da lavori una commessa!!! qua me li posso gestire!!! 
// ATTENZIONE!!! UTILE!!! qua sotto metto flex:1; oppure width:60px x decidere la grandezza delle colonne in festione materiale quando apro da lavori una commessa!!! qua me li posso gestire!!! 





// Funzione per segnare che il materiale √® arrivato fisicamente
function toggleArrivoMateriale(commessaId, disegnoId, index, isChecked) {
    // Aggiorno il campo "arrivato" (true/false) per quella specifica riga
    db.ref(`commesse/Prova 1/${commessaId}/disegni/${disegnoId}/materiali/${index}/arrivato`).set(isChecked);
    
    // NOTA: Non serve ricaricare la pagina perch√© la checkbox visiva √® gi√† cambiata.
    // Se vuoi puoi aggiungere un effetto sonoro o visivo qui.
}




// --- FUNZIONE PER SPOSTARE LA CARD CON LE FRECCE ---
function spostaCardSandbox(id, nuovoIndex, event) {
    // 1. Fermo la propagazione (altrimenti si apre la dashboard quando clicco la freccia)
    event.stopPropagation(); 

    // 2. Definisco la mappa degli stati (DEVE ESSERE UGUALE A QUELLA SOPRA)
    const statiSequenza = ["UFFICIO", "MAGAZZINO", "IN PRODUZIONE", "PRONTI", "VERNICIATURA", "FINITI", "ARCHIVIO"];
    
    // 3. Controllo limiti (sicurezza)
    if(nuovoIndex < 0 || nuovoIndex >= statiSequenza.length) return;

    // 4. Recupero il nome stringa dello stato (es. "IN PRODUZIONE")
    const nuovoStatoStringa = statiSequenza[nuovoIndex];

    // 5. Aggiorno Firebase
    db.ref('commesse/Prova 1/' + id).update({ statoSandbox: nuovoStatoStringa })
    .then(() => {
        // Ricarico la Kanban per vedere la card saltare nella nuova colonna
        caricaKanbanSandbox();
    });
}




// =========================================================
//  GESTIONE DRAG & DROP E INCOLLA (Blocco Unico Pulito)
// =========================================================

// Variabile globale per sapere DOVE incollare (null = box principale)
var targetIncollaAttivo = null;

// Listener globale per Ctrl+V
window.addEventListener('paste', function(e) {
    // Ignora se scrivo testo
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

    var items = (e.clipboardData || e.originalEvent.clipboardData).items;
    for (var i = 0; i < items.length; i++) {
        if (items[i].type.indexOf("image") === 0) {
            e.preventDefault();
            var blob = items[i].getAsFile();
            
            if (targetIncollaAttivo) {
                comprimiEIncollaInRiga(blob, targetIncollaAttivo);
            } else if(document.getElementById('drop-area')) {
                comprimiEVisualizza(blob);
            }
            return; // Fermati dopo la prima immagine
        }
    }
});

// Click fuori per deselezionare
document.addEventListener('click', function(e) {
    if (!e.target.closest('.icon-cell-materiale')) {
        var celle = document.querySelectorAll('.icon-cell-materiale');
        for(var i=0; i<celle.length; i++) celle[i].classList.remove('active-paste');
        targetIncollaAttivo = null;
    }
});

function attivaIncollaRiga(divCella) {
    // Rimuovi selezione altre celle
    var celle = document.querySelectorAll('.icon-cell-materiale');
    for(var i=0; i<celle.length; i++) celle[i].classList.remove('active-paste');
    
    // Rimuovi focus box principale
    var mainDrop = document.getElementById('drop-area');
    if(mainDrop) mainDrop.style.borderColor = '#555';

    // Attiva questa
    divCella.classList.add('active-paste');
    targetIncollaAttivo = divCella;
    
    // Ferma propagazione click
    event.stopPropagation();
}

function comprimiEIncollaInRiga(file, divTarget) {
    var reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = function(event) {
        var img = new Image();
        img.src = event.target.result;
        img.onload = function() {
            var elem = document.createElement('canvas');
            var scaleFactor = 300 / Math.max(img.width, img.height);
            var finalScale = scaleFactor < 1 ? scaleFactor : 1;
            elem.width = img.width * finalScale;
            elem.height = img.height * finalScale;
            var ctx = elem.getContext('2d');
            ctx.drawImage(img, 0, 0, elem.width, elem.height);
            
            var dataUrl = elem.toDataURL('image/jpeg', 0.6);
            
            divTarget.innerHTML = '<img src="' + dataUrl + '" class="icon-thumb-mat">';
            
            var inputHidden = divTarget.nextElementSibling;
            if(inputHidden) inputHidden.value = dataUrl;
            
            divTarget.classList.remove('active-paste');
            targetIncollaAttivo = null;
            
            salvaDatiVistaCorrente();
        }
    }
}

// Aggiungi un listener globale al click sul documento per deselezionare se clicco fuori
document.addEventListener('click', function(e) {
    if (!e.target.closest('.icon-cell-materiale')) {
        document.querySelectorAll('.icon-cell-materiale').forEach(c => c.classList.remove('active-paste'));
        targetIncollaAttivo = null;
    }
});






















// =========================================================
//  GESTIONE ANAGRAFICA FORNITORI (STEP 1)
// =========================================================

let logoFornitoreBase64 = null;

// 1. Apre la finestra e carica la lista
function apriAnagraficaFornitori() {
    document.getElementById('modal-fornitori').style.display = 'flex';
    caricaListaFornitoriSidebar();
    nuovoFornitore(); // Pulisce il form
}

// 2. Carica la lista laterale
function caricaListaFornitoriSidebar() {
    const lista = document.getElementById('lista-fornitori-sidebar');
    lista.innerHTML = "Caricamento...";
    
    db.ref('anagrafica_fornitori').once('value', snap => {
        lista.innerHTML = "";
        const data = snap.val();
        if (!data) {
            lista.innerHTML = "<div style='color:#666; font-size:12px; padding:10px;'>Nessun fornitore.</div>";
            return;
        }

        Object.keys(data).forEach(id => {
            const f = data[id];
            lista.innerHTML += `
                <div onclick="caricaDettaglioFornitore('${id}')" style="padding:10px; background:#222; border-bottom:1px solid #333; cursor:pointer; display:flex; align-items:center; gap:10px;">
                    ${f.logo ? `<img src="${f.logo}" style="width:30px; height:30px; object-fit:contain; background:white; border-radius:3px;">` : `<div style="width:30px; height:30px; background:#444; border-radius:3px;"></div>`}
                    <div style="font-weight:bold; color:white; font-size:13px;">${f.alias || f.ragioneSociale}</div>
                </div>
            `;
        });
    });
}

// 3. Prepara il form per un nuovo inserimento
function nuovoFornitore() {
    document.getElementById('forn-id').value = "";
    document.getElementById('forn-nome').value = "";
    document.getElementById('forn-alias').value = "";
    document.getElementById('forn-indirizzo').value = "";
    document.getElementById('forn-piva').value = "";
    document.getElementById('forn-email').value = "";
    document.getElementById('forn-tel').value = "";
    document.getElementById('forn-pagamento').value = "";
    document.getElementById('forn-consegna').value = "";
    
    // Reset Logo
    logoFornitoreBase64 = null;
    document.getElementById('prev-logo-forn').style.display = 'none';
    document.getElementById('place-logo-forn').style.display = 'block';
}

// 4. Carica i dettagli per modifica
function caricaDettaglioFornitore(id) {
    db.ref('anagrafica_fornitori/' + id).once('value', snap => {
        const f = snap.val();
        document.getElementById('forn-id').value = id;
        document.getElementById('forn-nome').value = f.ragioneSociale || "";
        document.getElementById('forn-alias').value = f.alias || "";
        document.getElementById('forn-indirizzo').value = f.indirizzo || "";
        document.getElementById('forn-piva').value = f.piva || "";
        document.getElementById('forn-email').value = f.email || "";
        document.getElementById('forn-tel').value = f.telefono || "";
        document.getElementById('forn-pagamento').value = f.pagamento || "";
        document.getElementById('forn-consegna').value = f.consegna || "";

        // Carica Logo
        if (f.logo) {
            logoFornitoreBase64 = f.logo;
            document.getElementById('prev-logo-forn').src = f.logo;
            document.getElementById('prev-logo-forn').style.display = 'block';
            document.getElementById('place-logo-forn').style.display = 'none';
        } else {
            logoFornitoreBase64 = null;
            document.getElementById('prev-logo-forn').style.display = 'none';
            document.getElementById('place-logo-forn').style.display = 'block';
        }
    });
}

// 5. Gestione Upload Logo Fornitore
function previewLogoFornitore(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        logoFornitoreBase64 = e.target.result;
        document.getElementById('prev-logo-forn').src = logoFornitoreBase64;
        document.getElementById('prev-logo-forn').style.display = 'block';
        document.getElementById('place-logo-forn').style.display = 'none';
    };
    reader.readAsDataURL(file);
}

// 6. Salvataggio su Firebase
function salvaFornitore() {
    const id = document.getElementById('forn-id').value;
    const dati = {
        ragioneSociale: document.getElementById('forn-nome').value,
        alias: document.getElementById('forn-alias').value, // Importante per i filtri
        indirizzo: document.getElementById('forn-indirizzo').value,
        piva: document.getElementById('forn-piva').value,
        email: document.getElementById('forn-email').value,
        telefono: document.getElementById('forn-tel').value,
        pagamento: document.getElementById('forn-pagamento').value,
        consegna: document.getElementById('forn-consegna').value,
        logo: logoFornitoreBase64
    };

    if (!dati.ragioneSociale) return alert("Inserisci almeno la Ragione Sociale!");

    if (id) {
        // Modifica
        db.ref('anagrafica_fornitori/' + id).update(dati);
    } else {
        // Nuovo
        db.ref('anagrafica_fornitori').push(dati);
    }
    
    alert("Fornitore salvato!");
    caricaListaFornitoriSidebar();
}



































// =========================================================
//  LISTENER GLOBALE PER INCOLLA (CTRL+V)
// =========================================================

// 1. Attiva l'ascolto su tutta la finestra
window.addEventListener('paste', gestisciIncolla);

// 2. Funzione Incolla "Intelligente"
function gestisciIncolla(e) {
    // A. Se l'utente sta scrivendo in un input di testo o textarea, NON intervenire!
    // (Altrimenti non potrebbe incollare testo normale)
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        return; 
    }

    // B. Cerchiamo immagini negli appunti
    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
    
    for (const item of items) {
        if (item.type.indexOf("image") === 0) {
            // √à un'immagine! Blocchiamo l'incolla standard
            e.preventDefault();
            
            const blob = item.getAsFile();
            
            // C. Decidiamo dove mandare l'immagine
            if (targetIncollaAttivo) {
                // CASO 1: Ho cliccato su una RIGA specifica -> Incolla l√¨
                comprimiEIncollaInRiga(blob, targetIncollaAttivo);
            } else {
                // CASO 2: Nessuna riga selezionata -> Incolla nel BOX FOTO PRINCIPALE
                // (Solo se il box esiste, cio√® siamo nella vista corretta)
                if(document.getElementById('drop-area')) {
                     comprimiEVisualizza(blob);
                }
            }
            break; // Abbiamo gestito l'immagine, usciamo
        }
    }
}

    
// =========================================================
//  FINE GESTIONE INCOLLA
// =========================================================





// --- FUNZIONE FILTRO SPECIFICA PER I DISEGNI (PRODUZIONE) ---
function filtraDisegno(btn, fornitoreTarget) {
    // 1. Trova il contenitore padre (la card del disegno)
    // Risaliamo fino al div principale del disegno
    const cardDisegno = btn.closest('div[style*="border-radius:8px"]'); 
    
    // 2. Gestione bottoni (Attivo/Disattivo solo dentro questo gruppo)
    const gruppoBottoni = btn.parentElement;
    gruppoBottoni.querySelectorAll('.filter-mini-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // 3. Filtra le righe della tabella SOLO di questo disegno
    const righe = cardDisegno.querySelectorAll('.riga-prod-filter');
    
    righe.forEach(r => {
        const fornitoreRiga = r.getAttribute('data-forn');
        if(fornitoreTarget === 'TUTTI' || fornitoreRiga === fornitoreTarget) {
            r.style.display = 'table-row';
        } else {
            r.style.display = 'none';
        }
    });
}






// --- SALVATAGGIO QUANTIT√Ä ARRIVATA (SANDBOX) ---
function salvaQtaArrSandbox(commessaId, disegnoId, index, valore) {
    let qtaInserita = parseFloat(valore) || 0;
    
    // Salvo il valore nel DB
    db.ref(`commesse/Prova 1/${commessaId}/disegni/${disegnoId}/materiali/${index}/qtaArr`).set(qtaInserita);

    // LOGICA EXTRA: Se la quantit√† arrivata eguaglia o supera la quantit√† totale,
    // metto automaticamente la spunta su "ARRIVATO" (checkbox a sinistra)
    db.ref(`commesse/Prova 1/${commessaId}/disegni/${disegnoId}/materiali/${index}`).once('value', snap => {
        let m = snap.val();
        let qTot = parseFloat(m.qta) || 0;
        
        if(qtaInserita >= qTot && qTot > 0) {
            // Segna come completato
            db.ref(`commesse/Prova 1/${commessaId}/disegni/${disegnoId}/materiali/${index}/arrivato`).set(true);
        } else {
            // Se diminuisco la quantit√†, tolgo la spunta
            db.ref(`commesse/Prova 1/${commessaId}/disegni/${disegnoId}/materiali/${index}/arrivato`).set(false);
        }
        
        // Ricarico la dashboard per aggiornare colori e barre
        apriDashboardProduzione(commessaId); 
    });
}

// --- SALVATAGGIO DDT (SANDBOX) ---
function salvaDDTSandbox(commessaId, disegnoId, index, valore) {
    db.ref(`commesse/Prova 1/${commessaId}/disegni/${disegnoId}/materiali/${index}/ddt`).set(valore);
}





// --- GENERATORE TABELLA ANTEPRIMA (CON CHECKBOX SELEZIONE) ---
function generaAnteprimaMaterialiHTML() {
    let righeHTML = "";
    
    if (datiCommessaGlobal.disegni) {
        Object.keys(datiCommessaGlobal.disegni).forEach(disId => {
            let disegno = datiCommessaGlobal.disegni[disId];
            
            if (disegno.materiali && disegno.materiali.length > 0) {
                
                // HEADER DEL DISEGNO
                righeHTML += `
                    <tr style="background:#2a1a35; border-top: 2px solid #9b59b6; border-bottom: 1px solid #444;">
                        <td colspan="15" style="padding:8px 10px; color:#9b59b6; font-weight:bold; letter-spacing:1px; font-size:12px; text-transform:uppercase;">
                            üìÇ RIF. DISEGNO: <span style="color:white;">${disegno.nome}</span> 
                            <span style="color:#888; font-size:11px; margin-left:10px; font-style:italic;">${disegno.descrizione || ''}</span>
                        </td>
                    </tr>
                `;

                disegno.materiali.forEach((m, index) => {
                    // Logica Semaforo Automatico
                    let statoManuale = m.statoAvanzamento || 0; 
                    let qTot = parseFloat(m.qta) || 1;
                    let qArr = parseFloat(m.qtaArr) || 0;
                    let statoFinale = (qArr >= qTot && qTot > 0) ? 3 : statoManuale;

                    let iconHtml = m.icona 
                        ? `<img src="${m.icona}" style="width:30px; height:30px; object-fit:cover; border:1px solid #444; border-radius:3px;">` 
                        : `<span style="font-size:14px; opacity:0.3;">üì∑</span>`;

                    righeHTML += `
                        <tr style="font-size:11px; border-bottom:1px solid #222;">
                            <td style="text-align:center; width:30px; background:rgba(0,0,0,0.2);">
                                <input type="checkbox" class="chk-request" value="${disId}|${index}" style="cursor:pointer; transform:scale(1.2);">
                            </td>

                            <td style="text-align:center; width:30px; vertical-align:middle;">
                                <div class="traffic-light st-${statoFinale}" 
                                     onclick="clickSemaforo('${disId}', ${index}, this, ${qArr}, ${qTot})"></div>
                            </td>
                            
                            <td style="text-align:center; width:40px; vertical-align:middle;">${iconHtml}</td>
                            <td style="color:#00e5ff; font-weight:bold;">${m.fornitore || '-'}</td>
                            <td style="color:#aaa;">${m.pos || ''}</td>
                            <td style="color:#ddd;">${m.tipologia || ''}</td>
                            <td style="color:#ddd;">${m.dim || ''}</td>
                            <td style="color:#ddd;">${m.spessore || ''}</td>
                            <td style="color:#ddd;">${m.lunghezza || ''}</td>
                            <td style="color:white; font-weight:bold; text-align:center; font-size:12px;">${m.qta || ''}</td>
                            <td style="color:#ddd;">${m.materiale || ''}</td>
                            <td style="color:#888;">${m.kg || ''}</td>
                            <td style="color:#ddd;">${m.tipoScant || ''}</td>
                            <td style="color:#ddd;">${m.scant || ''}</td>
                            <td style="color:#ddd;">${m.fori || ''}</td>
                        </tr>
                    `;
                });
            }
        });
    }

    if (righeHTML === "") return `<div style="padding:20px; text-align:center; color:#555;">Nessun materiale inserito nei disegni.</div>`;

    return `
        <table class="preview-table">
            <thead>
                <tr>
                    <th style="text-align:center; width:30px;">
                        <input type="checkbox" onclick="toggleTuttiCheckbox(this)" style="cursor:pointer; transform:scale(1.2);">
                    </th>
                    <th style="text-align:center; width:30px;">STATO</th>
                    <th style="text-align:center; width:40px;">ICON</th>
                    <th>FORNITORE</th>
                    <th style="width:30px;">#</th>
                    <th>TIPOLOGIA</th>
                    <th>DIM.</th>
                    <th>SPESS.</th>
                    <th>LUNGH.</th>
                    <th style="text-align:center;">Q.TA</th>
                    <th>MATERIALE</th>
                    <th>KG</th>
                    <th>TIPO SCANT.</th>
                    <th>SCANT.</th>
                    <th>FORI</th>
                </tr>
            </thead>
            <tbody>
                ${righeHTML}
            </tbody>
        </table>
    `;
}










// --- GESTIONE CLICK SEMAFORO (LIMITATA A 0-1-2) ---
function clickSemaforo(disegnoId, rigaIndex, divSemaforo, qArr, qTot) {
    // Se √® gi√† tutto arrivato, il semaforo √® bloccato sul verde e non fa nulla
    if (qArr >= qTot && qTot > 0) {
        alert("Questo materiale risulta ARRIVATO (100%). Modifica la quantit√† nella scheda Lavori se vuoi cambiare stato.");
        return; 
    }

    // 1. Recupero lo stato attuale
    let mat = datiCommessaGlobal.disegni[disegnoId].materiali[rigaIndex];
    let statoAttuale = mat.statoAvanzamento || 0;
    
    // 2. Calcolo il prossimo stato (Ciclo SOLO 0 -> 1 -> 2 -> 0)
    // 0: Neutro, 1: Preventivo, 2: Ordinato. 
    // Il 3 (Verde) √® riservato all'automazione.
    let nuovoStato = statoAttuale + 1;
    if (nuovoStato > 2) nuovoStato = 0; 
    
    // 3. Aggiorno la memoria globale
    mat.statoAvanzamento = nuovoStato;
    
    // 4. Aggiorno GRAFICAMENTE
    divSemaforo.className = `traffic-light st-${nuovoStato}`;
    
    // 5. Salvo su Firebase
    if (currentCommessaId) {
        db.ref(`commesse/Prova 1/${currentCommessaId}/disegni/${disegnoId}/materiali/${rigaIndex}/statoAvanzamento`).set(nuovoStato);
    }
}



















// =========================================================
//  LOGICA CARRELLO RICHIESTE (STEP 2)
// =========================================================

// Seleziona/Deseleziona tutti
function toggleTuttiCheckbox(masterChk) {
    document.querySelectorAll('.chk-request').forEach(chk => {
        chk.checked = masterChk.checked;
    });
}

// Variabile globale per memorizzare gli oggetti selezionati per la stampa
let itemsCarrelloGlobal = [];

// Apre la modale Carrello con gli elementi selezionati
function apriCarrelloRichiesta() {
    const selezionati = document.querySelectorAll('.chk-request:checked');
    
    if (selezionati.length === 0) {
        alert("Seleziona almeno una riga dalla tabella per creare una richiesta!");
        return;
    }

    // RESETTO LA VARIABILE GLOBALE
    itemsCarrelloGlobal = [];

    // 1. Pulisco e mostro la modale
    document.getElementById('modal-crea-richiesta').style.display = 'flex';
    const listaBody = document.getElementById('lista-carrello-body');
    listaBody.innerHTML = "";

    // 2. Ciclo i selezionati, li salvo in memoria e creo la lista visiva
    selezionati.forEach(chk => {
        const [disId, index] = chk.value.split('|');
        const m = datiCommessaGlobal.disegni[disId].materiali[index];
        const disNome = datiCommessaGlobal.disegni[disId].nome;

        // SALVO L'OGGETTO COMPLETO NELLA LISTA GLOBALE
        itemsCarrelloGlobal.push({
            disegno: disNome,
            ...m // Copio tutti i dati del materiale (tipologia, dim, qta...)
        });

        // Disegno la riga nel carrello (solo visiva)
        listaBody.innerHTML += `
            <div style="display:flex; justify-content:space-between; align-items:center; background:#222; border-bottom:1px solid #333; padding:10px; font-size:12px; color:#ccc;">
                <div style="flex:1;">
                    <div style="color:#9b59b6; font-size:10px; font-weight:bold;">${disNome}</div>
                    <div style="color:white; font-weight:bold;">${m.tipologia || '-'} ${m.dim || ''} ${m.spessore ? 'sp.'+m.spessore : ''}</div>
                    <div style="color:#666;">${m.lunghezza ? 'L='+m.lunghezza : ''} | ${m.materiale || ''}</div>
                </div>
                <div style="text-align:right;">
                    <div style="color:#00ff88; font-weight:bold; font-size:14px;">Qt√†: ${m.qta}</div>
                    <div style="color:#00e5ff; font-size:10px;">${m.fornitore || 'No Forn.'}</div>
                </div>
            </div>
        `;
    });

    // 3. Carico i fornitori selezionabili
    caricaFornitoriPerRichiesta();
}

// Carica i checkbox dei fornitori nell'area di destra
function caricaFornitoriPerRichiesta() {
    const box = document.getElementById('box-scelta-fornitori');
    box.innerHTML = "Caricamento...";

    db.ref('anagrafica_fornitori').once('value', snap => {
        box.innerHTML = "";
        const data = snap.val();
        if (!data) {
            box.innerHTML = "<div style='padding:10px; color:#666;'>Nessun fornitore in anagrafica.</div>";
            return;
        }

        Object.keys(data).forEach(id => {
            const f = data[id];
            box.innerHTML += `
                <label style="display:flex; align-items:center; gap:10px; padding:8px; border-bottom:1px solid #333; cursor:pointer; background:#1a1a1a;">
                    <input type="checkbox" class="chk-fornitore-richiesta" value="${id}" style="transform:scale(1.2);">
                    ${f.logo ? `<img src="${f.logo}" style="width:20px; height:20px; object-fit:contain;">` : ''}
                    <span style="color:white; font-size:13px;">${f.ragioneSociale}</span>
                </label>
            `;
        });
    });
}









// =========================================================
//  MOTORE DI STAMPA PDF (STEP 3)
// =========================================================

function generaPdfRichiesta() {
    // 1. Trovo i fornitori selezionati nel carrello
    const fornitoriSelezionati = document.querySelectorAll('.chk-fornitore-richiesta:checked');
    
    if (fornitoriSelezionati.length === 0) {
        return alert("Seleziona almeno un fornitore a cui inviare la richiesta!");
    }

    if (!confirm(`Stai per generare ${fornitoriSelezionati.length} file PDF. Procedere?`)) return;

    // 2. Ciclo sui fornitori e genero un PDF per ciascuno
    // Nota: Usiamo una funzione ricorsiva o un timeout per dare tempo al browser di scaricare
    let index = 0;
    
    function stampaProssimo() {
        if (index >= fornitoriSelezionati.length) {
            alert("Tutti i PDF sono stati generati!");
            return;
        }

        const chk = fornitoriSelezionati[index];
        const fornitoreID = chk.value;

        // Recupero i dati del fornitore dal DB (per avere indirizzo completo, ecc)
        db.ref('anagrafica_fornitori/' + fornitoreID).once('value', snap => {
            const f = snap.val();
            compilaTemplatePDF(f); // Riempio il foglio bianco
            
            // Genero il PDF
            const elemento = document.getElementById('pdf-page');
            const opt = {
                margin:       0,
                filename:     `Richiesta_${f.ragioneSociale}_${datiCommessaGlobal.nomeOrdine}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(elemento).save().then(() => {
                index++;
                setTimeout(stampaProssimo, 1000); // Aspetto 1 secondo tra un download e l'altro
            });
        });
    }

    stampaProssimo(); // Avvio il ciclo
}

// Funzione che scrive i dati dentro il "Foglio Fantasma" HTML
function compilaTemplatePDF(fornitore) {
    // Intestazione Fornitore
    document.getElementById('pdf-forn-nome').innerText = fornitore.ragioneSociale;
    document.getElementById('pdf-forn-indirizzo').innerText = fornitore.indirizzo || '';
    document.getElementById('pdf-forn-piva').innerText = fornitore.piva || '';
    // (Aggiungi citt√† se la salvi separata, o usa l'indirizzo intero)

    // Dati Documento
    document.getElementById('pdf-commessa').innerText = datiCommessaGlobal.nomeOrdine;
    document.getElementById('pdf-data').innerText = new Date().toLocaleDateString();
    document.getElementById('pdf-num').innerText = "PREV-" + Math.floor(Math.random() * 1000); // Numero provvisorio

    // Tabella Materiali
    const tbody = document.getElementById('pdf-table-body');
    tbody.innerHTML = "";

    itemsCarrelloGlobal.forEach((item, idx) => {
        // Costruisco la descrizione completa
        let desc = `<b>${item.tipologia || ''}</b> ${item.dim || ''}`;
        if(item.spessore) desc += ` sp. ${item.spessore}`;
        if(item.lunghezza) desc += ` L=${item.lunghezza}`;
        if(item.materiale) desc += ` (${item.materiale})`;

        tbody.innerHTML += `
            <tr>
                <td style="border:1px solid #000; padding:5px; text-align:center;">${item.pos || (idx+1)}</td>
                <td style="border:1px solid #000; padding:5px;">${item.disegno}</td>
                <td style="border:1px solid #000; padding:5px;">${desc}</td>
                <td style="border:1px solid #000; padding:5px; text-align:center; font-weight:bold;">${item.qta}</td>
                <td style="border:1px solid #000; padding:5px;"></td>
            </tr>
        `;
    });
}






// =========================================================
//  MOTORE COMPARATORE PREZZI (STEP 4)
// =========================================================

let fornitoriInGara = []; // Lista ID fornitori selezionati per il confronto

// 1. APRE IL COMPARATORE (Dalla selezione checkbox principale)
function apriComparatore() {
    const selezionati = document.querySelectorAll('.chk-request:checked');
    if (selezionati.length === 0) return alert("Seleziona i materiali da confrontare!");

    // Salvo gli items selezionati nella variabile globale (la stessa del PDF)
    itemsCarrelloGlobal = [];
    selezionati.forEach(chk => {
        const [disId, index] = chk.value.split('|');
        const m = datiCommessaGlobal.disegni[disId].materiali[index];
        itemsCarrelloGlobal.push({ disId, index, ...m });
    });

    // Reset e Apertura
    document.getElementById('modal-comparatore').style.display = 'flex';
    renderCheckCompetitors();
    // Di default non mostro colonne finch√© non si spuntano i fornitori
    document.getElementById('head-comparatore').innerHTML = "";
    document.getElementById('body-comparatore').innerHTML = `<div style="padding:20px; text-align:center; color:#666;">Seleziona in alto i fornitori che hanno inviato offerta.</div>`;
    document.getElementById('footer-comparatore').innerHTML = "";
}

// 2. MOSTRA I CHECKBOX DEI FORNITORI IN ALTO
function renderCheckCompetitors() {
    const box = document.getElementById('box-check-competitors');
    box.innerHTML = `<span style="color:#3498db; font-weight:bold; font-size:12px;">CHI HA RISPOSTO?</span>`;
    
    db.ref('anagrafica_fornitori').once('value', snap => {
        const data = snap.val() || {};
        Object.keys(data).forEach(id => {
            const f = data[id];
            box.innerHTML += `
                <label style="display:flex; align-items:center; gap:5px; cursor:pointer; margin-right:15px;">
                    <input type="checkbox" onchange="aggiornaGrigliaComparazione()" value="${id}" data-nome="${f.alias || f.ragioneSociale}">
                    <span style="color:white;">${f.alias || f.ragioneSociale}</span>
                </label>
            `;
        });
    });
}

// 3. DISEGNA LA GRIGLIA (COLONNE DINAMICHE)
function aggiornaGrigliaComparazione() {
    // Chi √® stato spuntato?
    const checks = document.querySelectorAll('#box-check-competitors input:checked');
    fornitoriInGara = Array.from(checks).map(c => ({ id: c.value, nome: c.getAttribute('data-nome') }));

    const thead = document.getElementById('head-comparatore');
    const tbody = document.getElementById('body-comparatore');
    const tfoot = document.getElementById('footer-comparatore');

    // COSTRUISCO HEADER
    let htmlHead = `<tr>
        <th style="padding:10px; text-align:left;">ARTICOLO</th>
        <th style="padding:10px; width:60px; text-align:center;">Q.TA</th>`;
    
    fornitoriInGara.forEach(f => {
        htmlHead += `<th style="padding:10px; width:120px; background:#222; border-left:1px solid #444; color:#3498db;">${f.nome} (‚Ç¨)</th>`;
    });
    htmlHead += `</tr>`;
    thead.innerHTML = htmlHead;

    // COSTRUISCO BODY
    let htmlBody = "";
    itemsCarrelloGlobal.forEach((item, idx) => {
        let desc = `${item.tipologia || ''} ${item.dim || ''} ${item.materiale || ''}`;
        
        htmlBody += `<tr style="border-bottom:1px solid #333;">
            <td style="padding:8px; color:#ccc;">${desc} <div style="font-size:10px; color:#666;">${item.disegnoRif || ''}</div></td>
            <td style="padding:8px; text-align:center; font-weight:bold; color:white;">${item.qta}</td>`;
        
        fornitoriInGara.forEach(f => {
            // Input prezzo univoco: id_riga + id_fornitore
            let inputId = `price_${idx}_${f.id}`;
            htmlBody += `
                <td style="padding:5px; border-left:1px solid #333; background:rgba(0,0,0,0.2);">
                    <input type="number" id="${inputId}" class="inp-price" 
                           oninput="calcolaTotaliComparatore()" 
                           placeholder="0.00" 
                           style="width:100%; background:transparent; border:1px solid #444; color:#fff; padding:5px; text-align:right;">
                </td>`;
        });
        htmlBody += `</tr>`;
    });
    tbody.innerHTML = htmlBody;

    calcolaTotaliComparatore(); // Aggiorno subito il footer (che sar√† zero)
}

// 4. CALCOLA TOTALI E MOSTRA TASTI "VINCE X"
function calcolaTotaliComparatore() {
    const tfoot = document.getElementById('footer-comparatore');
    let htmlFoot = "";
    let minTotal = Infinity;
    let totali = {};

    // Calcolo somme
    fornitoriInGara.forEach(f => {
        let tot = 0;
        itemsCarrelloGlobal.forEach((item, idx) => {
            let val = parseFloat(document.getElementById(`price_${idx}_${f.id}`).value) || 0;
            tot += val * (parseFloat(item.qta) || 1);
        });
        totali[f.id] = tot;
        if(tot > 0 && tot < minTotal) minTotal = tot;
    });

    // Genero bottoni footer
    fornitoriInGara.forEach(f => {
        let tot = totali[f.id];
        let isBest = (tot > 0 && tot === minTotal);
        let color = isBest ? '#27ae60' : '#444'; // Verde se migliore, grigio altrimenti
        
        htmlFoot += `
            <div style="text-align:right;">
                <div style="font-size:10px; color:#888;">TOTALE ${f.nome}</div>
                <div style="font-size:18px; font-weight:bold; color:${isBest ? '#00ff88' : 'white'}; margin-bottom:5px;">‚Ç¨ ${tot.toFixed(2)}</div>
                <button onclick="assegnaVincitore('${f.id}', '${f.nome}')" 
                        style="background:${color}; color:white; border:none; padding:8px 15px; cursor:pointer; border-radius:4px; font-weight:bold;">
                    ${isBest ? 'üèÜ' : ''} VINCE ${f.nome}
                </button>
            </div>
        `;
    });

    tfoot.innerHTML = htmlFoot;
}

// 5. ASSEGNAZIONE VINCITORE (Update Database)
function assegnaVincitore(idFornitore, nomeFornitore) {
    if(!confirm(`Confermi di assegnare questi materiali a ${nomeFornitore}?`)) return;

    // Ciclo sugli items e aggiorno il DB principale
    itemsCarrelloGlobal.forEach((item, idx) => {
        let prezzo = parseFloat(document.getElementById(`price_${idx}_${idFornitore}`).value) || 0;
        
        // Path esatto nel DB
        let path = `commesse/Prova 1/${currentCommessaId}/disegni/${item.disId}/materiali/${item.index}`;
        
        db.ref(path).update({
            fornitore: nomeFornitore,      // Aggiorno nome fornitore
            prezzoUnitario: prezzo,        // Salvo il prezzo
            statoOrdine: 'PREZZATO'        // Cambio stato (Pronto per ordine)
        });
    });

    alert("Assegnazione completata! I materiali sono stati aggiornati.");
    document.getElementById('modal-comparatore').style.display = 'none';
    
    // Ricarico la vista principale per vedere i cambiamenti
    cambiaVista('main'); 
}
















// =========================================================
//  MOTORE GENERAZIONE E STAMPA QR CODE
// =========================================================

function apriModalQR() {
    // 1. Controllo sicurezza: la commessa deve esistere nel database!
    if (!currentCommessaId) {
        alert("‚ö†Ô∏è Devi prima cliccare 'SALVA TUTTO' per registrare la commessa, altrimenti non posso generare un QR Code unico!");
        return;
    }

    // 2. Preparo la finestrella
    // RIGA NUOVA
    document.getElementById('qr-titolo-commessa').innerText = datiCommessaGlobal.centrale || datiCommessaGlobal.nomeOrdine || "Centrale non inserita";
    document.getElementById('modal-qr').style.display = 'flex';

    // 3. Pulisco il box da eventuali QR precedenti
    const boxQr = document.getElementById('box-qrcode');
    boxQr.innerHTML = "";

    // 4. Genero l'indirizzo magico per l'officina
    // window.location.origin + pathname prende l'URL esatto in cui ti trovi ora
    let urlCorrente = window.location.origin + window.location.pathname;
    let linkMagico = urlCorrente + "?qr=" + currentCommessaId;

    // 5. Ordino alla libreria di disegnare il QR Code
    new QRCode(boxQr, {
        text: linkMagico,
        width: 200,
        height: 200,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H // Alta correzione, cos√¨ se si sporca un po' si legge uguale
    });
}

function stampaSoloQR() {
    let contenutoQR = document.getElementById('box-qrcode').innerHTML;
    
    // USO innerHTML invece di innerText per mantenere l'a capo e la grafica!
    let nomeCommessaHTML = document.getElementById('qr-titolo-commessa').innerHTML;
    
    let finestraStampa = window.open('', '', 'height=500,width=500');
    finestraStampa.document.write('<html><head><title>Stampa Etichetta</title>');
    finestraStampa.document.write('<style>body { font-family: sans-serif; text-align: center; margin-top: 30px; }</style>');
    finestraStampa.document.write('</head><body>');
    
    // Stampo il titolo + sottotitolo stringendo un po' le righe (line-height)
    finestraStampa.document.write('<h2 style="margin-bottom:10px; line-height:1.2;">' + nomeCommessaHTML + '</h2>');
    finestraStampa.document.write(contenutoQR);
    
    // TRUCCO ANTI-BUG: Separo le parole per non far impazzire l'editor di testo!
    finestraStampa.document.write('</' + 'body></' + 'html>');
    finestraStampa.document.close();
    
    setTimeout(() => {
        finestraStampa.print();
        finestraStampa.close();
    }, 250);
}








// =========================================================
//  MOTORE LETTORE QR CODE INTERNO (FOTOCAMERA DIRETTA)
// =========================================================

let scannerLive;

function apriScanner() {
    document.getElementById('modal-scanner').style.display = 'flex';

    // Inizializzo il lettore crudo, senza bottoni extra
    scannerLive = new Html5Qrcode("qr-reader");

    // Configuro la scansione veloce
    const config = { fps: 15, qrbox: { width: 250, height: 250 } };

    // FORZO l'uso della fotocamera posteriore (environment) in modalit√† VIDEO
    scannerLive.start(
        { facingMode: "environment" }, 
        config,
        letturaRiuscita,
        letturaFallita
    ).catch(errore => {
        // Se non va, avviso l'utente
        alert("‚ö†Ô∏è Impossibile avviare la fotocamera. Assicurati di aver dato i consensi al browser quando te lo ha chiesto!");
        console.error(errore);
    });
}

function letturaRiuscita(testoLetto) {
    // 1. Spengo il video e la lucina della fotocamera
    scannerLive.stop().then(() => {
        document.getElementById('modal-scanner').style.display = 'none';

        try {
            // 2. Estraggo i parametri in modo intelligente (Non pi√π col semplice split)
            let urlObj = new URL(testoLetto);
            let idCommessa = urlObj.searchParams.get("qr");
            let nomeCliente = urlObj.searchParams.get("cliente");

            if (!idCommessa) return; // Non √® un nostro QR

            console.log("üéØ QR Letto! ID:", idCommessa, "Cliente:", nomeCliente);
            
            // 3. Passo i dati al nuovo smistatore
            gestisciAccessoDaQR(idCommessa, nomeCliente);

        } catch(e) {
            alert("Errore nella lettura del QR Code.");
        }

    }).catch(err => {
        console.error("Errore nello spegnimento fotocamera", err);
    });
}





function letturaFallita(errore) {
    // Il sistema scansiona 15 volte al secondo. 
    // Ignoriamo gli errori di "QR non trovato" altrimenti si impalla.
}

function chiudiScanner() {
    // Se l'utente clicca Annulla, fermo il video e chiudo la finestra
    if(scannerLive) {
        scannerLive.stop().then(() => {
            document.getElementById('modal-scanner').style.display = 'none';
        }).catch(() => {
            document.getElementById('modal-scanner').style.display = 'none';
        });
    } else {
        document.getElementById('modal-scanner').style.display = 'none';
    }
}







// =========================================================
//  GENERATORE QR CODE PER CLIENTI STANDARD (Tre Emme, ecc.)
// =========================================================

function apriModalQRStandard() {
    if (!currentStandardCommessaId || !currentClient) return;

    // Recupero Matricola e Quantit√† direttamente dalla schermata in alto a sinistra!
    let matricolaAttuale = document.getElementById('m-matr').innerText;
    let qtaAttuale = document.getElementById('m-qta').innerText;






    // 1. Preparo la finestrella: mostro Nome Cliente, Ordine e sotto Matricola e Qta
    // questa modifico la seconda linea il sottotilo dei clienti come tre emme scotta tomatis ecc..
    document.getElementById('qr-titolo-commessa').innerHTML = 
        currentClient + " - " + currentStandardCommessaNome + 
        "<br><span style='font-size:20px; color: #ffffff; font-weight:bold;'>Matr: " + matricolaAttuale + " | Q.t√†: " + qtaAttuale + "</span>";
    


















        
    document.getElementById('modal-qr').style.display = 'flex';

    // 2. Pulisco il box da vecchi QR
    const boxQr = document.getElementById('box-qrcode');
    boxQr.innerHTML = "";

    // 3. IL LINK MAGICO DOPPIO (qr = ID, cliente = Nome Cliente)
    let urlCorrente = window.location.origin + window.location.pathname;
    let linkMagico = urlCorrente + "?qr=" + currentStandardCommessaId + "&cliente=" + encodeURIComponent(currentClient);

    // 4. Disegno il QR
    new QRCode(boxQr, {
        text: linkMagico,
        width: 200,
        height: 200,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
    });
}























































</script>
</body>
</html>